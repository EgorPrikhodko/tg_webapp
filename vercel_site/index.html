<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TG Shop ¬∑ WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0f1a; --bg2:#0f1424; --card:#12182a; --muted:#1a2036;
      --text:#e9ecff; --subtext:#9aa3c2; --accent:#6ea8ff; --accent-2:#8b7dff;
      --ok:#2dd4bf; --warn:#ffc857; --err:#ff6b6b; --info:#67e8f9;
      --radius:16px; --radius-sm:12px; --shadow:0 12px 36px rgba(0,0,0,.45);
      --border:1px solid rgba(255,255,255,.06);
      --grad:linear-gradient(135deg, rgba(110,168,255,.20), rgba(139,125,255,.15));
      --glow:0 0 0 2px rgba(110,168,255,.25), 0 10px 30px rgba(110,168,255,.15);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:
        radial-gradient(1200px 600px at -10% -10%, rgba(139,125,255,.15), transparent 60%),
        radial-gradient(1000px 600px at 110% -10%, rgba(103,232,249,.12), transparent 60%),
        radial-gradient(1200px 800px at 50% 120%, rgba(110,168,255,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    }
    .wrap{max-width:1180px;margin:0 auto;padding:18px}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:16px;
      padding:12px;border-radius:var(--radius);background:linear-gradient(180deg, var(--bg2), rgba(18,24,42,.66));
      border:var(--border);
    }
    .brand{
      display:flex;align-items:center;gap:12px
    }
    .logo{
      width:36px;height:36px;border-radius:12px;
      background:conic-gradient(from 90deg at 50% 50%, rgba(110,168,255,.6), rgba(139,125,255,.6), rgba(110,168,255,.6));
      box-shadow:var(--glow);
    }
    h1{font-size:18px;margin:0;letter-spacing:.3px}
    .meta{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center
    }
    .pill{
      background:var(--muted);padding:8px 12px;border-radius:999px;
      color:var(--subtext);display:inline-flex;align-items:center;gap:8px;border:var(--border)
    }
    .status-dot{width:10px;height:10px;border-radius:50%;display:inline-block}
    .status-ok{background:var(--ok)} .status-warn{background:var(--warn)} .status-err{background:var(--err)}

    .api-box{display:flex;gap:8px;max-width:540px}
    .input, select, textarea{
      width:100%;background:rgba(9,13,24,.8);border:1px solid #25304a;color:var(--text);
      border-radius:12px;padding:10px 12px;outline:none;transition:.2s;
    }
    .input:focus, select:focus, textarea:focus{border-color:#3a54a8; box-shadow:0 0 0 3px rgba(62,102,255,.18)}
    textarea{min-height:88px;resize:vertical}

    .btn{
      background:linear-gradient(135deg, var(--accent), var(--accent-2));color:#fff;border:none;
      border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600;transition:.2s; box-shadow:0 6px 24px rgba(110,168,255,.25);
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.muted{background:var(--muted);color:var(--text);box-shadow:none}
    .btn.red{background:#ff5c7a}
    .btn.green{background:#18d1a6}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    nav.tabs{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 0}
    .tab-btn{background:var(--muted);color:var(--text);border:none;border-radius:12px;padding:10px 14px;cursor:pointer;transition:.2s;border:var(--border)}
    .tab-btn[aria-selected="true"]{background:var(--grad);box-shadow:var(--glow)}

    .grid{display:grid;gap:16px}
    @media(min-width:880px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:1fr 1fr 1fr}}

    .card{
      background:linear-gradient(180deg, rgba(18,24,42,.92), rgba(12,16,30,.92));
      border-radius:18px;box-shadow:var(--shadow);padding:16px;border:var(--border);position:relative;overflow:clip
    }
    .card::after{
      content:""; position:absolute; inset:0; pointer-events:none;
      background:radial-gradient(600px 180px at 20% -10%, rgba(110,168,255,.08), transparent 60%);
    }
    .card h2{margin:0 0 10px;font-size:16px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .row>*{flex:1 1 auto}
    .hint{color:var(--subtext);font-size:12px}
    .divider{height:1px;background:rgba(255,255,255,.06);margin:12px 0}

    .table-wrap{overflow:auto;border-radius:14px;border:var(--border)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06);text-align:left;vertical-align:top}
    th{color:#b9c2e0;font-weight:600;background:rgba(110,168,255,.05)}
    tr:hover td{background:rgba(139,125,255,.05)}
    .tag{background:#0f1430;border:1px solid #28306b;padding:4px 8px;border-radius:10px;color:#c5ccff;font-size:12px}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:#11162a;
      border:1px solid #253058;color:var(--text);padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:50;display:none;max-width:86%;
    }
    .toast.show{display:block;animation:pop .25s ease}
    @keyframes pop{from{transform:translateX(-50%) translateY(6px);opacity:.5} to{transform:translateX(-50%) translateY(0);opacity:1}}

    .badge-ok{background:rgba(45,212,191,.16);color:#2dd4bf}
    .empty{color:var(--subtext);font-size:13px;padding:6px 0}
    .sublabel{font-size:12px;color:var(--subtext)}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .ghost{opacity:.75}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>üõçÔ∏è TG Shop ¬∑ WebApp</h1>
          <div class="sublabel">–ú–∏–Ω–∏-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å—é</div>
        </div>
      </div>
      <div class="meta">
        <div id="pillStatus" class="pill">
          <span class="status-dot status-warn" id="dotDb"></span>
          <span id="txtDb">–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î‚Ä¶</span>
        </div>
        <div class="pill" title="ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">üë§ <span id="pillUser">‚Äî</span></div>
        <div class="pill" title="–†–µ–∂–∏–º"><span id="pillMode">–ì–æ—Å—Ç—å</span></div>
        <div class="api-box">
          <input id="apiInput" class="input" placeholder="API Base (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
          <button id="saveApiBtn" class="btn muted">Set API</button>
        </div>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab-btn" id="tab_catalog" aria-selected="true">–ö–∞—Ç–∞–ª–æ–≥</button>
      <button class="tab-btn" id="tab_admin" aria-selected="false" style="display:none">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</button>
    </nav>

    <!-- –ö–∞—Ç–∞–ª–æ–≥ -->
    <section id="view_catalog" class="grid" style="margin-top:14px">
      <div class="card">
        <div class="toolbar" style="justify-content:space-between">
          <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</h2>
          <div class="hint">–ü—É–±–ª–∏—á–Ω—ã–π GET: <span class="code tag">/api/categories</span></div>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn muted" id="btnReloadCats">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        </div>
        <div class="divider"></div>
        <div id="catsEmpty" class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π‚Ä¶</div>
        <div class="table-wrap" id="catsTableWrap" style="display:none">
          <table class="table" id="catsTable">
            <thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>Slug</th><th>Parent</th></tr></thead>
            <tbody id="catsTbody"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="toolbar" style="justify-content:space-between">
          <h2>–¢–æ–≤–∞—Ä—ã</h2>
          <div class="hint">–ü—É–±–ª–∏—á–Ω—ã–π GET: <span class="code tag">/api/products</span></div>
        </div>
        <div class="row" style="margin-top:6px">
          <input id="qSearch" class="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–æ–ø–∏—Å–∞–Ω–∏—é‚Ä¶" />
          <select id="selCatFilter" class="input"><option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option></select>
          <button class="btn muted" id="btnReloadProds">–ù–∞–π—Ç–∏</button>
        </div>
        <div class="divider"></div>
        <div id="prodsEmpty" class="empty">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç‚Ä¶</div>
        <div class="table-wrap" id="prodsTableWrap" style="display:none">
          <table class="table" id="prodsTable">
            <thead>
            <tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–í–∞–ª.</th><th>–û—Å—Ç–∞—Ç–æ–∫</th><th>–ê–∫—Ç–∏–≤–µ–Ω</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th></tr>
            </thead>
            <tbody id="prodsTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- –ê–¥–º–∏–Ω -->
    <section id="view_admin" class="grid grid-2" style="margin-top:14px;display:none">
      <div class="card">
        <h2>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬∑ CRUD</h2>
        <div class="row">
          <input id="catName" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: –û–±—É–≤—å)" />
          <input id="catSlug" class="input" placeholder="slug (–Ω–∞–ø—Ä–∏–º–µ—Ä: shoes)" />
          <input id="catParent" class="input" placeholder="parent_id (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" />
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnCreateCat" class="btn">–°–æ–∑–¥–∞—Ç—å</button>
          <button id="btnUpdateCat" class="btn green" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button id="btnCancelCat" class="btn muted" disabled>–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div class="divider"></div>
        <div id="catsEmptyA" class="empty">–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π‚Ä¶</div>
        <div class="table-wrap" id="catsTableAWrap" style="display:none">
          <table class="table" id="catsTableA">
            <thead><tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>Slug</th><th>Parent</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
            <tbody id="catsTbodyA"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h2>–¢–æ–≤–∞—Ä—ã ¬∑ CRUD</h2>
        <div class="grid">
          <div class="row">
            <input id="pTitle" class="input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–ö—Ä–æ—Å—Å–æ–≤–∫–∏)"/>
            <input id="pSlug" class="input" placeholder="slug (sneakers)"/>
          </div>
          <textarea id="pDesc" class="input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü.)"></textarea>
          <div class="row">
            <input id="pPrice" class="input" type="number" min="0" step="0.01" placeholder="–¶–µ–Ω–∞"/>
            <input id="pCurr" class="input" placeholder="–í–∞–ª—é—Ç–∞ (RUB)" value="RUB"/>
            <input id="pStock" class="input" type="number" min="0" step="1" placeholder="–û—Å—Ç–∞—Ç–æ–∫" value="0"/>
          </div>
          <div class="row">
            <select id="pCat" class="input"><option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option></select>
            <select id="pActive" class="input">
              <option value="true" selected>–ê–∫—Ç–∏–≤–µ–Ω</option>
              <option value="false">–°–∫—Ä—ã—Ç</option>
            </select>
          </div>
          <textarea id="pImages" class="input" placeholder="–°—Å—ã–ª–∫–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ)"></textarea>
          <textarea id="pAttrs" class="input" placeholder='–ê—Ç—Ä–∏–±—É—Ç—ã JSON: {"brand":"Nike","size":"42"}'></textarea>
          <div class="row">
            <button id="btnCreateProd" class="btn">–°–æ–∑–¥–∞—Ç—å</button>
            <button id="btnUpdateProd" class="btn green" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="btnCancelProd" class="btn muted" disabled>–û—Ç–º–µ–Ω–∞</button>
          </div>
        </div>
        <div class="divider"></div>
        <div id="prodsEmptyA" class="empty">–ü–æ–∫–∞ –Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤‚Ä¶</div>
        <div class="table-wrap" id="prodsTableAWrap" style="display:none">
          <table class="table" id="prodsTableA">
            <thead>
              <tr><th>ID</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–¶–µ–Ω–∞</th><th>–í–∞–ª.</th><th>–û—Å—Ç.</th><th>–ê–∫—Ç–∏–≤–µ–Ω</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr>
            </thead>
            <tbody id="prodsTbodyA"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ API base ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const url = new URL(location.href);
    const qpApi = url.searchParams.get("api");
    const API_BASE = (() => {
      if (qpApi) return qpApi.replace(/\/+$/, "");
      return "http://127.0.0.1:9010"; // dev fallback
    })();

    const els = {
      dotDb: document.getElementById("dotDb"),
      txtDb: document.getElementById("txtDb"),
      pillUser: document.getElementById("pillUser"),
      pillMode: document.getElementById("pillMode"),
      apiInput: document.getElementById("apiInput"),
      saveApiBtn: document.getElementById("saveApiBtn"),
      tabCatalog: document.getElementById("tab_catalog"),
      tabAdmin: document.getElementById("tab_admin"),
      viewCatalog: document.getElementById("view_catalog"),
      viewAdmin: document.getElementById("view_admin"),
      toast: document.getElementById("toast"),

      catsEmpty: document.getElementById("catsEmpty"),
      catsTableWrap: document.getElementById("catsTableWrap"),
      catsTbody: document.getElementById("catsTbody"),
      prodsEmpty: document.getElementById("prodsEmpty"),
      prodsTableWrap: document.getElementById("prodsTableWrap"),
      prodsTbody: document.getElementById("prodsTbody"),
      btnReloadCats: document.getElementById("btnReloadCats"),
      btnReloadProds: document.getElementById("btnReloadProds"),
      qSearch: document.getElementById("qSearch"),
      selCatFilter: document.getElementById("selCatFilter"),

      catsEmptyA: document.getElementById("catsEmptyA"),
      catsTableAWrap: document.getElementById("catsTableAWrap"),
      catsTbodyA: document.getElementById("catsTbodyA"),
      catName: document.getElementById("catName"),
      catSlug: document.getElementById("catSlug"),
      catParent: document.getElementById("catParent"),
      btnCreateCat: document.getElementById("btnCreateCat"),
      btnUpdateCat: document.getElementById("btnUpdateCat"),
      btnCancelCat: document.getElementById("btnCancelCat"),

      prodsEmptyA: document.getElementById("prodsEmptyA"),
      prodsTableAWrap: document.getElementById("prodsTableAWrap"),
      prodsTbodyA: document.getElementById("prodsTbodyA"),
      pTitle: document.getElementById("pTitle"),
      pSlug: document.getElementById("pSlug"),
      pDesc: document.getElementById("pDesc"),
      pPrice: document.getElementById("pPrice"),
      pCurr: document.getElementById("pCurr"),
      pStock: document.getElementById("pStock"),
      pCat: document.getElementById("pCat"),
      pActive: document.getElementById("pActive"),
      pImages: document.getElementById("pImages"),
      pAttrs: document.getElementById("pAttrs"),
      btnCreateProd: document.getElementById("btnCreateProd"),
      btnUpdateProd: document.getElementById("btnUpdateProd"),
      btnCancelProd: document.getElementById("btnCancelProd"),
    };

    els.apiInput.value = API_BASE;

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Telegram ID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let tgId = null;
    try {
      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe?.user?.id) {
        tgId = Telegram.WebApp.initDataUnsafe.user.id;
      }
    } catch (e) {}
    if (!tgId) {
      const stored = localStorage.getItem("debug_tg_id");
      if (stored) {
        tgId = parseInt(stored, 10);
      } else {
        const fromPrompt = prompt("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID (–¥–ª—è –∞–¥–º–∏–Ω-–¥–æ—Å—Ç—É–ø–∞). –û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –≥–æ—Å—Ç—è:", "");
        if (fromPrompt && /^\d+$/.test(fromPrompt)) {
          tgId = parseInt(fromPrompt, 10);
          localStorage.setItem("debug_tg_id", String(tgId));
        }
      }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    class ApiError extends Error{
      constructor(status, message, raw){ super(message); this.status=status; this.raw=raw; }
    }
    function headers(json = true, withTg = false) {
      const h = {};
      if (json) h["Content-Type"] = "application/json";
      if (withTg && tgId) h["X-Telegram-Id"] = String(tgId);
      return h;
    }
    function parseErrorText(text){
      if (!text) return "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞";
      try{
        const j = JSON.parse(text);
        if (j.detail){
          if (typeof j.detail === "string") return j.detail;
          if (Array.isArray(j.detail)) return j.detail.map(x=>x.msg||x.detail||JSON.stringify(x)).join("; ");
          if (j.detail.message) return j.detail.message;
        }
        if (j.message) return j.message;
        return typeof j === "string" ? j : JSON.stringify(j);
      }catch{ return text; }
    }
    async function apiGet(path, params = undefined) {
      const u = new URL(API_BASE + path);
      if (params) Object.entries(params).forEach(([k, v]) => (v ?? v === 0) && u.searchParams.set(k, v));
      const r = await fetch(u, { method: "GET" });
      const text = await r.text();
      if (!r.ok) throw new ApiError(r.status, parseErrorText(text), text);
      return text ? JSON.parse(text) : null;
    }
    async function apiSend(method, path, body = null, withTg = false) {
      const r = await fetch(API_BASE + path, {
        method, headers: headers(true, withTg), body: body ? JSON.stringify(body) : null,
      });
      const text = await r.text();
      if (!r.ok) throw new ApiError(r.status, parseErrorText(text), text);
      return text ? JSON.parse(text) : null;
    }
    function toast(msg, tone = "info") {
      els.toast.textContent = msg;
      els.toast.className = "toast show";
      els.toast.style.borderColor =
        tone === "err" ? "#ff6b6b" : tone === "ok" ? "#2dd4bf" : "#253058";
      setTimeout(() => (els.toast.className = "toast"), 2400);
    }
    function setDbStatus(ok) {
      els.dotDb.className = "status-dot " + (ok ? "status-ok" : "status-err");
      els.txtDb.textContent = ok ? "–ë–î: ok" : "–ë–î: failed";
    }
    function setUserPills({ isAdmin }) {
      els.pillUser.textContent = tgId ? String(tgId) : "‚Äî";
      els.pillMode.textContent = isAdmin ? "–ê–¥–º–∏–Ω" : "–ì–æ—Å—Ç—å";
      els.pillMode.parentElement.className = "pill " + (isAdmin ? "badge-ok" : "");
      els.tabAdmin.style.display = isAdmin ? "inline-flex" : "none";
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"'`]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])); }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function init() {
      // DB health
      let dbOk = false;
      try {
        const hdb = await apiGet("/health/db");
        dbOk = (hdb?.db === "ok") || (hdb?.status === "ok");
      } catch (e) {}
      setDbStatus(dbOk);

      // user & rights
      let isAdmin = false;
      if (tgId) {
        try {
          const u = await apiSend("POST", "/api/users/ensure", { tg_id: tgId }, true);
          isAdmin = !!u.is_admin;
        } catch (e) {
          console.warn("ensure_user failed:", e);
        }
      }
      setUserPills({ isAdmin });

      // data
      await Promise.all([refreshCategories(), refreshProducts()]);
      await refreshAdminData();

      // handlers
      bindHandlers();
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function refreshCategories() {
      const list = await apiGet("/api/categories");
      renderCats(list, els.catsTbody, els.catsTableWrap, els.catsEmpty);
      els.selCatFilter.innerHTML =
        `<option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option>` +
        list.map(c => `<option value="${c.id}">${escapeHtml(c.name)} (#${c.id})</option>`).join("");
      return list;
    }
    function renderCats(list, tbody, container, emptyEl) {
      if (!list.length) {
        container.style.display = "none"; emptyEl.style.display = "block"; tbody.innerHTML = ""; return;
      }
      container.style.display = "block"; emptyEl.style.display = "none";
      tbody.innerHTML = list.map(c => `
        <tr>
          <td>${c.id}</td>
          <td>${escapeHtml(c.name || "")}</td>
          <td><span class="tag code">${escapeHtml(c.slug)}</span></td>
          <td>${c.parent_id ?? ""}</td>
        </tr>`).join("");
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –¢–æ–≤–∞—Ä—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function refreshProducts() {
      const params = {};
      const q = els.qSearch.value.trim();
      if (q) params.q = q;
      const catId = els.selCatFilter.value.trim();
      if (catId) params.category_id = catId;
      const list = await apiGet("/api/products", params);
      renderProds(list, els.prodsTbody, els.prodsTableWrap, els.prodsEmpty);
      return list;
    }
    function renderProds(list, tbody, container, emptyEl) {
      if (!list.length) {
        container.style.display = "none"; emptyEl.style.display = "block"; tbody.innerHTML = ""; return;
      }
      container.style.display = "block"; emptyEl.style.display = "none";
      tbody.innerHTML = list.map(p => `
        <tr>
          <td>${p.id}</td>
          <td>${escapeHtml(p.title)}</td>
          <td>${Number(p.price).toFixed(2)}</td>
          <td>${escapeHtml(p.currency||"")}</td>
          <td>${p.stock ?? 0}</td>
          <td>${p.is_active ? "–î–∞" : "–ù–µ—Ç"}</td>
          <td>${p.category_id}</td>
        </tr>`).join("");
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ê–¥–º–∏–Ω ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let editingCatId = null;
    async function refreshAdminData() {
      const cats = await apiGet("/api/categories");
      renderAdminCats(cats);
      els.pCat.innerHTML =
        `<option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option>` +
        cats.map(c => `<option value="${c.id}">${escapeHtml(c.name)} (#${c.id})</option>`).join("");
      const prods = await apiGet("/api/products");
      renderAdminProds(prods);
    }
    function renderAdminCats(list) {
      if (!list.length) {
        els.catsTableAWrap.style.display = "none"; els.catsEmptyA.style.display = "block"; els.catsTbodyA.innerHTML = ""; return;
      }
      els.catsTableAWrap.style.display = "block"; els.catsEmptyA.style.display = "none";
      els.catsTbodyA.innerHTML = list.map(c => `
        <tr>
          <td>${c.id}</td>
          <td>${escapeHtml(c.name||"")}</td>
          <td><span class="tag code">${escapeHtml(c.slug)}</span></td>
          <td>${c.parent_id ?? ""}</td>
          <td class="row" style="gap:6px">
            <button class="btn muted" data-act="editCat" data-id="${c.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
            <button class="btn red" data-act="delCat" data-id="${c.id}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
          </td>
        </tr>`).join("");
      els.catsTbodyA.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = parseInt(btn.dataset.id,10);
          const act = btn.dataset.act;
          if (act==="editCat"){
            const c = list.find(x=>x.id===id); if(!c) return;
            editingCatId = id;
            els.catName.value = c.name||"";
            els.catSlug.value = c.slug||"";
            els.catParent.value = c.parent_id ?? "";
            els.btnUpdateCat.disabled = false; els.btnCancelCat.disabled = false; els.btnCreateCat.disabled = true;
          } else if (act==="delCat"){
            if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é #${id}?`)) return;
            try{
              const r = await fetch(API_BASE+`/api/categories/${id}`,{method:"DELETE",headers:headers(false,true)});
              if(!r.ok){ const t = await r.text(); throw new ApiError(r.status, parseErrorText(t), t); }
              toast("–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞","ok");
              await Promise.all([refreshAdminData(), refreshCategories()]);
            }catch(err){ toast(err.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏","err"); }
          }
        });
      });
    }
    els.btnCreateCat.addEventListener("click", async ()=>{
      const payload = {
        name: els.catName.value.trim(),
        slug: els.catSlug.value.trim(),
        parent_id: els.catParent.value.trim() ? Number(els.catParent.value.trim()) : null
      };
      if (!payload.name || !payload.slug) return toast("–£–∫–∞–∂–∏ name –∏ slug","err");
      try{
        await apiSend("POST","/api/categories",payload,true);
        toast(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞`,"ok");
        els.catName.value = els.catSlug.value = els.catParent.value = "";
        await Promise.all([refreshAdminData(), refreshCategories()]);
      }catch(err){ toast(err.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏","err"); }
    });
    els.btnUpdateCat.addEventListener("click", async ()=>{
      if (!editingCatId) return;
      const payload = {
        name: els.catName.value.trim(),
        slug: els.catSlug.value.trim(),
        parent_id: els.catParent.value.trim() ? Number(els.catParent.value.trim()) : null
      };
      try{
        await apiSend("PATCH", `/api/categories/${editingCatId}`, payload, true);
        toast(`–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞`,"ok");
        editingCatId = null;
        els.btnUpdateCat.disabled = true; els.btnCancelCat.disabled = true; els.btnCreateCat.disabled = false;
        els.catName.value = els.catSlug.value = els.catParent.value = "";
        await Promise.all([refreshAdminData(), refreshCategories()]);
      }catch(err){ toast(err.message || "–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏","err"); }
    });
    els.btnCancelCat.addEventListener("click", ()=>{
      editingCatId = null;
      els.btnUpdateCat.disabled = true; els.btnCancelCat.disabled = true; els.btnCreateCat.disabled = false;
      els.catName.value = els.catSlug.value = els.catParent.value = "";
    });

    let editingProdId = null;
    function renderAdminProds(list) {
      if (!list.length) {
        els.prodsTableAWrap.style.display = "none"; els.prodsEmptyA.style.display = "block"; els.prodsTbodyA.innerHTML = ""; return;
      }
      els.prodsTableAWrap.style.display = "block"; els.prodsEmptyA.style.display = "none";
      els.prodsTbodyA.innerHTML = list.map(p => `
        <tr>
          <td>${p.id}</td><td>${escapeHtml(p.title)}</td>
          <td>${Number(p.price).toFixed(2)}</td>
          <td>${escapeHtml(p.currency||"")}</td>
          <td>${p.stock ?? 0}</td>
          <td>${p.is_active ? "–î–∞" : "–ù–µ—Ç"}</td>
          <td>${p.category_id}</td>
          <td class="row" style="gap:6px">
            <button class="btn muted" data-act="editProd" data-id="${p.id}" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>
            <button class="btn red" data-act="delProd" data-id="${p.id}" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
          </td>
        </tr>`).join("");
      els.prodsTbodyA.querySelectorAll("button[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = parseInt(btn.dataset.id,10);
          const act = btn.dataset.act;
          if (act==="editProd"){
            const p = list.find(x=>x.id===id); if(!p) return;
            editingProdId = id;
            els.pTitle.value = p.title||"";
            els.pSlug.value = p.slug||"";
            els.pDesc.value = p.description||"";
            els.pPrice.value = String(p.price ?? 0);
            els.pCurr.value = p.currency||"RUB";
            els.pStock.value = String(p.stock ?? 0);
            els.pCat.value = String(p.category_id ?? "");
            els.pActive.value = p.is_active ? "true" : "false";
            els.pImages.value = Array.isArray(p.images) ? p.images.join("\n") : "";
            els.pAttrs.value = p.attributes ? JSON.stringify(p.attributes,null,2) : "";
            els.btnCreateProd.disabled = true; els.btnUpdateProd.disabled = false; els.btnCancelProd.disabled = false;
          } else if (act==="delProd"){
            if(!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä #${id}?`)) return;
            try{
              const r = await fetch(API_BASE+`/api/products/${id}`,{method:"DELETE",headers:headers(false,true)});
              if(!r.ok){ const t = await r.text(); throw new ApiError(r.status, parseErrorText(t), t); }
              toast("–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω","ok");
              await refreshAdminData(); await refreshProducts();
            }catch(err){ toast(err.message || "–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞","err"); }
          }
        });
      });
    }

    function collectProdPayload(){
      const title = els.pTitle.value.trim();
      let slug = els.pSlug.value.trim();
      if (!slug && title) slug = slugify(title);
      const category_id = parseInt(els.pCat.value,10);
      if (!title || !slug || !category_id){ toast("–£–∫–∞–∂–∏ title, slug –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é","err"); return null; }
      let price = parseFloat((els.pPrice.value || "0").replace(",", ".")); if (Number.isNaN(price) || price < 0) price = 0;
      const stock = parseInt(els.pStock.value || "0",10);
      const images = els.pImages.value.trim() ? els.pImages.value.split("\n").map(s=>s.trim()).filter(Boolean) : null;
      let attributes = null; const rawAttrs = els.pAttrs.value.trim();
      if (rawAttrs){ try{ attributes = JSON.parse(rawAttrs); } catch{ toast("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –∞—Ç—Ä–∏–±—É—Ç–æ–≤","err"); return null; } }
      return {
        title, slug, description: els.pDesc.value.trim() || null, price,
        currency:(els.pCurr.value||"RUB").toUpperCase(),
        stock:Number.isFinite(stock)?stock:0,
        is_active: els.pActive.value==="true",
        images, attributes, category_id
      };
    }
    function clearProdForm(){
      els.pTitle.value = els.pSlug.value = els.pDesc.value = "";
      els.pPrice.value = ""; els.pCurr.value = "RUB"; els.pStock.value = "0";
      els.pCat.value = ""; els.pActive.value = "true"; els.pImages.value = ""; els.pAttrs.value = "";
    }

    // –º–∞–ª–µ–Ω—å–∫–∏–π —Ñ—Ä–æ–Ω—Ç–æ–≤—ã–π slugify –¥–ª—è UX
    function slugify(v){
      return (v||"").toLowerCase().trim()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"-")
        .replace(/\-+/g,"-").replace(/^\-+|\-+$/g,"") || "item";
    }

    els.btnCreateProd.addEventListener("click", async ()=>{
      const payload = collectProdPayload(); if (!payload) return;
      try{
        const r = await apiSend("POST","/api/products",payload,true);
        toast(`–¢–æ–≤–∞—Ä #${r.id} —Å–æ–∑–¥–∞–Ω`,"ok");
        clearProdForm(); await refreshAdminData(); await refreshProducts();
      }catch(err){ toast(err.message || "–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞","err"); }
    });
    els.btnUpdateProd.addEventListener("click", async ()=>{
      if (!editingProdId) return;
      const payload = collectProdPayload(); if (!payload) return;
      try{
        const r = await apiSend("PATCH", `/api/products/${editingProdId}`, payload, true);
        toast(`–¢–æ–≤–∞—Ä #${r.id} —Å–æ—Ö—Ä–∞–Ω—ë–Ω`,"ok");
        editingProdId = null; els.btnCreateProd.disabled = false; els.btnUpdateProd.disabled = true; els.btnCancelProd.disabled = true;
        clearProdForm(); await refreshAdminData(); await refreshProducts();
      }catch(err){ toast(err.message || "–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞","err"); }
    });
    els.btnCancelProd.addEventListener("click", ()=>{
      editingProdId = null; els.btnCreateProd.disabled = false; els.btnUpdateProd.disabled = true; els.btnCancelProd.disabled = true; clearProdForm();
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ù–∞–≤–∏–≥–∞—Ü–∏—è / –æ–±—â–∏–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function bindHandlers(){
      els.tabCatalog.addEventListener("click", ()=>{
        els.tabCatalog.setAttribute("aria-selected","true");
        els.tabAdmin.setAttribute("aria-selected","false");
        els.viewCatalog.style.display = ""; els.viewAdmin.style.display = "none";
      });
      els.tabAdmin.addEventListener("click", ()=>{
        els.tabCatalog.setAttribute("aria-selected","false");
        els.tabAdmin.setAttribute("aria-selected","true");
        els.viewCatalog.style.display = "none"; els.viewAdmin.style.display = "";
      });
      els.btnReloadCats.addEventListener("click", refreshCategories);
      els.btnReloadProds.addEventListener("click", refreshProducts);
      els.saveApiBtn.addEventListener("click", ()=>{
        const v = els.apiInput.value.trim(); if (!v) return toast("–£–∫–∞–∂–∏ API Base URL","err");
        const u = new URL(location.href); u.searchParams.set("api", v); location.href = u.toString();
      });

      // –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ slug –∏–∑ title
      els.pTitle.addEventListener("blur", ()=>{
        if (!els.pSlug.value.trim()) els.pSlug.value = slugify(els.pTitle.value);
      });
    }

    init();
  </script>
</body>
</html>
