<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Магазин одежды</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#050816;
      --bg-soft:#0b1020;
      --bg-softer:#11172a;
      --text:#f5f5f7;
      --subtext:#9ca3af;
      --accent:#3e66ff;
      --accent-soft:rgba(62,102,255,.12);
      --accent-soft2:rgba(62,102,255,.2);
      --border:1px solid rgba(148,163,184,.25);
      --danger:#f97373;
      --ok:#22c55e;
      --muted:#0f172a;
      --badge:#f97316;
      --shadow:0 18px 45px rgba(15,23,42,.8);
      --radius:16px;
      --safe-top:0px;
      --safe-bottom:0px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",system-ui,sans-serif;
      background:radial-gradient(circle at top,#111827 0,#020617 55%,#020617 100%);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    #app{
      min-height:100vh;
      padding:calc(12px + var(--safe-top)) 10px calc(56px + var(--safe-bottom));
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:6px 4px 2px;
    }
    .brand{
      display:flex;align-items:center;gap:8px;
    }
    .brand-logo{
      width:34px;height:34px;border-radius:12px;
      background:radial-gradient(circle at 20% 0%,#4f46e5 0,#0f172a 40%,#020617 100%);
      box-shadow:0 0 0 1px rgba(129,140,248,.4),0 12px 30px rgba(15,23,42,.9);
      display:flex;align-items:center;justify-content:center;
      color:#e5e7eb;font-weight:700;font-size:17px;
    }
    .brand-text{display:flex;flex-direction:column;gap:2px}
    .brand-title{font-weight:600;font-size:15px}
    .brand-sub{font-size:11px;color:var(--subtext)}

    .pill{display:none;background:var(--muted);padding:8px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.35);font-size:11px;color:var(--subtext);gap:8px;align-items:center}
    .pill .ok{width:10px;height:10px;border-radius:50%;background:var(--ok)}

    .search{width:100%;padding:8px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.45);background:rgba(15,23,42,.85);color:var(--text);font-size:13px;outline:none}
    .search::placeholder{color:#6b7280}
    .search:focus{border-color:var(--accent-soft2);box-shadow:0 0 0 1px var(--accent-soft2)}

    .tabs{
      display:flex;
      gap:6px;
      padding:4px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.3);
    }
    .tabchip{
      flex:1;position:relative;
      border-radius:999px;
      padding:7px 6px;
      font-size:12px;
      display:flex;align-items:center;justify-content:center;
      color:var(--subtext);
      cursor:pointer;
      background:transparent;
      border:none;
    }
    .tabchip.active{
      background:radial-gradient(circle at top,#3e66ff 0,#1d2751 52%,#111827 100%);
      color:#e5e7eb;
      box-shadow:0 10px 28px rgba(15,23,42,.95);
    }
    .tabchip span{display:inline-flex;align-items:center;gap:6px}
    .tabchip svg{width:14px;height:14px}

    .chips-line{
      display:flex;
      overflow-x:auto;
      gap:6px;
      padding:2px 0 4px;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
    }
    .chips-line::-webkit-scrollbar{display:none}
    .chip{
      padding:5px 10px;
      border-radius:999px;
      font-size:11px;
      border:1px solid rgba(148,163,184,.4);
      color:var(--subtext);
      background:rgba(15,23,42,.85);
      white-space:nowrap;
      cursor:pointer;
    }
    .chip.active{
      border-color:var(--accent-soft2);
      background:var(--accent-soft);
      color:#e5e7eb;
    }

    .grid{display:grid;gap:10px}
    .grid.cards{grid-template-columns:1fr 1fr}
    @media(min-width:560px){ .grid.cards{grid-template-columns:1fr 1fr 1fr} }

    .card{
      display:flex;flex-direction:column;background:#11172a;border-radius:16px;border:var(--border);overflow:hidden;position:relative
    }
    .card .pic{width:100%;padding-top:100%;background:#0f1430;position:relative;overflow:hidden;flex:0 0 auto}
    .card .pic img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .card .fav{
      position:absolute;top:8px;right:8px;z-index:2;background:rgba(17,22,42,.7);
      border-radius:999px;border:1px solid rgba(148,163,184,.6);width:26px;height:26px;
      display:flex;align-items:center;justify-content:center;cursor:pointer;
    }
    .card .fav svg{width:14px;height:14px;fill:none;stroke:#e5e7eb}
    .card .fav.active{background:rgba(248,250,252,.98);}
    .card .fav.active svg{stroke:#f97316;fill:#f97316}

    .card .body{padding:9px 9px 10px;display:flex;flex-direction:column;gap:4px}
    .card .ttl{font-size:13px;font-weight:500}
    .card .sub{font-size:11px;color:var(--subtext);min-height:26px}
    .card .price-row{display:flex;align-items:center;justify-content:space-between;margin-top:4px}
    .card .price{font-weight:600;font-size:14px}
    .card .btn-mini{
      border:none;border-radius:999px;padding:5px 9px;font-size:11px;
      background:var(--accent-soft);color:#e5e7eb;cursor:pointer;
      display:inline-flex;align-items:center;gap:6px;
    }
    .card .btn-mini svg{width:14px;height:14px}

    .empty{padding:16px 10px;font-size:13px;color:var(--subtext);text-align:center}

    .tabbar{
      position:fixed;bottom:0;left:0;right:0;
      padding:6px 10px calc(6px + var(--safe-bottom));
      background:linear-gradient(to top,rgba(15,23,42,.98),rgba(15,23,42,.92));
      border-top:1px solid rgba(148,163,184,.3);
      display:flex;gap:6px;justify-content:space-between;
      backdrop-filter:blur(16px);
    }
    .tabbtn{
      flex:1;border-radius:999px;border:none;padding:6px 4px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      font-size:11px;color:var(--subtext);background:transparent;position:relative;cursor:pointer;
    }
    .tabbtn svg{width:18px;height:18px;margin-bottom:2px}
    .tabbtn.active{
      color:#e5e7eb;
    }
    .tabbtn.active::before{
      content:"";position:absolute;inset:-2px;
      border-radius:999px;
      background:radial-gradient(circle at top,#3e66ff 0,transparent 55%);
      opacity:.4;z-index:-1;
    }
    .tabbtn .badge-dot{
      position:absolute;right:6px;top:4px;min-width:20px;height:20px;padding:0 6px;border-radius:999px;background:var(--badge);color:#fff;
      font-weight:800;font-size:12px;display:none;align-items:center;justify-content:center;line-height:1;border:2px solid #0c1122;
    }

    /* Catalog tiles + subcategories */
    .cat-tiles{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(min-width:560px){ .cat-tiles{grid-template-columns:1fr 1fr 1fr} }
    .cat-tile{
      background:#1a2033;border:1px solid rgba(255,255,255,.06);border-radius:14px;position:relative;overflow:hidden;
      padding:12px;min-height:110px;display:flex;align-items:flex-end;justify-content:space-between;gap:8px;cursor:pointer;
    }
    .cat-tile .tt{font-weight:600}
    .cat-tile .img{position:absolute;right:6px;bottom:0;width:60px;height:60px;opacity:.95;pointer-events:none;mask-image:linear-gradient(to top,black 65%, transparent)}
    .cat-back{display:flex;align-items:center;gap:6px;font-size:12px;margin-top:4px;cursor:pointer;color:var(--subtext)}
    .cat-back svg{width:14px;height:14px}

    /* Cart & fav */
    .cart-list{display:flex;flex-direction:column;gap:8px}
    .cart-item{
      display:flex;gap:10px;padding:10px;border-radius:14px;background:#11172a;border:1px solid rgba(148,163,184,.45);
    }
    .cart-thumb{width:64px;height:64px;border-radius:12px;background:#020617;overflow:hidden;flex:0 0 auto}
    .cart-thumb img{width:100%;height:100%;object-fit:cover}
    .cart-body{flex:1;display:flex;flex-direction:column;gap:4px}
    .cart-ttl{font-size:13px;font-weight:500}
    .cart-sub{font-size:11px;color:var(--subtext)}
    .cart-bottom{display:flex;align-items:center;justify-content:space-between;margin-top:4px}
    .counter{
      display:inline-flex;align-items:center;border-radius:999px;background:#020617;border:1px solid rgba(148,163,184,.5);overflow:hidden;
    }
    .counter button{
      border:none;background:transparent;color:var(--text);width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:14px;cursor:pointer;
    }
    .counter span{min-width:20px;text-align:center;font-size:12px}

    .totals{
      margin-top:10px;padding:10px;border-radius:16px;background:radial-gradient(circle at top,#1d283a 0,#020617 70%);
      border:1px solid rgba(148,163,184,.4);display:flex;flex-direction:column;gap:6px;font-size:13px;
    }
    .totals-row{display:flex;align-items:center;justify-content:space-between}
    .totals-main{font-weight:600;font-size:15px}
    .btn-primary{
      margin-top:8px;width:100%;border-radius:999px;border:none;padding:10px 12px;font-size:14px;font-weight:600;
      background:linear-gradient(135deg,#4f46e5,#6366f1);color:#f9fafb;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:8px;
      box-shadow:0 18px 45px rgba(55,65,194,.7);
    }
    .btn-primary:active{transform:translateY(1px);box-shadow:0 10px 25px rgba(55,65,194,.7)}

    .section-title{font-size:14px;font-weight:600;margin:4px 0 6px 2px}
    .muted{color:var(--subtext);font-size:11px}

    /* Admin */
    .admin-grid{display:grid;gap:12px}
    .square-btns{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px}
    .square-btn{display:flex;align-items:center;justify-content:center;gap:6px;border-radius:14px;padding:10px 6px;border:1px dashed rgba(148,163,184,.65);background:#1a2033;color:var(--text);cursor:pointer}
    .panel{display:none;background:#11172a;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px}
    .panel h3{margin:0 0 8px 0;font-size:15px;display:flex;align-items:center;justify-content:space-between;gap:8px}
    .panel-toggle{border:none;background:transparent;color:var(--subtext);font-size:12px;cursor:pointer;padding:2px 8px;border-radius:999px}
    .panel-toggle:hover{background:rgba(255,255,255,.06);color:var(--text)}
    .filebox{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .filebox .thumb-up{width:60px;height:60px;border-radius:12px;background:#020617;overflow:hidden}
    .filebox .thumb-up img{width:100%;height:100%;object-fit:cover}
    .row{margin-bottom:8px}
    .row label{cursor:pointer}
    .iconbtn{
      border-radius:999px;border:1px solid rgba(148,163,184,.45);background:#020617;width:32px;height:32px;
      display:inline-flex;align-items:center;justify-content:center;cursor:pointer;
    }
    .iconbtn svg{width:16px;height:16px}
    .add{
      border-radius:999px;border:none;width:100%;padding:8px 10px;font-size:13px;font-weight:500;
      background:var(--accent-soft);color:#e5e7eb;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;gap:6px;
    }
    .add svg{width:16px;height:16px}

    .list-admin{display:flex;flex-direction:column;gap:6px}
    .row-admin{
      display:flex;align-items:center;justify-content:space-between;gap:8px;
      padding:8px 10px;border-radius:12px;background:#020617;border:1px solid rgba(148,163,184,.5);
      font-size:12px;
    }
    .row-admin .t{flex:1;min-width:0}
    .row-admin .t span{color:var(--subtext);font-size:11px}
    .row-admin .iconbtn{flex:0 0 auto}

    /* Toast */
    #toast{
      position:fixed;left:50%;bottom:calc(70px + var(--safe-bottom));transform:translateX(-50%);
      background:#020617;border-radius:999px;padding:8px 14px;font-size:12px;color:var(--text);border:1px solid rgba(148,163,184,.6);
      opacity:0;pointer-events:none;transition:opacity .2s,transform .2s;
      max-width:80%;text-align:center;
    }
    #toast.show{opacity:1;transform:translateX(-50%) translateY(-6px)}

    .fav-empty{text-align:center;padding:20px 10px;font-size:13px;color:var(--subtext)}
    .fav-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(min-width:560px){ .fav-grid{grid-template-columns:1fr 1fr 1fr} }

    .badge-small{font-size:10px;padding:2px 6px;border-radius:999px;border:1px solid rgba(148,163,184,.5);color:var(--subtext)}

    input:-webkit-autofill,input:-webkit-autofill:hover,input:-webkit-autofill:focus{transition:background-color 99999s ease-in-out 0s}
  </style>
</head>
<body>
<div id="app">
  <div class="topbar">
    <div class="brand">
      <div class="brand-logo">TG</div>
      <div class="brand-text">
        <div class="brand-title">Магазин одежды</div>
        <div class="brand-sub">Выбирай и заказывай прямо в Telegram</div>
      </div>
    </div>
    <div class="pill" id="adminPill">
      <div class="ok"></div>
      <div>Админ режим</div>
    </div>
  </div>

  <div class="tabs">
    <button class="tabchip active" data-screen="scr_home"><span><svg viewBox="0 0 24 24"><path d="M4 10.5 12 4l8 6.5V20a1 1 0 0 1-1 1h-5v-5H10v5H5a1 1 0 0 1-1-1v-9.5Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>Каталог</span></button>
    <button class="tabchip" data-screen="scr_cart"><span><svg viewBox="0 0 24 24"><path d="M5 5h1.2a1 1 0 0 1 .98.8L8 9m0 0h11l-1.2 6H8L6.8 9H8Zm0 0L7 6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>Корзина</span></button>
    <button class="tabchip" data-screen="scr_fav"><span><svg viewBox="0 0 24 24"><path d="M12.1 6.2 12 6.3l-.1-.1C10.1 4.6 7.4 4.6 5.7 6.3c-1.7 1.7-1.7 4.4 0 6.1l1.1 1.1L12 18l5.2-4.5 1.1-1.1c1.7-1.7 1.7-4.4 0-6.1-1.7-1.7-4.4-1.7-6.1 0Z" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/></svg>Избранное</span></button>
    <button class="tabchip" data-screen="scr_profile"><span><svg viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4 0-7 2-7 4v1h14v-1c0-2-3-4-7-4Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>Профиль</span></button>
  </div>

  <div id="screens">
    <!-- Каталог -->
    <section id="scr_home" class="screen" style="display:block">
      <input id="searchInput" class="search" placeholder="Поиск по товарам..." />

      <div class="chips-line" id="catChips"></div>

      <div id="catSub" style="display:none;margin-top:8px">
        <div class="cat-back" id="catBack">
          <svg viewBox="0 0 24 24"><path d="M15 6 9 12l6 6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>Назад к категориям</span>
        </div>
        <div class="chips-line" id="subCatChips" style="margin-top:4px"></div>
      </div>

      <div id="catTilesEmpty" class="empty" style="display:none">Категории пока не созданы</div>
      <div id="catTiles" class="cat-tiles"></div>

      <div class="section-title" style="margin-top:10px">Товары</div>
      <div id="homeEmpty" class="empty" style="display:none">Товары пока не добавлены</div>
      <div id="homeGrid" class="grid cards"></div>
    </section>

    <!-- Корзина -->
    <section id="scr_cart" class="screen" style="display:none">
      <div id="cartEmpty" class="empty">В корзине пока пусто</div>
      <div id="cartList" class="cart-list"></div>
      <div id="cartTotals" class="totals" style="display:none">
        <div class="totals-row">
          <span class="muted">Товаров</span>
          <span id="cartCount" class="muted"></span>
        </div>
        <div class="totals-row totals-main">
          <span>Итого</span>
          <span id="cartSum"></span>
        </div>
        <button id="btnCheckout" class="btn-primary">
          <svg viewBox="0 0 24 24"><path d="M5 5h1.2a1 1 0 0 1 .98.8L8 9m0 0h11l-1.2 6H8L6.8 9H8Zm0 0L7 6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Оформить заказ
        </button>
      </div>
    </section>

    <!-- Избранное -->
    <section id="scr_fav" class="screen" style="display:none">
      <div id="favEmpty" class="fav-empty">Тут будут товары, которые вы добавите в избранное</div>
      <div id="favGrid" class="fav-grid"></div>
    </section>

    <!-- Профиль / настройки -->
    <section id="scr_profile" class="screen" style="display:none">
      <div class="panel" style="display:block">
        <h3>Профиль</h3>
        <div class="row">
          <div class="muted">Ваш Telegram ID:</div>
          <div id="tgIdOut" style="font-size:13px"></div>
        </div>
        <div class="row">
          <div class="muted">Имя:</div>
          <div id="tgNameOut" style="font-size:13px"></div>
        </div>
        <div class="row">
          <div class="muted">Статус:</div>
          <div id="tgRoleOut" style="font-size:13px"></div>
        </div>
        <button id="btnResetLocal" class="add" style="max-width:160px;background:#44506f">Сбросить локальные данные</button>
      </div>
      <div style="height:8px"></div>
      <div class="line">
        <div class="t"><div class="muted">API:</div><div style="word-break:break-all" id="apiShown"></div></div>
      </div>
    </section>

    <!-- Админ -->
    <section id="scr_admin" class="screen">
      <div class="admin-grid">
        <!-- квадратные кнопки -->
        <div class="square-btns">
          <button id="btnOpenCreateProd" class="square-btn"><svg class="icv"><use href="#i-plus"/></svg>Создать товар</button>
          <button id="btnOpenCreateCat" class="square-btn"><svg class="icv"><use href="#i-plus"/></svg>Создать категорию</button>
        </div>

        <!-- панель создания товара -->
        <div id="panelCreateProd" class="panel">
          <h3>Создание товара</h3>
          <div class="row"><input id="cpTitle" class="search" placeholder="Название товара"/></div>
          <div class="row"><textarea id="cpDesc" class="search" placeholder="Описание товара"></textarea></div>
          <div class="row"><input id="cpPrice" class="search" type="number" min="0" step="0.01" placeholder="Цена"/></div>

          <div class="row">
            <label class="iconbtn" for="cpImages"><svg class="icv"><use href="#i-camera"/></svg></label>
            <input id="cpImages" type="file" accept="image/*" multiple style="display:none" />
            <div id="cpPreview" class="filebox"></div>
          </div>

          <div class="row">
            <select id="cpCatRoot" class="search">
              <option value="">— Выбери категорию —</option>
            </select>
          </div>

          <div class="row" id="cpSubcatsRow" style="display:none">
            <select id="cpCatSub" class="search">
              <option value="">— Выбери подкатегорию —</option>
            </select>
          </div>

          <div class="row"><button id="cpCreate" class="add"><svg class="icv"><use href="#i-save"/></svg>&nbsp;Сохранить</button></div>
        </div>

        <!-- панель создания категории -->
        <div id="panelCreateCat" class="panel">
          <h3>Создание категории</h3>
          <div class="row"><input id="ccName" class="search" placeholder="Название"/></div>
          <div class="row">
            <label class="iconbtn" for="ccImage"><svg class="icv"><use href="#i-camera"/></svg></label>
            <input id="ccImage" type="file" accept="image/*" style="display:none" />
            <div id="ccPreview" class="filebox"></div>
          </div>
          <div class="row">
            <select id="ccParent" class="search"><option value="">Основная</option></select>
          </div>
          <div class="row"><button id="ccCreate" class="add"><svg class="icv"><use href="#i-save"/></svg>&nbsp;Сохранить</button></div>
        </div>

        <!-- списки для редактирования/удаления -->
        <div class="panel" style="display:block">
          <h3>Категории <button id="toggleCatsList" type="button" class="panel-toggle">Скрыть список</button></h3>
          <div id="catsEmptyA" class="empty">Нет категорий</div>
          <div id="catsTableAWrap" class="list-admin" style="display:none"></div>
        </div>
        <div class="panel" style="display:block">
          <h3>Товары <button id="toggleProdsList" type="button" class="panel-toggle">Скрыть список</button></h3>
          <div id="prodsEmptyA" class="empty">Нет товаров</div>
          <div id="prodsTableAWrap" class="list-admin" style="display:none"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Bottom Tabbar -->
  <nav id="tabbar" class="tabbar">
    <button class="tabbtn active" data-screen="scr_home">
      <span class="badge-dot" id="cartBadge"></span>
      <svg viewBox="0 0 24 24"><path d="M4 10.5 12 4l8 6.5V20a1 1 0 0 1-1 1h-5v-5H10v5H5a1 1 0 0 1-1-1v-9.5Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg>
      <span>Каталог</span>
    </button>
    <button class="tabbtn" data-screen="scr_cart">
      <span class="badge-dot" id="cartBadgeTab"></span>
      <svg viewBox="0 0 24 24"><path d="M5 5h1.2a1 1 0 0 1 .98.8L8 9m0 0h11l-1.2 6H8L6.8 9H8Zm0 0L7 6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span>Корзина</span>
    </button>
    <button class="tabbtn" data-screen="scr_fav">
      <svg viewBox="0 0 24 24"><path d="M12.1 6.2 12 6.3l-.1-.1C10.1 4.6 7.4 4.6 5.7 6.3c-1.7 1.7-1.7 4.4 0 6.1l1.1 1.1L12 18l5.2-4.5 1.1-1.1c1.7-1.7 1.7-4.4 0-6.1-1.7-1.7-4.4-1.7-6.1 0Z" fill="none" stroke="currentColor" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span>Избранное</span>
    </button>
    <button class="tabbtn" data-screen="scr_profile">
      <svg viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4 0-7 2-7 4v1h14v-1c0-2-3-4-7-4Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span>Профиль</span>
    </button>
  </nav>

  <div id="toast"></div>

  <svg style="display:none">
    <symbol id="i-plus" viewBox="0 0 24 24">
      <path d="M12 5v14M5 12h14" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
    </symbol>
    <symbol id="i-save" viewBox="0 0 24 24">
      <path d="M5 5h11l3 3v11H5V5Zm4 0v6h6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-edit" viewBox="0 0 24 24">
      <path d="M5 19h3l10-10-3-3L5 16v3Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
    </symbol>
    <symbol id="i-trash" viewBox="0 0 24 24">
      <path d="M6 7h12M10 11v6M14 11v6M9 4h6l1 3H8l1-3Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
    </symbol>
  </svg>
</div>

<script>
  (function(){
    const url = new URL(location.href);
    const API_BASE = (url.searchParams.get("api") || "").replace(/\/+$/,"");
    const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

    if(tg){
      tg.ready();
      tg.expand();
      tg.setHeaderColor("#050816");
      tg.setBackgroundColor("#050816");
      tg.setBottomBarColor("#050816");
    }

    document.documentElement.style.setProperty("--safe-top", (tg && tg.safeAreaInsetTop ? tg.safeAreaInsetTop+"px" : "0px"));
    document.documentElement.style.setProperty("--safe-bottom", (tg && tg.safeAreaInsetBottom ? tg.safeAreaInsetBottom+"px" : "0px"));

    const headers = (withJson=true, withTg=false)=> {
      const h = {};
      if (withJson) h["Content-Type"] = "application/json";
      if (withTg && tg){
        h["X-Telegram-Init-Data"] = tg.initData || "";
        h["X-Telegram-Init-Data-Unsafe"] = JSON.stringify(tg.initDataUnsafe||{});
      }
      return h;
    };

    function parseJsonOrThrow(text){
      try{
        return JSON.parse(text);
      }catch(e){
        throw new Error(text || "API error");
      }
    }

    async function apiGet(path, params=null){
      const q = params ? ("?"+new URLSearchParams(params).toString()) : "";
      const r = await fetch(API_BASE + path + q, {headers:headers(false,false)});
      const t = await r.text();
      if (!r.ok){
        console.error("API GET error", r.status, t);
        throw new Error(parseErrorText(t));
      }
      return t ? JSON.parse(t) : null;
    }

    function parseErrorText(t){
      try{
        const j = JSON.parse(t);
        if (typeof j === "string") return j;
        if (j.detail) return Array.isArray(j.detail) ? j.detail.map(x=>x.msg||x.detail).join(", ") : j.detail;
      }catch(e){}
      return t || "Ошибка запроса";
    }

    async function apiSend(method, path, body=null, withTg=false){
      const r = await fetch(API_BASE + path, {
        method,
        headers: headers(true, withTg),
        body: body ? JSON.stringify(body) : null
      });
      const t = await r.text();
      if (!r.ok){
        console.error("API error", method, path, r.status, t);
        throw new Error(parseErrorText(t));
      }
      return t ? JSON.parse(t) : null;
    }

    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.className = "toast show";
      setTimeout(()=>el.className="toast",2200);
    }
    function money(v,c="RUB"){ return `${Number(v||0).toFixed(0)} ${c}`; }
    function escapeHtml(s){ return String(s).replace(/[&<>"'`]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])); }
    function formatCount(n){ n = Number(n||0); return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "\u202F"); }

    // ───────── visibility filter: теперь не скрываем товары/категории по владельцу, но оставляем функцию на будущее
    function visibleToMe(obj){
      const owner = obj?.attributes?.owner_tg_id ?? null;
      return owner === null || String(owner) === String(tgId);
    }

    // ───────── State
    const favKey="tgshop_fav_ids"; const cartKey="tgshop_cart";
    let fav = new Set(JSON.parse(localStorage.getItem(favKey)||"[]"));
    let cart = new Map(Object.entries(JSON.parse(localStorage.getItem(cartKey)||"{}")).map(([id,qty])=>[Number(id),Number(qty)]));
    let adminCatsVisible = true, adminProdsVisible = true;

    let tgId = null;
    let allCategories = [];
    let allProducts = [];
    let catIndexByParent = new Map();
    let selectedCat = null;
    let editingCatId = null, editingProdId = null;

    // Restore API base info
    document.getElementById("apiShown").textContent = API_BASE || "не задан";

    // Tabs
    document.querySelectorAll(".tabbtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const scr = btn.dataset.screen;
        document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
        const el = document.getElementById(scr);
        if (el) el.style.display = "block";
      });
    });

    document.querySelectorAll(".tabchip").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        document.querySelectorAll(".tabchip").forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        const scr = btn.dataset.screen;
        document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
        const el = document.getElementById(scr);
        if (el) el.style.display = "block";
      });
    });

    // Reset local
    document.getElementById("btnResetLocal").addEventListener("click", ()=>{
      localStorage.removeItem(favKey);
      localStorage.removeItem(cartKey);
      fav = new Set();
      cart = new Map();
      renderFav();
      renderCart();
      updateCartBadge();
      toast("Локальные данные очищены");
    });

    // Ensure user on backend
    async function ensureUser(){
      if (!API_BASE || !tg) return;
      try{
        const payload = {
          tg_id: tg.initDataUnsafe.user?.id || null,
          username: tg.initDataUnsafe.user?.username || null,
          first_name: tg.initDataUnsafe.user?.first_name || null,
          last_name: tg.initDataUnsafe.user?.last_name || null
        };
        const r = await apiSend("POST","/api/ensure_user",payload,true);
        tgId = r.tg_id;
        document.getElementById("tgIdOut").textContent = r.tg_id;
        const fullName = [tg.initDataUnsafe.user?.first_name||"", tg.initDataUnsafe.user?.last_name||""].filter(Boolean).join(" ");
        document.getElementById("tgNameOut").textContent = fullName || (tg.initDataUnsafe.user?.username ? "@"+tg.initDataUnsafe.user.username : "Без имени");
        const roleText = r.is_admin ? "Администратор" : "Покупатель";
        document.getElementById("tgRoleOut").textContent = roleText;
        if (r.is_admin){
          document.getElementById("adminPill").style.display="inline-flex";
          const adminTab = document.createElement("button");
          adminTab.className="tabbtn";
          adminTab.dataset.screen="scr_admin";
          adminTab.innerHTML = '<svg viewBox="0 0 24 24"><path d="M4 5h16v4H4Zm0 5h10v4H4Zm0 5h7v4H4Z" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/></svg><span>Админ</span>';
          document.getElementById("tabbar").appendChild(adminTab);
          adminTab.addEventListener("click", ()=>{
            document.querySelectorAll(".tabbtn").forEach(b=>b.classList.remove("active"));
            adminTab.classList.add("active");
            document.querySelectorAll(".screen").forEach(s=>s.style.display="none");
            document.getElementById("scr_admin").style.display="block";
          });
        }
      }catch(e){ console.warn("ensure user failed",e); }
    }

    async function loadCategories(){
      let cats = await apiGet("/api/categories");
      // Показываем все категории, не скрываем по владельцу
      allCategories = cats;
      indexCategories(cats);
      renderCatTiles();
      // селекты в панелях
      const cc = document.getElementById("ccParent");
      cc.innerHTML = '<option value="">Основная</option>' + cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");
      const cpRoot = document.getElementById("cpCatRoot");
      cpRoot.innerHTML = '<option value="">— Выбери категорию —</option>' + (catIndexByParent.get(null)||[]).map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");
    }

    async function loadProducts(params){
      let list = await apiGet("/api/products", params);
      // Показываем все товары, не скрываем по владельцу
      allProducts = list;
      renderHome(list);
      renderFav();
      renderCart();
      updateCartBadge();
      renderAdminCats();
      renderAdminProds();
    }

    // Каталог подсчёт категорий
    function indexCategories(cats){
      catIndexByParent.clear();
      for (const c of cats){
        const pid = c.parent_id === null ? null : c.parent_id;
        if (!catIndexByParent.has(pid)) catIndexByParent.set(pid,[]);
        catIndexByParent.get(pid).push(c);
      }
    }

    // Каталог плитки категорий
    function renderCatTiles(){
      selectedCat = null;
      const tiles = document.getElementById("catTiles");
      const empty = document.getElementById("catTilesEmpty");
      const sub = document.getElementById("catSub");
      sub.style.display = "none"; tiles.style.display = "grid";
      const roots = (catIndexByParent.get(null)||[]);
      if(!roots.length){ tiles.innerHTML=""; empty.style.display="block"; return; }
      empty.style.display="none";
      tiles.innerHTML = roots.map(c=>{
        const img = c.attributes?.image || "";
        return `
          <div class="cat-tile" data-id="${c.id}">
            <div class="tt">${escapeHtml(c.name)}</div>
            ${img?`<img class="img" src="${escapeHtml(img)}" alt="">`:""}
          </div>
        `;
      }).join("");
      tiles.querySelectorAll(".cat-tile").forEach(tile=>{
        tile.addEventListener("click", ()=>{
          const id = Number(tile.dataset.id);
          openSubcategories(id);
        });
      });
    }

    function openSubcategories(catId){
      selectedCat = catId;
      const tiles = document.getElementById("catTiles");
      const sub = document.getElementById("catSub");
      const subChips = document.getElementById("subCatChips");
      tiles.style.display="none"; sub.style.display="block";
      const children = catIndexByParent.get(catId)||[];
      subChips.innerHTML = children.map(c=>`<button class="chip" data-id="${c.id}">${escapeHtml(c.name)}</button>`).join("");
      subChips.querySelectorAll(".chip").forEach(ch=>{
        ch.addEventListener("click", ()=>{
          const id = Number(ch.dataset.id);
          selectedCat = id;
          applyFilters();
        });
      });
      document.getElementById("catBack").onclick = ()=>{
        selectedCat = null;
        sub.style.display="none";
        document.getElementById("catTiles").style.display="grid";
        applyFilters();
      };
      applyFilters();
    }

    // Главная сетка
    function renderHome(list){
      const grid = document.getElementById("homeGrid");
      const empty = document.getElementById("homeEmpty");
      if (!list.length){ grid.innerHTML=""; empty.style.display="block"; return; }
      empty.style.display="none";
      grid.innerHTML = list.map(p=>{
        const img = (p.images && p.images[0]) || "";
        const inFav = fav.has(p.id);
        return `
          <div class="card" data-id="${p.id}">
            <div class="pic">
              ${img?`<img src="${escapeHtml(img)}" alt="">`:""}
              <button class="fav ${inFav?"active":""}" data-id="${p.id}">
                <svg viewBox="0 0 24 24"><path d="M12.1 6.2 12 6.3l-.1-.1C10.1 4.6 7.4 4.6 5.7 6.3c-1.7 1.7-1.7 4.4 0 6.1l1.1 1.1L12 18l5.2-4.5 1.1-1.1c1.7-1.7 1.7-4.4 0-6.1-1.7-1.7-4.4-1.7-6.1 0Z"/></svg>
              </button>
            </div>
            <div class="body">
              <div class="ttl">${escapeHtml(p.title)}</div>
              <div class="sub">${escapeHtml(p.description||"")}</div>
              <div class="price-row">
                <div class="price">${money(p.price,(p.currency||"RUB").toUpperCase())}</div>
                <button class="btn-mini" data-act="addToCart" data-id="${p.id}">
                  <svg viewBox="0 0 24 24"><path d="M5 5h1.2a1 1 0 0 1 .98.8L8 9m0 0h11l-1.2 6H8L6.8 9H8Zm0 0L7 6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  В корзину
                </button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      grid.querySelectorAll(".fav").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = Number(btn.dataset.id);
          if (fav.has(id)) fav.delete(id); else fav.add(id);
          localStorage.setItem(favKey, JSON.stringify([...fav]));
          renderFav();
          renderHome(allProducts);
        });
      });

      grid.querySelectorAll("[data-act='addToCart']").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = Number(btn.dataset.id);
          const cur = cart.get(id)||0;
          cart.set(id, cur+1);
          localStorage.setItem(cartKey, JSON.stringify(Object.fromEntries(cart)));
          renderCart();
          updateCartBadge();
          toast("Товар добавлен в корзину");
        });
      });
    }

    function renderFav(){
      const grid = document.getElementById("favGrid");
      const empty = document.getElementById("favEmpty");
      const list = allProducts.filter(p=>fav.has(p.id));
      if (!list.length){ grid.innerHTML=""; empty.style.display="block"; return; }
      empty.style.display="none";
      grid.innerHTML = list.map(p=>{
        const img = (p.images && p.images[0]) || "";
        return `
          <div class="card" data-id="${p.id}">
            <div class="pic">
              ${img?`<img src="${escapeHtml(img)}" alt="">`:""}
              <button class="fav active" data-id="${p.id}">
                <svg viewBox="0 0 24 24"><path d="M12.1 6.2 12 6.3l-.1-.1C10.1 4.6 7.4 4.6 5.7 6.3c-1.7 1.7-1.7 4.4 0 6.1l1.1 1.1L12 18l5.2-4.5 1.1-1.1c1.7-1.7 1.7-4.4 0-6.1-1.7-1.7-4.4-1.7-6.1 0Z"/></svg>
              </button>
            </div>
            <div class="body">
              <div class="ttl">${escapeHtml(p.title)}</div>
              <div class="sub">${escapeHtml(p.description||"")}</div>
              <div class="price-row">
                <div class="price">${money(p.price,(p.currency||"RUB").toUpperCase())}</div>
                <button class="btn-mini" data-act="addToCart" data-id="${p.id}">
                  <svg viewBox="0 0 24 24"><path d="M5 5h1.2a1 1 0 0 1 .98.8L8 9m0 0h11l-1.2 6H8L6.8 9H8Zm0 0L7 6" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  В корзину
                </button>
              </div>
            </div>
          </div>
        `;
      }).join("");

      grid.querySelectorAll(".fav").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = Number(btn.dataset.id);
          fav.delete(id);
          localStorage.setItem(favKey, JSON.stringify([...fav]));
          renderFav();
          renderHome(allProducts);
        });
      });

      grid.querySelectorAll("[data-act='addToCart']").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = Number(btn.dataset.id);
          const cur = cart.get(id)||0;
          cart.set(id, cur+1);
          localStorage.setItem(cartKey, JSON.stringify(Object.fromEntries(cart)));
          renderCart();
          updateCartBadge();
          toast("Товар добавлен в корзину");
        });
      });
    }

    function renderCart(){
      const listEl = document.getElementById("cartList");
      const empty = document.getElementById("cartEmpty");
      const totals = document.getElementById("cartTotals");
      const items = [...cart.entries()].map(([id,qty])=>{
        const prod = allProducts.find(p=>p.id===id);
        return prod ? {prod, qty} : null;
      }).filter(Boolean);

      if (!items.length){
        listEl.innerHTML="";
        empty.style.display="block";
        totals.style.display="none";
        return;
      }
      empty.style.display="none";
      totals.style.display="block";

      let totalQty = 0;
      let totalSum = 0;
      listEl.innerHTML = items.map(({prod,qty})=>{
        totalQty += qty;
        totalSum += (Number(prod.price)||0)*qty;
        const img = (prod.images && prod.images[0]) || "";
        return `
          <div class="cart-item" data-id="${prod.id}">
            <div class="cart-thumb">${img?`<img src="${escapeHtml(img)}" alt="">`:""}</div>
            <div class="cart-body">
              <div class="cart-ttl">${escapeHtml(prod.title)}</div>
              <div class="cart-sub">${escapeHtml(prod.description||"")}</div>
              <div class="cart-bottom">
                <div class="counter">
                  <button data-act="dec">−</button>
                  <span>${qty}</span>
                  <button data-act="inc">+</button>
                </div>
                <div class="price">${money((Number(prod.price)||0)*qty,(prod.currency||"RUB").toUpperCase())}</div>
              </div>
            </div>
          </div>
        `;
      }).join("");

      document.getElementById("cartCount").textContent = formatCount(totalQty);
      document.getElementById("cartSum").textContent = money(totalSum,"RUB");

      listEl.querySelectorAll(".cart-item").forEach(row=>{
        const id = Number(row.dataset.id);
        row.querySelectorAll("button[data-act]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const act = btn.dataset.act;
            const cur = cart.get(id)||0;
            if (act==="inc"){
              cart.set(id, cur+1);
            } else if (act==="dec"){
              if (cur<=1) cart.delete(id); else cart.set(id, cur-1);
            }
            localStorage.setItem(cartKey, JSON.stringify(Object.fromEntries(cart)));
            renderCart();
            updateCartBadge();
          });
        });
      });
    }

    function updateCartBadge(){
      const cartCount = [...cart.values()].reduce((a,b)=>a+b,0);
      const badge = document.getElementById("cartBadge");
      const badgeTab = document.getElementById("cartBadgeTab");
      if (cartCount>0){
        badge.style.display="flex";
        badge.textContent=String(cartCount);
        badgeTab.style.display="flex";
        badgeTab.textContent=String(cartCount);
      } else {
        badge.style.display="none";
        badgeTab.style.display="none";
      }
    }

    // ───────── Admin lists/edit
    function renderAdminCats(){
      const list = allCategories.slice().sort((a,b)=>a.id-b.id);
      const wrap = document.getElementById("catsTableAWrap");
      const empty = document.getElementById("catsEmptyA");
      const toggle = document.getElementById("toggleCatsList");
      if (!list.length){
        wrap.style.display="none";
        empty.style.display="block";
        wrap.innerHTML="";
        if (toggle) toggle.style.display="none";
        return;
      }
      empty.style.display="none";
      wrap.style.flexDirection="column";
      wrap.style.display = adminCatsVisible ? "flex" : "none";
      if (toggle){
        toggle.style.display="inline-flex";
        toggle.textContent = adminCatsVisible ? "Скрыть список" : "Показать список";
      }
      wrap.innerHTML = list.map(c=>`
        <div class="row-admin">
          <div class="t">${escapeHtml(c.name)} ${c.parent_id?`· parent:${c.parent_id}`:""}</div>
          <button class="iconbtn" data-act="editCat" data-id="${c.id}" title="Редактировать"><svg class="icv"><use href="#i-edit"/></svg></button>
          <button class="iconbtn" data-act="delCat" data-id="${c.id}" title="Удалить"><svg class="icv"><use href="#i-trash"/></svg></button>
        </div>
      `).join("");
      wrap.querySelectorAll("[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = Number(btn.dataset.id); const act=btn.dataset.act;
          const list = allCategories.slice().sort((a,b)=>a.id-b.id);
          if (act==="editCat"){
            const c = list.find(x=>x.id===id); if(!c) return;
            document.getElementById("panelCreateCat").style.display="block";
            document.getElementById("ccName").value = c.name;
            document.getElementById("ccPreview").dataset.image = c.attributes?.image || "";
            document.getElementById("ccPreview").innerHTML = c.attributes?.image ? `<div class="thumb-up"><img src="${escapeHtml(c.attributes.image)}"></div>`:"";
            document.getElementById("ccParent").value = c.parent_id ?? "";
            editingCatId = id;
          } else if (act==="delCat"){
            if(!confirm(`Удалить категорию #${id}?`)) return;
            const r = await fetch(API_BASE+`/api/categories/${id}`,{method:"DELETE",headers:headers(false,true)});
            if(!r.ok){ const t=await r.text(); return toast(parseErrorText(t)); }
            toast("Категория удалена"); await loadCategories();
          }
        });
      });
    }

    function renderAdminProds(){
      const list = allProducts.slice().sort((a,b)=>a.id-b.id);
      const wrap = document.getElementById("prodsTableAWrap");
      const empty = document.getElementById("prodsEmptyA");
      const toggle = document.getElementById("toggleProdsList");
      if (!list.length){
        wrap.style.display="none";
        empty.style.display="block";
        wrap.innerHTML="";
        if (toggle) toggle.style.display="none";
        return;
      }
      empty.style.display="none";
      wrap.style.flexDirection="column";
      wrap.style.display = adminProdsVisible ? "flex" : "none";
      if (toggle){
        toggle.style.display="inline-flex";
        toggle.textContent = adminProdsVisible ? "Скрыть список" : "Показать список";
      }
      wrap.innerHTML = list.map(p=>`
        <div class="row-admin">
          <div class="t">${escapeHtml(p.title)} · ${money(p.price,(p.currency||"RUB").toUpperCase())}</div>
          <button class="iconbtn" data-act="editProd" data-id="${p.id}" title="Редактировать"><svg class="icv"><use href="#i-edit"/></svg></button>
          <button class="iconbtn" data-act="delProd" data-id="${p.id}" title="Удалить"><svg class="icv"><use href="#i-trash"/></svg></button>
        </div>
      `).join("");
      wrap.querySelectorAll("[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = Number(btn.dataset.id); const act=btn.dataset.act;
          if (act==="editProd"){
            const p = list.find(x=>x.id===id); if(!p) return;
            document.getElementById("panelCreateProd").style.display="block";
            document.getElementById("cpTitle").value = p.title||"";
            document.getElementById("cpDesc").value = p.description||"";
            document.getElementById("cpPrice").value = p.price||"";
            // category select
            document.getElementById("cpCatRoot").value = p.category_id || "";
            editingProdId = id;
          } else if (act==="delProd"){
            if(!confirm(`Удалить товар #${id}?`)) return;
            const r = await fetch(API_BASE+`/api/products/${id}`,{method:"DELETE",headers:headers(false,true)});
            if(!r.ok){ const t=await r.text(); return toast(parseErrorText(t)); }
            toast("Товар удалён"); await loadProducts();
          }
        });
      });
    }

    // Поиск и фильтры
    function applyFilters(){
      const q = document.getElementById("searchInput").value.trim().toLowerCase();
      let list = allProducts.slice();
      if (selectedCat){
        list = list.filter(p=>p.category_id === selectedCat);
      }
      if (q){
        list = list.filter(p=>
          (p.title && p.title.toLowerCase().includes(q)) ||
          (p.description && p.description.toLowerCase().includes(q))
        );
      }
      renderHome(list);
    }

    document.getElementById("searchInput").addEventListener("input", ()=>{
      applyFilters();
    });

    // Категории чипы
    function renderCatChips(){
      const line = document.getElementById("catChips");
      const roots = (catIndexByParent.get(null)||[]);
      if (!roots.length){ line.innerHTML=""; return; }
      line.innerHTML = roots.map(c=>`<button class="chip" data-id="${c.id}">${escapeHtml(c.name)}</button>`).join("");
      line.querySelectorAll(".chip").forEach(ch=>{
        ch.addEventListener("click", ()=>{
          const id = Number(ch.dataset.id);
          selectedCat = id;
          applyFilters();
          line.querySelectorAll(".chip").forEach(b=>b.classList.remove("active"));
          ch.classList.add("active");
        });
      });
    }

    // Админ: панели
    document.getElementById("btnOpenCreateProd").addEventListener("click", ()=>{
      document.getElementById("panelCreateProd").style.display="block";
      document.getElementById("panelCreateCat").style.display="none";
      editingProdId = null;
      document.getElementById("cpTitle").value="";
      document.getElementById("cpDesc").value="";
      document.getElementById("cpPrice").value="";
      document.getElementById("cpPreview").innerHTML="";
      document.getElementById("cpCatRoot").value="";
      document.getElementById("cpCatSub").value="";
      document.getElementById("cpSubcatsRow").style.display="none";
    });

    document.getElementById("btnOpenCreateCat").addEventListener("click", ()=>{
      document.getElementById("panelCreateProd").style.display="none";
      document.getElementById("panelCreateCat").style.display="block";
      editingCatId = null;
      document.getElementById("ccName").value="";
      document.getElementById("ccPreview").innerHTML="";
      document.getElementById("ccPreview").dataset.image="";
      document.getElementById("ccParent").value="";
    });

    // Загрузка изображений
    document.getElementById("cpImages").addEventListener("change", async (e)=>{
      const files = Array.from(e.target.files||[]);
      if (!files.length) return;
      const urls = [];
      for (const f of files.slice(0,5)){
        const url = await readFileAsDataUrl(f);
        urls.push(url);
      }
      document.getElementById("cpPreview").innerHTML = urls.map(u=>`<div class="thumb-up"><img src="${escapeHtml(u)}"></div>`).join("");
      document.getElementById("cpPreview").dataset.images = JSON.stringify(urls);
    });

    document.getElementById("ccImage").addEventListener("change", async (e)=>{
      const file = (e.target.files||[])[0];
      if (!file) return;
      const url = await readFileAsDataUrl(file);
      document.getElementById("ccPreview").dataset.image = url;
      document.getElementById("ccPreview").innerHTML = `<div class="thumb-up"><img src="${escapeHtml(url)}"></div>`;
    });

    function readFileAsDataUrl(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = ()=>resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // Изменение категорий для товара
    document.getElementById("cpCatRoot").addEventListener("change", ()=>{
      const rootId = document.getElementById("cpCatRoot").value;
      const row = document.getElementById("cpSubcatsRow");
      const subSelect = document.getElementById("cpCatSub");
      if (!rootId){
        row.style.display="none";
        subSelect.innerHTML='<option value="">— Выбери подкатегорию —</option>';
        return;
      }
      const children = catIndexByParent.get(Number(rootId))||[];
      if (!children.length){
        row.style.display="none";
        subSelect.innerHTML='<option value="">— Выбери подкатегорию —</option>';
        return;
      }
      row.style.display="block";
      subSelect.innerHTML = '<option value="">— Выбери подкатегорию —</option>' + children.map(c=>`<option value="${c.id}">${escapeHtml(c.name)}</option>`).join("");
    });

    // Создание/редактирование товара
    document.getElementById("cpCreate").addEventListener("click", async ()=>{
      const title = document.getElementById("cpTitle").value.trim();
      const description = document.getElementById("cpDesc").value.trim();
      const price = Number(document.getElementById("cpPrice").value||0);
      const imagesRaw = document.getElementById("cpPreview").dataset.images || "[]";
      let images=[];
      try{ images = JSON.parse(imagesRaw||"[]"); }catch(e){ images=[]; }

      const rootId = document.getElementById("cpCatRoot").value;
      const subId = document.getElementById("cpCatSub").value;
      const category_id = subId ? Number(subId) : (rootId ? Number(rootId) : null);

      if (!title) return toast("Укажи название товара");
      if (!price || price<=0) return toast("Укажи цену товара");

      const payload = {
        title,
        slug: slugify(title),
        description,
        price,
        currency: "RUB",
        stock: 0,
        is_active: true,
        images,
        attributes: { owner_tg_id: tgId },
        category_id
      };

      try{
        if (editingProdId){
          const r = await apiSend("PATCH", `/api/products/${editingProdId}`, payload, true);
          toast(`Товар #${r.id||editingProdId} сохранён`);
        } else {
          const r = await apiSend("POST","/api/products",payload,true);
          toast(`Товар #${r.id} создан`);
        }
        await loadProducts();
      }catch(e){ toast(e.message||"Ошибка сохранения товара"); }
    });

    // Создание/редактирование категории
    document.getElementById("ccCreate").addEventListener("click", async ()=>{
      const name = document.getElementById("ccName").value.trim();
      if (!name) return toast("Укажи название категории");
      const parentRaw = document.getElementById("ccParent").value.trim();
      const parent_id = parentRaw ? Number(parentRaw) : null;
      const image = document.getElementById("ccPreview").dataset.image || null;

      const baseSlug = slugify(name);
      const slug = parent_id ? slugify(name + "-" + String(parent_id)) : baseSlug;

      const payload = {
        name,
        slug,
        parent_id,
        attributes: { owner_tg_id: tgId, ...(image?{image}: {}) }
      };

      try{
        if (editingCatId){
          const r = await apiSend("PATCH", `/api/categories/${editingCatId}`, payload, true);
          toast(`Категория #${r.id||editingCatId} сохранена`);
        } else {
          const r = await apiSend("POST","/api/categories",payload,true);
          toast(`Категория #${r.id} создана`);
        }
        await loadCategories();
      }catch(e){ toast(e.message||"Ошибка сохранения категории"); }
    });

    // Переключатели видимости списков в админке
    const btnToggleCats = document.getElementById("toggleCatsList");
    if (btnToggleCats){
      btnToggleCats.addEventListener("click", ()=>{
        adminCatsVisible = !adminCatsVisible;
        renderAdminCats();
      });
    }
    const btnToggleProds = document.getElementById("toggleProdsList");
    if (btnToggleProds){
      btnToggleProds.addEventListener("click", ()=>{
        adminProdsVisible = !adminProdsVisible;
        renderAdminProds();
      });
    }

    // ───────── Utils
    function slugify(v){
      return (v||"").toLowerCase().trim()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"-")
        .replace(/-+/g,"-").replace(/^-|-$/g,"") || "item";
    }

    // Checkout
    document.getElementById("btnCheckout").addEventListener("click", ()=>{
      if (!cart.size) return toast("Корзина пуста");
      const items = [...cart.entries()].map(([id,qty])=>{
        const p = allProducts.find(x=>x.id===id);
        return p ? {id, title:p.title, qty, price:p.price} : null;
      }).filter(Boolean);
      if (tg){
        tg.showPopup({
          title:"Заказ оформлен",
          message:"Это демо. Здесь можно интегрировать оплату и создание заказа.\n\nТовары:\n" + items.map(i=>`${i.title} × ${i.qty}`).join("\n"),
          buttons:[{type:"close",text:"Ок"}]
        });
      } else {
        alert("Demo order:\n" + items.map(i=>`${i.title} × ${i.qty}`).join("\n"));
      }
    });

    // Init
    (async function init(){
      try{
        await ensureUser();
        await loadCategories();
        await loadProducts();
        renderCatChips();
        applyFilters();
      }catch(e){
        console.error(e);
        toast(e.message||"Ошибка инициализации");
      }
    })();
  })();
</script>
</body>
</html>
