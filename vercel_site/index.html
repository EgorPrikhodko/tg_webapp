<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>TG Shop ¬∑ WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0f1a; --bg2:#0f1424; --card:#12182a; --muted:#1a2036;
      --text:#e9ecff; --subtext:#9aa3c2; --accent:#6ea8ff; --accent-2:#8b7dff;
      --ok:#2dd4bf; --warn:#ffc857; --err:#ff6b6b; --info:#67e8f9;
      --icon:#a5aec9; --icon-active:#ffffff;
      --radius:16px; --radius-sm:12px; --shadow:0 12px 36px rgba(0,0,0,.45);
      --border:1px solid rgba(255,255,255,.06);
      --grad:linear-gradient(135deg, rgba(110,168,255,.20), rgba(139,125,255,.15));
      --glow:0 0 0 2px rgba(110,168,255,.25), 0 10px 30px rgba(110,168,255,.15);
      --badge:#ff2f8e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:
        radial-gradient(1200px 600px at -10% -10%, rgba(139,125,255,.15), transparent 60%),
        radial-gradient(1000px 600px at 110% -10%, rgba(103,232,249,.12), transparent 60%),
        radial-gradient(1200px 800px at 50% 120%, rgba(110,168,255,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
    }

    /* SVG icons */
    .icv{width:22px;height:22px;fill:var(--icon);display:block}
    .muted-ic .icv{fill:var(--icon)}
    .active-ic .icv{fill:var(--icon-active)}

    .wrap{max-width:760px;margin:0 auto;padding:12px 12px 84px}
    .topbar{
      position:sticky;top:0;z-index:10;padding:10px 12px;margin:-12px -12px 10px;
      background:linear-gradient(180deg, rgba(11,15,26,.92), rgba(11,15,26,.75) 60%, transparent);
      backdrop-filter:saturate(1.3) blur(6px);
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .search{
      flex:1;background:#0b1022;border:1px solid #27314d;border-radius:14px;padding:10px 12px;color:var(--text);outline:none;
    }
    .pill{display:none;background:var(--muted);padding:8px 10px;border-radius:999px;color:var(--subtext);border:var(--border);font-size:12px;gap:8px;align-items:center}
    .pill .ok{width:10px;height:10px;border-radius:50%;background:var(--ok)}

    /* grid like Ozon */
    .grid{display:grid;gap:10px}
    .grid.cards{grid-template-columns:1fr 1fr}
    @media(min-width:560px){ .grid.cards{grid-template-columns:1fr 1fr 1fr} }

    .card{
      background:linear-gradient(180deg, rgba(18,24,42,.95), rgba(12,16,30,.92));
      border-radius:16px;border:var(--border);overflow:hidden;position:relative
    }
    .card .pic{
      width:100%;padding-top:100%;background:#0f1430;position:relative;overflow:hidden
    }
    .card .pic img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .card .fav{
      position:absolute;top:8px;right:8px;z-index:2;background:rgba(17,22,42,.7);
      border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(4px);border-radius:999px;padding:6px;cursor:pointer
    }
    .card .fav .icv{fill:var(--icon)}
    .card .fav[aria-pressed="true"] .icv{fill:#d9deee} /* –∞–∫—Ç–∏–≤–Ω–æ–µ ‚Äì –≤—Å—ë –µ—â—ë –º–æ–Ω–æ—Ö—Ä–æ–º */

    .card .cnt{padding:10px 10px 12px}
    .title{font-size:13px;line-height:1.25;margin:0 0 6px;min-height:2.5em}
    .price-row{display:flex;align-items:baseline;gap:8px;flex-wrap:wrap}
    .price{font-weight:800;font-size:15px}
    .old{color:#939bb7;text-decoration:line-through;font-size:12px}
    .badge{font-size:11px;padding:3px 6px;border-radius:8px;border:1px solid #2a335e;background:#0f1430}
    .rating{font-size:12px;color:#cbd3ff;margin-top:6px;display:flex;align-items:center;gap:6px}
    .add{margin-top:8px;width:100%;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;border:none;padding:9px 10px;border-radius:12px;font-weight:700;cursor:pointer}

    /* screens */
    .screen{display:none}
    .screen.active{display:block}

    /* bottom bar */
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;z-index:20;background:#0c1122;border-top:1px solid #232d4d;
      display:grid;grid-template-columns:repeat(5,1fr);gap:4px;padding:6px 6px calc(env(safe-area-inset-bottom,0) + 6px);
    }
    .tabbar.admin{grid-template-columns:repeat(6,1fr)}
    .tabbtn{
      position:relative;display:flex;align-items:center;justify-content:center;padding:10px;border-radius:12px;border:1px solid transparent;background:transparent;cursor:pointer
    }
    .tabbtn[aria-selected="true"]{background:var(--grad);box-shadow:var(--glow);border:var(--border)}
    .tabbtn[aria-selected="true"] .icv{fill:var(--icon-active)}

    /* cart badge like screenshot */
    .tabbtn .badge-dot{
      position:absolute;right:6px;top:4px;min-width:20px;height:20px;padding:0 6px;border-radius:999px;background:var(--badge);color:#fff;
      font-weight:800;font-size:12px;display:none;align-items:center;justify-content:center;line-height:1;border:2px solid #0c1122;
    }

    /* simple lists */
    .empty{color:var(--subtext);padding:10px 2px}
    .line{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;background:#0f1430;border:1px solid #28306b}
    .line .thumb{width:54px;height:54px;border-radius:10px;background:#121735;overflow:hidden}
    .line .thumb img{width:100%;height:100%;object-fit:cover}
    .line .t{flex:1}
    .muted{opacity:.85}

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:72px;background:#11162a;
      border:1px solid #253058;color:var(--text);padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:50;display:none;max-width:86%;
    }
    .toast.show{display:block;animation:pop .25s ease}
    @keyframes pop{from{transform:translateX(-50%) translateY(6px);opacity:.5} to{transform:translateX(-50%) translateY(0);opacity:1}}
  </style>

  <!-- SVG sprite (–º–æ–Ω–æ—Ö—Ä–æ–º) -->
  <svg width="0" height="0" style="position:absolute">
    <symbol id="i-home" viewBox="0 0 24 24"><path d="M4 10.5 12 4l8 6.5V20a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1v-9.5Z"/></symbol>
    <symbol id="i-grid" viewBox="0 0 24 24"><path d="M3 3h8v8H3V3Zm10 0h8v8h-8V3ZM3 13h8v8H3v-8Zm10 0h8v8h-8v-8Z"/></symbol>
    <symbol id="i-heart" viewBox="0 0 24 24"><path d="M12 21s-6.5-4.4-8.6-7.4A5.5 5.5 0 0 1 12 6a5.5 5.5 0 0 1 8.6 7.6C18.5 16.6 12 21 12 21Z"/></symbol>
    <symbol id="i-basket" viewBox="0 0 24 24"><path d="M7 10l5-7 5 7m-12 0h14l-1.6 9.2A2 2 0 0 1 15.5 21h-7a2 2 0 0 1-1.9-1.8L5 10Z"/></symbol>
    <symbol id="i-user" viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm7 8a7 7 0 0 0-14 0"/></symbol>
    <symbol id="i-edit" viewBox="0 0 24 24"><path d="M3 17.3 14.7 5.6l3.7 3.7L6.7 21H3v-3.7ZM16.8 3.6l3.6 3.6"/></symbol>
  </svg>
</head>
<body>
  <div class="wrap">

    <!-- Top search + admin-only DB pill -->
    <div class="topbar">
      <div class="row">
        <input id="search" class="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º‚Ä¶" />
        <div id="pillDb" class="pill">
          <span class="ok"></span><span>–ë–î: –æ–∫</span>
        </div>
      </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–∞—è -->
    <section id="scr_home" class="screen active">
      <div class="grid cards" id="homeGrid"></div>
      <div class="empty" id="homeEmpty" style="display:none">–ü–æ–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç‚Ä¶</div>
    </section>

    <!-- –ö–∞—Ç–∞–ª–æ–≥ -->
    <section id="scr_catalog" class="screen">
      <div class="row" style="margin:6px 0 10px">
        <select id="selCat" class="search" style="max-width:100%"><option value="">‚Äî –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî</option></select>
      </div>
      <div class="grid cards" id="catGrid"></div>
      <div class="empty" id="catEmpty" style="display:none">–í –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç‚Ä¶</div>
    </section>

    <!-- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
    <section id="scr_fav" class="screen">
      <div class="grid cards" id="favGrid"></div>
      <div class="empty" id="favEmpty" style="display:none">–î–æ–±–∞–≤–ª—è–π—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
    </section>

    <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
    <section id="scr_cart" class="screen">
      <div id="cartList" class="grid"></div>
      <div class="empty" id="cartEmpty" style="display:none">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
      <div id="cartTotal" class="line" style="margin-top:10px;display:none">
        <div class="t"><b>–ò—Ç–æ–≥–æ:</b> <span id="sumText">0</span></div>
        <button id="btnCheckout" class="add" style="max-width:220px">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
      </div>
    </section>

    <!-- –ê–∫–∫–∞—É–Ω—Ç -->
    <section id="scr_account" class="screen">
      <div class="line">
        <div class="t">
          <div><b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> <span id="whoAmI">–ì–æ—Å—Ç—å</span></div>
          <div class="muted" id="whoRole">–†–µ–∂–∏–º: –≥–æ—Å—Ç—å</div>
        </div>
        <button id="btnResetLocal" class="add" style="max-width:160px;background:#44506f">–°–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
      </div>
      <div style="height:8px"></div>
      <div class="line">
        <div class="t">
          <div class="muted">API:</div>
          <div style="word-break:break-all" id="apiShown"></div>
        </div>
        <button id="btnChangeApi" class="add" style="max-width:160px">–°–º–µ–Ω–∏—Ç—å API</button>
      </div>
    </section>

    <!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–∞–¥–º–∏–Ω) ‚Äî –∑–∞–≥–ª—É—à–∫–∞ -->
    <section id="scr_admin" class="screen">
      <div class="empty">–ê–¥–º–∏–Ω-—Ä–µ–∂–∏–º: —Å—é–¥–∞ –≤—ã–Ω–µ—Å–µ–º CRUD.</div>
    </section>
  </div>

  <!-- Bottom Tabbar (icons only) -->
  <nav id="tabbar" class="tabbar">
    <button class="tabbtn active-ic" data-scr="home" aria-selected="true" title="–ì–ª–∞–≤–Ω–∞—è"><svg class="icv"><use href="#i-home"/></svg></button>
    <button class="tabbtn muted-ic" data-scr="catalog" title="–ö–∞—Ç–∞–ª–æ–≥"><svg class="icv"><use href="#i-grid"/></svg></button>
    <button class="tabbtn muted-ic" data-scr="fav" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"><svg class="icv"><use href="#i-heart"/></svg></button>
    <button class="tabbtn muted-ic" data-scr="cart" title="–ö–æ—Ä–∑–∏–Ω–∞" id="tabCart">
      <svg class="icv"><use href="#i-basket"/></svg>
      <span class="badge-dot" id="cartBadge">0</span>
    </button>
    <button class="tabbtn muted-ic" data-scr="account" title="–ê–∫–∫–∞—É–Ω—Ç"><svg class="icv"><use href="#i-user"/></svg></button>
    <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
  </nav>

  <div class="toast" id="toast"></div>

  <script>
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ API base
    const url = new URL(location.href);
    const qpApi = url.searchParams.get("api");
    const API_BASE = (() => {
      if (qpApi) return qpApi.replace(/\/+$/, "");
      return "http://127.0.0.1:9010";
    })();
    document.getElementById("apiShown").textContent = API_BASE;

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Telegram ID / admin
    let tgId = null, isAdmin = false;
    try { tgId = Telegram?.WebApp?.initDataUnsafe?.user?.id || null; } catch(e){}
    if (!tgId) {
      const saved = localStorage.getItem("debug_tg_id");
      if (saved) tgId = parseInt(saved,10);
    }
    const whoEl = document.getElementById("whoAmI");
    const roleEl = document.getElementById("whoRole");
    if (tgId) whoEl.textContent = String(tgId);

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helpers
    class ApiError extends Error{ constructor(status, message, raw){ super(message); this.status=status; this.raw=raw; } }
    function headers(json=true, withTg=false){
      const h={}; if(json) h["Content-Type"]="application/json"; if(withTg && tgId) h["X-Telegram-Id"]=String(tgId); return h;
    }
    function parseErrorText(text){
      if (!text) return "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞";
      try{ const j=JSON.parse(text);
        if (j.detail){ if (typeof j.detail==="string") return j.detail; if (Array.isArray(j.detail)) return j.detail.map(x=>x.msg||x.detail||JSON.stringify(x)).join("; "); if (j.detail.message) return j.detail.message; }
        if (j.message) return j.message; return typeof j==="string"?j:JSON.stringify(j);
      }catch{ return text; }
    }
    async function apiGet(path, params) {
      const u = new URL(API_BASE + path);
      if (params) Object.entries(params).forEach(([k,v]) => (v ?? v===0) && u.searchParams.set(k,v));
      const r = await fetch(u); const t = await r.text(); if(!r.ok) throw new ApiError(r.status, parseErrorText(t), t); return t?JSON.parse(t):null;
    }
    async function apiSend(method, path, body=null, withTg=false){
      const r = await fetch(API_BASE+path,{method,headers:headers(true,withTg),body:body?JSON.stringify(body):null});
      const t=await r.text(); if(!r.ok) throw new ApiError(r.status, parseErrorText(t), t); return t?JSON.parse(t):null;
    }
    function toast(msg){ const el=document.getElementById("toast"); el.textContent=msg; el.className="toast show"; setTimeout(()=>el.className="toast",2200); }
    function money(v,c="RUB"){ return `${Number(v||0).toFixed(0)} ${c}`; }
    function escapeHtml(s){ return String(s).replace(/[&<>"'`]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])); }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ state (favorites, cart)
    const favKey="tgshop_fav_ids"; const cartKey="tgshop_cart";
    let fav = new Set(JSON.parse(localStorage.getItem(favKey)||"[]"));
    let cart = new Map(Object.entries(JSON.parse(localStorage.getItem(cartKey)||"{}")).map(([k,v])=>[Number(k),Number(v)]));

    function saveFav(){ localStorage.setItem(favKey, JSON.stringify([...fav])); }
    function saveCart(){ localStorage.setItem(cartKey, JSON.stringify(Object.fromEntries(cart))); }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ render: product card
    function productCard(p){
      const img = (Array.isArray(p.images) && p.images[0]) ? p.images[0] : "";
      const currency = (p.currency||"RUB").toUpperCase();
      const old = p.attributes?.old_price ?? null;
      const rating = p.attributes?.rating ?? null;
      const rcnt = p.attributes?.ratings_count ?? null;
      const liked = fav.has(p.id);
      return `
        <div class="card" data-id="${p.id}">
          <div class="pic">
            ${img?`<img alt="" src="${escapeHtml(img)}">`:``}
            <button class="fav" aria-pressed="${liked?'true':'false'}" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">
              <svg class="icv"><use href="#i-heart"/></svg>
            </button>
          </div>
          <div class="cnt">
            <div class="title">${escapeHtml(p.title||"–¢–æ–≤–∞—Ä")}</div>
            <div class="price-row">
              <div class="price">${money(p.price, currency)}</div>
              ${old?`<div class="old">${money(old,currency)}</div><span class="badge">-${Math.max(0, Math.round(100-(p.price/old*100)))}%</span>`:""}
            </div>
            ${rating?`<div class="rating">‚òÖ ${Number(rating).toFixed(1)} ${rcnt?`¬∑ ${rcnt} –æ—Ç–∑—ã–≤–æ–≤`:""}</div>`:""}
            <button class="add">–í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>
      `;
    }

    // attach handlers to a rendered grid
    function bindCardHandlers(rootEl, list){
      rootEl.querySelectorAll(".card").forEach(card=>{
        const id = Number(card.dataset.id);
        card.querySelector(".fav")?.addEventListener("click", (e)=>{
          e.stopPropagation();
          if (fav.has(id)) fav.delete(id); else fav.add(id);
          saveFav();
          e.currentTarget.setAttribute("aria-pressed", fav.has(id) ? "true" : "false");
          renderFav(); // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤–∫–ª–∞–¥–∫—É –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
        });
        card.querySelector(".add")?.addEventListener("click", ()=>{
          cart.set(id, (cart.get(id)||0)+1); saveCart(); toast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É"); updateCartBadge();
        });
      });
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ screens/nav
    const screens = {
      home: document.getElementById("scr_home"),
      catalog: document.getElementById("scr_catalog"),
      fav: document.getElementById("scr_fav"),
      cart: document.getElementById("scr_cart"),
      account: document.getElementById("scr_account"),
      admin: document.getElementById("scr_admin"),
    };
    function show(scr){
      Object.entries(screens).forEach(([k,el])=>el.classList.toggle("active", k===scr));
      document.querySelectorAll(".tabbtn").forEach(b=>{
        const selected = b.dataset.scr===scr;
        b.setAttribute("aria-selected", selected ? "true":"false");
        b.classList.toggle("active-ic", selected);
        b.classList.toggle("muted-ic", !selected);
      });
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ fetch data + renders
    let allProducts = [];
    async function refreshHealth(){
      const pill = document.getElementById("pillDb");
      try{
        const h = await apiGet("/health/db");
        const ok = (h?.db==="ok") || (h?.status==="ok");
        if (isAdmin && ok){ pill.style.display="inline-flex"; } // —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º
        else { pill.style.display="none"; }
      }catch{ pill.style.display = isAdmin ? "inline-flex" : "none"; }
    }
    async function ensureUser(){
      if (!tgId) return;
      try{
        const u = await apiSend("POST","/api/users/ensure",{tg_id:tgId},true);
        isAdmin = !!u.is_admin;
        roleEl.textContent = isAdmin ? "–†–µ–∂–∏–º: –∞–¥–º–∏–Ω" : "–†–µ–∂–∏–º: –≥–æ—Å—Ç—å";
        // –∫–Ω–æ–ø–∫–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ" –≤ —Ç–∞–±–±–∞—Ä
        if (isAdmin && !document.querySelector('.tabbtn[data-scr="admin"]')){
          const tb=document.getElementById("tabbar"); tb.classList.add("admin");
          const btn=document.createElement("button");
          btn.className="tabbtn muted-ic"; btn.dataset.scr="admin"; btn.title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
          btn.innerHTML='<svg class="icv"><use href="#i-edit"/></svg>';
          tb.appendChild(btn);
          btn.addEventListener("click",()=>show("admin"));
        }
      }catch(e){ console.warn("ensure user failed",e); }
    }
    async function loadCategories(){
      const cats = await apiGet("/api/categories");
      const sel = document.getElementById("selCat");
      sel.innerHTML = '<option value="">‚Äî –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî</option>' + cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)} (#${c.id})</option>`).join("");
      return cats;
    }
    async function loadProducts(params){
      const list = await apiGet("/api/products", params);
      allProducts = list;
      renderHome(list);
      renderCatalog(list);
      renderFav();
      renderCart();
      updateCartBadge();
    }

    // renders
    function renderHome(list){
      const g=document.getElementById("homeGrid"), e=document.getElementById("homeEmpty");
      if (!list.length){ g.innerHTML=""; e.style.display="block"; return; }
      e.style.display="none";
      g.innerHTML = list.map(productCard).join("");
      bindCardHandlers(g,list);
    }
    function renderCatalog(list){
      const sel = document.getElementById("selCat").value.trim();
      const filtered = sel ? list.filter(p=>String(p.category_id)===sel) : list;
      const g=document.getElementById("catGrid"), e=document.getElementById("catEmpty");
      if (!filtered.length){ g.innerHTML=""; e.style.display="block"; return; }
      e.style.display="none"; g.innerHTML = filtered.map(productCard).join(""); bindCardHandlers(g,filtered);
    }
    function renderFav(){
      const arr = allProducts.filter(p=>fav.has(p.id));
      const g=document.getElementById("favGrid"), e=document.getElementById("favEmpty");
      if(!arr.length){ g.innerHTML=""; e.style.display="block"; return; }
      e.style.display="none"; g.innerHTML = arr.map(productCard).join(""); bindCardHandlers(g,arr);
    }
    function renderCart(){
      const listEl = document.getElementById("cartList");
      const empty = document.getElementById("cartEmpty");
      const panel = document.getElementById("cartTotal");
      const sumEl = document.getElementById("sumText");
      const items = [...cart.entries()].map(([id,q])=>{
        const p = allProducts.find(x=>x.id===id); return p?{p,q}:null;
      }).filter(Boolean);
      if(!items.length){ listEl.innerHTML=""; empty.style.display="block"; panel.style.display="none"; return; }
      empty.style.display="none"; panel.style.display="flex";
      let sum=0, curr="RUB";
      listEl.innerHTML = items.map(({p,q})=>{
        sum += (Number(p.price)||0)*q; curr = (p.currency||"RUB").toUpperCase();
        const img = (Array.isArray(p.images)&&p.images[0])?p.images[0]:"";
        return `
          <div class="line" data-id="${p.id}">
            <div class="thumb">${img?`<img src="${escapeHtml(img)}" alt="">`:""}</div>
            <div class="t">
              <div><b>${escapeHtml(p.title)}</b></div>
              <div class="muted">${money(p.price,curr)} ¬∑ –ö–æ–ª-–≤–æ: <b>${q}</b></div>
            </div>
            <div class="row" style="gap:6px">
              <button class="tabbtn" data-act="dec"><svg class="icv"><use href="#i-minus"/></svg>‚àí</button>
              <button class="tabbtn" data-act="inc"><svg class="icv"><use href="#i-plus"/></svg>+</button>
              <button class="tabbtn" data-act="del"><svg class="icv"><use href="#i-trash"/></svg>üóë</button>
            </div>
          </div>
        `;
      }).join("");
      sumEl.textContent = money(sum, curr);
      listEl.querySelectorAll(".line").forEach(line=>{
        const id = Number(line.dataset.id);
        line.querySelectorAll("[data-act]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const act=b.dataset.act;
            if (act==="inc"){ cart.set(id,(cart.get(id)||0)+1); }
            else if (act==="dec"){ const n=(cart.get(id)||0)-1; if (n>0) cart.set(id,n); else cart.delete(id); }
            else if (act==="del"){ cart.delete(id); }
            saveCart(); renderCart(); updateCartBadge();
          });
        });
      });
    }

    // —Ç–æ–ª—å–∫–æ –∫–æ—Ä–∑–∏–Ω–∞ –∏–º–µ–µ—Ç —Å—á—ë—Ç—á–∏–∫
    function updateCartBadge(){
      const cartCount = [...cart.values()].reduce((a,b)=>a+b,0);
      const badge = document.getElementById("cartBadge");
      if (cartCount>0){ badge.style.display="flex"; badge.textContent=String(cartCount); }
      else { badge.style.display="none"; }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ events
    document.getElementById("selCat").addEventListener("change",()=>renderCatalog(allProducts));
    document.getElementById("search").addEventListener("input", (e)=>{
      const q = e.target.value.trim();
      const params = q ? { q } : undefined;
      loadProducts(params);
    });
    document.getElementById("btnResetLocal").addEventListener("click", ()=>{
      localStorage.removeItem(favKey); localStorage.removeItem(cartKey);
      fav = new Set(); cart = new Map(); renderFav(); renderCart(); updateCartBadge(); toast("–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã");
    });
    document.getElementById("btnChangeApi").addEventListener("click", ()=>{
      const v = prompt("–£–∫–∞–∂–∏ –Ω–æ–≤—ã–π API Base URL", API_BASE); if(!v) return;
      const u = new URL(location.href); u.searchParams.set("api", v); location.href=u.toString();
    });

    document.querySelectorAll(".tabbtn").forEach(btn=>{
      btn.addEventListener("click", ()=> show(btn.dataset.scr));
    });

    document.getElementById("btnCheckout").addEventListener("click", ()=>{
      if (!cart.size) return;
      toast("–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω (–∑–∞–≥–ª—É—à–∫–∞)");
    });

    // tap-to-dismiss keyboard everywhere
    ['pointerdown','touchstart'].forEach(evt=>{
      document.addEventListener(evt, (e)=>{
        const el = e.target;
        const tag = (el?.tagName||"").toLowerCase();
        const isInput = ['input','textarea','select'].includes(tag) || el?.isContentEditable;
        if (!isInput && document.activeElement && (['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName) || document.activeElement.isContentEditable)){
          document.activeElement.blur();
        }
      }, {passive:true});
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ init
    async function init(){
      await ensureUser();
      await refreshHealth(); // –ø–æ—Å–ª–µ ensureUser, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ª–∏ –∞–¥–º–∏–Ω-–ø–∏–ª—é–ª—é
      await loadCategories();
      await loadProducts();
      show('home');
    }
    init();
  </script>

  <!-- –Ω–µ–±–æ–ª—å—à–∏–µ –º–æ–Ω–æ—Ö—Ä–æ–º–Ω—ã–µ –∏–∫–æ–Ω–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –∫–æ—Ä–∑–∏–Ω–µ -->
  <svg width="0" height="0" style="position:absolute">
    <symbol id="i-plus" viewBox="0 0 24 24"><path d="M11 5h2v14h-2z"/><path d="M5 11h14v2H5z"/></symbol>
    <symbol id="i-minus" viewBox="0 0 24 24"><path d="M5 11h14v2H5z"/></symbol>
    <symbol id="i-trash" viewBox="0 0 24 24"><path d="M6 7h12l-1 13a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2L6 7Zm3-3h6l1 3H8l1-3Z"/></symbol>
  </svg>
</body>
</html>
