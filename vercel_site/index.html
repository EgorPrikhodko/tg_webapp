<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f1a" />
  <title>TG Shop ¬∑ WebApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#0b0f1a; --card:#12182a; --muted:#1a2036;
      --text:#e9ecff; --subtext:#9aa3c2; --accent:#6ea8ff; --accent-2:#8b7dff;
      --ok:#2dd4bf; --icon:#a5aec9; --icon-active:#ffffff;
      --radius:16px; --radius-sm:12px; --shadow:0 12px 36px rgba(0,0,0,.45);
      --border:1px solid rgba(255,255,255,.06);
      --badge:#ff2f8e;

      --card-content-h: 168px; /* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg) !important; /* –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–π —Ñ–æ–Ω, –±–µ–∑ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤ */
      color:var(--text);
      font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
      -webkit-tap-highlight-color:transparent;
    }

    /* SVG icons */
    .icv{width:22px;height:22px;fill:var(--icon);display:block}
    .muted-ic .icv{fill:var(--icon)}
    .active-ic .icv{fill:var(--icon-active)}

    .wrap{max-width:820px;margin:0 auto;padding:12px 12px 84px}
    .topbar{
      position:sticky;top:0;z-index:10;padding:10px 12px;margin:-12px -12px 10px;
      background:rgba(11,15,26,.95); backdrop-filter:saturate(1.2) blur(6px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .search{
      flex:1;background:#0b1022;border:1px solid #27314d;border-radius:14px;padding:10px 12px;color:var(--text);outline:none;
    }
    .search:focus{background:#0b1022;border-color:#2e3b62;box-shadow:0 0 0 2px rgba(62,102,255,.14)}
    input:-webkit-autofill,input:-webkit-autofill:focus{transition:background-color 99999s ease-in-out 0s}

    .pill{display:none;background:var(--muted);padding:8px 10px;border-radius:999px;color:var(--subtext);border:var(--border);font-size:12px;gap:8px;align-items:center}
    .pill .ok{width:10px;height:10px;border-radius:50%;background:var(--ok)}

    /* grid like Ozon */
    .grid{display:grid;gap:10px}
    .grid.cards{grid-template-columns:1fr 1fr}
    @media(min-width:560px){ .grid.cards{grid-template-columns:1fr 1fr 1fr} }

    .card{
      display:flex;flex-direction:column;background:#11172a;border-radius:16px;border:var(--border);overflow:hidden;position:relative
    }
    .card .pic{
      width:100%;padding-top:100%;background:#0f1430;position:relative;overflow:hidden;flex:0 0 auto;
    }
    .card .pic img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
    .card .fav{
      position:absolute;top:8px;right:8px;z-index:2;background:rgba(17,22,42,.7);
      border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(4px);border-radius:999px;padding:6px;cursor:pointer
    }
    .card .fav .icv{fill:var(--icon)}
    .card .fav[aria-pressed="true"] .icv{fill:var(--badge)} /* –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–µ—Ä–¥–µ—á–∫–æ ‚Äî —Ä–æ–∑–æ–≤–æ–µ */

    .card .cnt{
      padding:10px 10px 12px;display:flex;flex-direction:column;gap:6px;
      min-height:var(--card-content-h);flex:1 1 auto;
    }
    .title{
      font-size:13px;line-height:1.25;margin:0;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2.6em;
    }
    .desc{
      color:#c9cff1;font-size:12px;opacity:.9;
      display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;min-height:2.4em;
    }
    .price-row{display:flex;align-items:baseline;gap:8px;flex-wrap:wrap}
    .price{font-weight:800;font-size:15px}
    .old{color:#939bb7;text-decoration:line-through;font-size:12px}
    .badge{font-size:11px;padding:3px 6px;border-radius:8px;border:1px solid #2a335e;background:#0f1430}
    .rating{font-size:12px;color:#cbd3ff;display:flex;align-items:center;gap:6px;min-height:1.2em}
    .rating .star{width:14px;height:14px;display:inline-block}
    .add{margin-top:auto;width:100%;background:linear-gradient(135deg,var(--accent),var(--accent-2));color:#fff;border:none;padding:9px 10px;border-radius:12px;font-weight:700;cursor:pointer}

    /* screens */
    .screen{display:none}
    .screen.active{display:block}

    /* bottom bar */
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;z-index:20;background:#0c1122;border-top:1px solid #232d4d;
      display:grid;grid-template-columns:repeat(5,1fr);gap:4px;padding:6px 6px calc(env(safe-area-inset-bottom,0) + 6px);
    }
    .tabbar.admin{grid-template-columns:repeat(6,1fr)}
    .tabbtn{
      position:relative;display:flex;align-items:center;justify-content:center;padding:10px;border-radius:12px;border:1px solid transparent;background:transparent;cursor:pointer
    }
    .tabbtn[aria-selected="true"]{background:rgba(110,168,255,.12);border:var(--border)}
    .tabbtn[aria-selected="true"] .icv{fill:var(--icon-active)}
    .tabbtn .badge-dot{
      position:absolute;right:6px;top:4px;min-width:20px;height:20px;padding:0 6px;border-radius:999px;background:var(--badge);color:#fff;
      font-weight:800;font-size:12px;display:none;align-items:center;justify-content:center;line-height:1;border:2px solid #0c1122;
    }

    /* Catalog (–ø–ª–∏—Ç–∫–∏ + —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π) */
    .cat-tiles{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(min-width:560px){ .cat-tiles{grid-template-columns:1fr 1fr 1fr} }
    .cat-tile{
      background:#1a2033;border:1px solid rgba(255,255,255,.06);border-radius:14px;position:relative;overflow:hidden;
      padding:12px;min-height:110px;display:flex;align-items:flex-end;justify-content:space-between;gap:8px;cursor:pointer;
    }
    .cat-tile .tt{font-weight:600}
    .cat-tile .img{
      position:absolute;right:6px;bottom:0;width:60%;height:80%;opacity:.9;pointer-events:none;mask-image:linear-gradient(to top,black 65%, transparent)
    }
    .cat-back{display:flex;align-items:center;gap:8px;margin:2px 0 10px}
    .cat-back button{background:#1a2033;border:1px solid rgba(255,255,255,.1);color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
    .sub-list{display:flex;flex-direction:column;gap:8px}
    .sub-item{display:flex;align-items:center;gap:12px;background:#161c2e;border:1px solid rgba(255,255,255,.06);padding:10px;border-radius:14px;cursor:pointer}
    .sub-item .thumb{width:52px;height:52px;border-radius:12px;background:#0f1430;overflow:hidden;flex:0 0 auto}
    .sub-item .thumb img{width:100%;height:100%;object-fit:cover}

    .empty{color:var(--subtext);padding:10px 2px}
    .line{display:flex;align-items:center;gap:10px;padding:10px;border-radius:12px;background:#0f1430;border:1px solid #28306b}
    .line .thumb{width:54px;height:54px;border-radius:10px;background:#121735;overflow:hidden}
    .line .thumb img{width:100%;height:100%;object-fit:cover}
    .line .t{flex:1}
    .muted{opacity:.85}

    .toast{
      position:fixed;left:50%;transform:translateX(-50%);bottom:72px;background:#11162a;border:1px solid #253058;color:var(--text);
      padding:12px 14px;border-radius:12px;box-shadow:var(--shadow);z-index:50;display:none;max-width:86%;
    }
    .toast.show{display:block;animation:pop .25s ease}
    @keyframes pop{from{transform:translateX(-50%) translateY(6px);opacity:.5} to{transform:translateX(-50%) translateY(0);opacity:1}}
  </style>

  <!-- SVG sprite (–º–æ–Ω–æ—Ö—Ä–æ–º) -->
  <svg width="0" height="0" style="position:absolute">
    <symbol id="i-home" viewBox="0 0 24 24"><path d="M4 10.5 12 4l8 6.5V20a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1v-9.5Z"/></symbol>
    <symbol id="i-grid" viewBox="0 0 24 24"><path d="M3 3h8v8H3V3Zm10 0h8v8h-8V3ZM3 13h8v8H3v-8Zm10 0h8v8h-8v-8Z"/></symbol>
    <symbol id="i-heart" viewBox="0 0 24 24"><path d="M12 21s-6.5-4.4-8.6-7.4A5.5 5.5 0 0 1 12 6a5.5 5.5 0 0 1 8.6 7.6C18.5 16.6 12 21 12 21Z"/></symbol>
    <symbol id="i-basket" viewBox="0 0 24 24"><path d="M7 10l5-7 5 7m-12 0h14l-1.6 9.2A2 2 0 0 1 15.5 21h-7a2 2 0 0 1-1.9-1.8L5 10Z"/></symbol>
    <symbol id="i-user" viewBox="0 0 24 24"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm7 8a7 7 0 0 0-14 0"/></symbol>
    <symbol id="i-edit" viewBox="0 0 24 24"><path d="M3 17.3 14.7 5.6l3.7 3.7L6.7 21H3v-3.7ZM16.8 3.6l3.6 3.6"/></symbol>
  </svg>
</head>
<body>
  <div class="wrap">

    <!-- Top search + admin-only DB pill -->
    <div class="topbar">
      <div class="row">
        <input id="search" class="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–æ–≤–∞—Ä–∞–º‚Ä¶" />
        <div id="pillDb" class="pill">
          <span class="ok"></span><span>–ë–î: –æ–∫</span>
        </div>
      </div>
    </div>

    <!-- –ì–ª–∞–≤–Ω–∞—è -->
    <section id="scr_home" class="screen active">
      <div class="grid cards" id="homeGrid"></div>
      <div class="empty" id="homeEmpty" style="display:none">–ü–æ–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç‚Ä¶</div>
    </section>

    <!-- –ö–∞—Ç–∞–ª–æ–≥ -->
    <section id="scr_catalog" class="screen">
      <!-- –ø–ª–∏—Ç–∫–∏ –≤–µ—Ä—Ö–Ω–∏—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
      <div id="catTiles" class="cat-tiles"></div>
      <div id="catTilesEmpty" class="empty" style="display:none">–ö–∞—Ç–µ–≥–æ—Ä–∏–π –ø–æ–∫–∞ –Ω–µ—Ç‚Ä¶</div>

      <!-- —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π -->
      <div id="catSub" style="display:none">
        <div class="cat-back"><button id="btnCatBack">‚Üê –ù–∞–∑–∞–¥</button><div id="catPath" class="muted"></div></div>
        <div id="subList" class="sub-list"></div>
      </div>
    </section>

    <!-- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
    <section id="scr_fav" class="screen">
      <div class="grid cards" id="favGrid"></div>
      <div class="empty" id="favEmpty" style="display:none">–î–æ–±–∞–≤–ª—è–π—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
    </section>

    <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
    <section id="scr_cart" class="screen">
      <div id="cartList" class="grid"></div>
      <div class="empty" id="cartEmpty" style="display:none">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
      <div id="cartTotal" class="line" style="margin-top:10px;display:none">
        <div class="t"><b>–ò—Ç–æ–≥–æ:</b> <span id="sumText">0</span></div>
        <button id="btnCheckout" class="add" style="max-width:220px">–û—Ñ–æ—Ä–º–∏—Ç—å</button>
      </div>
    </section>

    <!-- –ê–∫–∫–∞—É–Ω—Ç -->
    <section id="scr_account" class="screen">
      <div class="line">
        <div class="t">
          <div><b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> <span id="whoAmI">–ì–æ—Å—Ç—å</span></div>
          <div class="muted" id="whoRole">–†–µ–∂–∏–º: –≥–æ—Å—Ç—å</div>
        </div>
        <button id="btnResetLocal" class="add" style="max-width:160px;background:#44506f">–°–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
      </div>
      <div style="height:8px"></div>
      <div class="line">
        <div class="t">
          <div class="muted">API:</div>
          <div style="word-break:break-all" id="apiShown"></div>
        </div>
        <button id="btnChangeApi" class="add" style="max-width:160px">–°–º–µ–Ω–∏—Ç—å API</button>
      </div>
    </section>

    <!-- –ê–¥–º–∏–Ω: CRUD -->
    <section id="scr_admin" class="screen">
      <div class="grid" style="gap:12px">
        <div class="line" style="flex-direction:column;align-items:stretch">
          <b>–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ ¬∑ CRUD</b>
          <div class="row">
            <input id="catName" class="search" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–û–±—É–≤—å)" />
            <input id="catSlug" class="search" placeholder="slug (shoes)" />
            <input id="catParent" class="search" placeholder="parent_id (–æ–ø—Ü.)" />
          </div>
          <div class="row">
            <input id="catImage" class="search" placeholder="URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–æ–ø—Ü.)" />
            <button id="btnCreateCat" class="add" style="max-width:160px">–°–æ–∑–¥–∞—Ç—å</button>
            <button id="btnUpdateCat" class="add" style="max-width:160px;background:#18d1a6" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="btnCancelCat" class="add" style="max-width:120px;background:#303b57" disabled>–û—Ç–º–µ–Ω–∞</button>
          </div>
          <div id="catsEmptyA" class="empty">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</div>
          <div id="catsTableAWrap" style="display:none">
            <div id="catsTbodyA" class="sub-list"></div>
          </div>
        </div>

        <div class="line" style="flex-direction:column;align-items:stretch">
          <b>–¢–æ–≤–∞—Ä—ã ¬∑ CRUD</b>
          <div class="row">
            <input id="pTitle" class="search" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"/>
            <input id="pSlug" class="search" placeholder="slug"/>
          </div>
          <textarea id="pDesc" class="search" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–æ–ø—Ü.)" style="min-height:72px"></textarea>
          <div class="row">
            <input id="pPrice" class="search" type="number" min="0" step="0.01" placeholder="–¶–µ–Ω–∞"/>
            <input id="pCurr" class="search" placeholder="–í–∞–ª—é—Ç–∞" value="RUB"/>
            <input id="pStock" class="search" type="number" min="0" step="1" placeholder="–û—Å—Ç–∞—Ç–æ–∫" value="0"/>
          </div>
          <div class="row">
            <select id="pCat" class="search"><option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option></select>
            <select id="pActive" class="search">
              <option value="true" selected>–ê–∫—Ç–∏–≤–µ–Ω</option>
              <option value="false">–°–∫—Ä—ã—Ç</option>
            </select>
          </div>
          <textarea id="pImages" class="search" placeholder="–°—Å—ã–ª–∫–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ)"></textarea>
          <textarea id="pAttrs" class="search" placeholder='–ê—Ç—Ä–∏–±—É—Ç—ã JSON: {"old_price":999,"rating":4.7,"ratings_count":42581}'></textarea>
          <div class="row">
            <button id="btnCreateProd" class="add" style="max-width:160px">–°–æ–∑–¥–∞—Ç—å</button>
            <button id="btnUpdateProd" class="add" style="max-width:160px;background:#18d1a6" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button id="btnCancelProd" class="add" style="max-width:120px;background:#303b57" disabled>–û—Ç–º–µ–Ω–∞</button>
          </div>

          <div id="prodsEmptyA" class="empty">–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤</div>
          <div id="prodsTableAWrap" style="display:none">
            <div id="prodsTbodyA" class="sub-list"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Bottom Tabbar -->
  <nav id="tabbar" class="tabbar">
    <button class="tabbtn active-ic" data-scr="home" aria-selected="true" title="–ì–ª–∞–≤–Ω–∞—è"><svg class="icv"><use href="#i-home"/></svg></button>
    <button class="tabbtn muted-ic" data-scr="catalog" title="–ö–∞—Ç–∞–ª–æ–≥"><svg class="icv"><use href="#i-grid"/></svg></button>
    <button class="tabbtn muted-ic" data-scr="fav" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"><svg class="icv"><use href="#i-heart"/></svg></button>
    <button class="tabbtn muted-ic" data-scr="cart" title="–ö–æ—Ä–∑–∏–Ω–∞" id="tabCart">
      <svg class="icv"><use href="#i-basket"/></svg>
      <span class="badge-dot" id="cartBadge">0</span>
    </button>
    <button class="tabbtn muted-ic" data-scr="account" title="–ê–∫–∫–∞—É–Ω—Ç"><svg class="icv"><use href="#i-user"/></svg></button>
    <!-- –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –¥–ª—è –∞–¥–º–∏–Ω–∞ -->
  </nav>

  <div class="toast" id="toast"></div>

  <script>
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ API base
    const url = new URL(location.href);
    const qpApi = url.searchParams.get("api");
    const API_BASE = (() => {
      if (qpApi) return qpApi.replace(/\/+$/, "");
      return "http://127.0.0.1:9010";
    })();
    document.getElementById("apiShown").textContent = API_BASE;

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Telegram ID / admin
    let tgId = null, isAdmin = false;
    try { tgId = Telegram?.WebApp?.initDataUnsafe?.user?.id || null; } catch(e){}
    if (!tgId) {
      const saved = localStorage.getItem("debug_tg_id");
      if (saved) tgId = parseInt(saved,10);
    }
    const whoEl = document.getElementById("whoAmI");
    const roleEl = document.getElementById("whoRole");
    if (tgId) whoEl.textContent = String(tgId);

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helpers
    class ApiError extends Error{ constructor(status, message, raw){ super(message); this.status=status; this.raw=raw; } }
    function headers(json=true, withTg=false){
      const h={}; if(json) h["Content-Type"]="application/json"; if(withTg && tgId) h["X-Telegram-Id"]=String(tgId); return h;
    }
    function parseErrorText(text){
      if (!text) return "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞";
      try{ const j=JSON.parse(text);
        if (j.detail){ if (typeof j.detail==="string") return j.detail; if (Array.isArray(j.detail)) return j.detail.map(x=>x.msg||x.detail||JSON.stringify(x)).join("; "); if (j.detail.message) return j.detail.message; }
        if (j.message) return j.message; return typeof j==="string"?j:JSON.stringify(j);
      }catch{ return text; }
    }
    async function apiGet(path, params) {
      const u = new URL(API_BASE + path);
      if (params) Object.entries(params).forEach(([k,v]) => (v ?? v===0) && u.searchParams.set(k,v));
      const r = await fetch(u); const t = await r.text(); if(!r.ok) throw new ApiError(r.status, parseErrorText(t), t); return t?JSON.parse(t):null;
    }
    async function apiSend(method, path, body=null, withTg=false){
      const r = await fetch(API_BASE+path,{method,headers:headers(true,withTg),body:body?JSON.stringify(body):null});
      const t=await r.text(); if(!r.ok) throw new ApiError(r.status, parseErrorText(t), t); return t?JSON.parse(t):null;
    }
    function toast(msg){ const el=document.getElementById("toast"); el.textContent=msg; el.className="toast show"; setTimeout(()=>el.className="toast",2200); }
    function money(v,c="RUB"){ return `${Number(v||0).toFixed(0)} ${c}`; }
    function escapeHtml(s){ return String(s).replace(/[&<>"'`]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c])); }
    function formatCount(n){ n = Number(n||0); return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "\u202F"); }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ state (favorites, cart)
    const favKey="tgshop_fav_ids"; const cartKey="tgshop_cart";
    let fav = new Set(JSON.parse(localStorage.getItem(favKey)||"[]"));
    let cart = new Map(Object.entries(JSON.parse(localStorage.getItem(cartKey)||"{}")).map(([k,v])=>[Number(k),Number(v)]));

    function saveFav(){ localStorage.setItem(favKey, JSON.stringify([...fav])); }
    function saveCart(){ localStorage.setItem(cartKey, JSON.stringify(Object.fromEntries(cart))); }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ product card
    function productCard(p){
      const img = (Array.isArray(p.images) && p.images[0]) ? p.images[0] : "";
      const currency = (p.currency||"RUB").toUpperCase();
      const old = p.attributes?.old_price ?? null;
      const rating = p.attributes?.rating ?? null;
      const rcnt = p.attributes?.ratings_count ?? null;
      const liked = fav.has(p.id);
      const desc = p.description || "";
      return `
        <div class="card" data-id="${p.id}">
          <div class="pic">
            ${img?`<img alt="" src="${escapeHtml(img)}">`:``}
            <button class="fav" aria-pressed="${liked?'true':'false'}" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">
              <svg class="icv"><use href="#i-heart"/></svg>
            </button>
          </div>
          <div class="cnt">
            <div class="title">${escapeHtml(p.title||"–¢–æ–≤–∞—Ä")}</div>
            <div class="desc">${escapeHtml(desc)}</div>
            <div class="price-row">
              <div class="price">${money(p.price, currency)}</div>
              ${old?`<div class="old">${money(old,currency)}</div><span class="badge">-${Math.max(0, Math.round(100-(p.price/old*100)))}%</span>`:""}
            </div>
            <div class="rating">
              <span class="star">‚òÖ</span>
              ${rating?`${Number(rating).toFixed(1)} ¬∑ ${formatCount(rcnt||0)} –æ—Ç–∑—ã–≤–æ–≤`:`–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤`}
            </div>
            <button class="add">–í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>
      `;
    }

    // bind handlers for cards
    function bindCardHandlers(rootEl){
      rootEl.querySelectorAll(".card").forEach(card=>{
        const id = Number(card.dataset.id);
        card.querySelector(".fav")?.addEventListener("click", (e)=>{
          e.stopPropagation();
          if (fav.has(id)) fav.delete(id); else fav.add(id);
          saveFav();
          syncAllGrids(); // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–µ—Ä–¥–µ—á–∫–∏ –≤–µ–∑–¥–µ
        });
        card.querySelector(".add")?.addEventListener("click", ()=>{
          cart.set(id, (cart.get(id)||0)+1); saveCart(); toast("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É"); updateCartBadge();
        });
      });
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ screens/nav
    const screens = {
      home: document.getElementById("scr_home"),
      catalog: document.getElementById("scr_catalog"),
      fav: document.getElementById("scr_fav"),
      cart: document.getElementById("scr_cart"),
      account: document.getElementById("scr_account"),
      admin: document.getElementById("scr_admin"),
    };
    function show(scr){
      Object.entries(screens).forEach(([k,el])=>el.classList.toggle("active", k===scr));
      document.querySelectorAll(".tabbtn").forEach(b=>{
        const selected = b.dataset.scr===scr;
        b.setAttribute("aria-selected", selected ? "true":"false");
        b.classList.toggle("active-ic", selected);
        b.classList.toggle("muted-ic", !selected);
      });
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ data + renders
    let allProducts = [];
    let allCategories = [];
    let catIndexByParent = new Map(); // parent_id -> [cats]
    let selectedCat = null;

    function indexCategories(cats){
      catIndexByParent = new Map();
      cats.forEach(c=>{
        const pid = (c.parent_id??null);
        if(!catIndexByParent.has(pid)) catIndexByParent.set(pid,[]);
        catIndexByParent.get(pid).push(c);
      });
    }

    async function refreshHealth(){
      const pill = document.getElementById("pillDb");
      try{
        const h = await apiGet("/health/db");
        const ok = (h?.db==="ok") || (h?.status==="ok");
        pill.style.display = (isAdmin && ok) ? "inline-flex" : "none"; // —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∞–º
      }catch{ pill.style.display = isAdmin ? "inline-flex" : "none"; }
    }
    async function ensureUser(){
      if (!tgId) return;
      try{
        const u = await apiSend("POST","/api/users/ensure",{tg_id:tgId},true);
        isAdmin = !!u.is_admin;
        roleEl.textContent = isAdmin ? "–†–µ–∂–∏–º: –∞–¥–º–∏–Ω" : "–†–µ–∂–∏–º: –≥–æ—Å—Ç—å";
        // –∫–Ω–æ–ø–∫–∞ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
        if (isAdmin && !document.querySelector('.tabbtn[data-scr="admin"]')){
          const tb=document.getElementById("tabbar"); tb.classList.add("admin");
          const btn=document.createElement("button");
          btn.className="tabbtn muted-ic"; btn.dataset.scr="admin"; btn.title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ";
          btn.innerHTML='<svg class="icv"><use href="#i-edit"/></svg>';
          tb.appendChild(btn);
          btn.addEventListener("click",()=>show("admin"));
        }
      }catch(e){ console.warn("ensure user failed",e); }
    }
    async function loadCategories(){
      const cats = await apiGet("/api/categories");
      allCategories = cats;
      indexCategories(cats);
      renderCatTiles();
      // –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–µ–ª–µ–∫—Ç –≤ –∞–¥–º–∏–Ω–∫–µ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤
      const sel = document.getElementById("pCat");
      sel.innerHTML = '<option value="">‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—è ‚Äî</option>' + cats.map(c=>`<option value="${c.id}">${escapeHtml(c.name)} (#${c.id})</option>`).join("");
      // –ø–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π –≤ –∞–¥–º–∏–Ω–∫–µ
      renderAdminCats();
    }
    async function loadProducts(params){
      const list = await apiGet("/api/products", params);
      allProducts = list;
      renderHome(list);
      renderFav();
      renderCart();
      updateCartBadge();
      renderAdminProds(); // —á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã
    }

    // -------- Catalog renders
    function renderCatTiles(){
      selectedCat = null;
      const tiles = document.getElementById("catTiles");
      const empty = document.getElementById("catTilesEmpty");
      const sub = document.getElementById("catSub");
      sub.style.display = "none";
      tiles.style.display = "grid";
      const roots = (catIndexByParent.get(null)||[]);
      if(!roots.length){ tiles.innerHTML=""; empty.style.display="block"; return; }
      empty.style.display="none";
      tiles.innerHTML = roots.map(c=>{
        const img = c.attributes?.image || "";
        return `
          <div class="cat-tile" data-id="${c.id}">
            <div class="tt">${escapeHtml(c.name)}</div>
            ${img?`<img class="img" src="${escapeHtml(img)}" alt="">`:``}
          </div>
        `;
      }).join("");
      tiles.querySelectorAll(".cat-tile").forEach(t=>{
        t.addEventListener("click", ()=>{
          selectedCat = Number(t.dataset.id);
          renderSubcats(selectedCat);
        });
      });
    }
    function renderSubcats(parentId){
      const tiles = document.getElementById("catTiles");
      const sub = document.getElementById("catSub");
      const list = document.getElementById("subList");
      const path = document.getElementById("catPath");
      const parent = allCategories.find(x=>x.id===parentId);
      tiles.style.display="none"; sub.style.display="block";
      path.textContent = parent ? parent.name : "";
      const children = (catIndexByParent.get(parentId)||[]);
      list.innerHTML = children.map(c=>{
        const img = c.attributes?.image || "";
        return `
          <div class="sub-item" data-id="${c.id}">
            <div class="thumb">${img?`<img src="${escapeHtml(img)}" alt="">`:``}</div>
            <div class="t">${escapeHtml(c.name)}</div>
          </div>
        `;
      }).join("");
      // –∫–ª–∏–∫ –ø–æ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî —Ñ–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã –ø–æ category_id –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º "–ì–ª–∞–≤–Ω—É—é"
      list.querySelectorAll(".sub-item").forEach(li=>{
        li.addEventListener("click", ()=>{
          const catId = Number(li.dataset.id);
          show('home');
          loadProducts({category_id:catId});
        });
      });
    }
    document.getElementById("btnCatBack").addEventListener("click", renderCatTiles);

    // -------- Product renders
    function renderHome(list){
      const g=document.getElementById("homeGrid"), e=document.getElementById("homeEmpty");
      if (!list.length){ g.innerHTML=""; e.style.display="block"; return; }
      e.style.display="none";
      g.innerHTML = list.map(productCard).join("");
      bindCardHandlers(g);
    }
    function renderFav(){
      const arr = allProducts.filter(p=>fav.has(p.id));
      const g=document.getElementById("favGrid"), e=document.getElementById("favEmpty");
      if(!arr.length){ g.innerHTML=""; e.style.display="block"; return; }
      e.style.display="none"; g.innerHTML = arr.map(productCard).join(""); bindCardHandlers(g);
    }
    function renderCart(){
      const listEl = document.getElementById("cartList");
      const empty = document.getElementById("cartEmpty");
      const panel = document.getElementById("cartTotal");
      const sumEl = document.getElementById("sumText");
      const items = [...cart.entries()].map(([id,q])=>{
        const p = allProducts.find(x=>x.id===id); return p?{p,q}:null;
      }).filter(Boolean);
      if(!items.length){ listEl.innerHTML=""; empty.style.display="block"; panel.style.display="none"; return; }
      empty.style.display="none"; panel.style.display="flex";
      let sum=0, curr="RUB";
      listEl.innerHTML = items.map(({p,q})=>{
        sum += (Number(p.price)||0)*q; curr = (p.currency||"RUB").toUpperCase();
        const img = (Array.isArray(p.images)&&p.images[0])?p.images[0]:"";
        return `
          <div class="line" data-id="${p.id}">
            <div class="thumb">${img?`<img src="${escapeHtml(img)}" alt="">`:""}</div>
            <div class="t">
              <div><b>${escapeHtml(p.title)}</b></div>
              <div class="muted">${money(p.price,curr)} ¬∑ –ö–æ–ª-–≤–æ: <b>${q}</b></div>
            </div>
            <div class="row" style="gap:6px">
              <button class="tabbtn" data-act="dec">‚àí</button>
              <button class="tabbtn" data-act="inc">+</button>
              <button class="tabbtn" data-act="del">üóë</button>
            </div>
          </div>
        `;
      }).join("");
      sumEl.textContent = money(sum, curr);
      listEl.querySelectorAll(".line").forEach(line=>{
        const id = Number(line.dataset.id);
        line.querySelectorAll("[data-act]").forEach(b=>{
          b.addEventListener("click", ()=>{
            const act=b.dataset.act;
            if (act==="inc"){ cart.set(id,(cart.get(id)||0)+1); }
            else if (act==="dec"){ const n=(cart.get(id)||0)-1; if (n>0) cart.set(id,n); else cart.delete(id); }
            else if (act==="del"){ cart.delete(id); }
            saveCart(); renderCart(); updateCartBadge();
          });
        });
      });
    }

    // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–µ—Ä–¥–µ—á–µ–∫ –Ω–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–∞—Ö
    function syncAllGrids(){
      renderHome(allProducts);
      renderFav();
      // –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –∫–∞—Ç–∞–ª–æ–≥ —Å —Ç–æ–≤–∞—Ä–∞–º–∏ (–ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏) ‚Äî –æ–±–Ω–æ–≤–∏–º —Ç–æ–≤–∞—Ä—ã
      // (–º—ã –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–≤–∞—Ä—ã –Ω–∞ –≥–ª–∞–≤–Ω–æ–π; –∫–∞—Ç–∞–ª–æ–≥—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω—É–∂–Ω–æ)
      updateCartBadge();
    }

    // —Ç–æ–ª—å–∫–æ –∫–æ—Ä–∑–∏–Ω–∞ –∏–º–µ–µ—Ç —Å—á—ë—Ç—á–∏–∫
    function updateCartBadge(){
      const cartCount = [...cart.values()].reduce((a,b)=>a+b,0);
      const badge = document.getElementById("cartBadge");
      if (cartCount>0){ badge.style.display="flex"; badge.textContent=String(cartCount); }
      else { badge.style.display="none"; }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Admin CRUD (–∫–∞—Ç–µ–≥–æ—Ä–∏–∏)
    let editingCatId = null;
    function renderAdminCats(){
      const list = allCategories.slice().sort((a,b)=>a.id-b.id);
      const wrap = document.getElementById("catsTableAWrap");
      const empty = document.getElementById("catsEmptyA");
      const body = document.getElementById("catsTbodyA");
      if (!list.length){ wrap.style.display="none"; empty.style.display="block"; body.innerHTML=""; return; }
      wrap.style.display="block"; empty.style.display="none";
      body.innerHTML = list.map(c=>`
        <div class="sub-item">
          <div class="t"><b>#${c.id}</b> ¬∑ ${escapeHtml(c.name)} <span class="muted">(${escapeHtml(c.slug)})</span> ${c.parent_id?`¬∑ parent:${c.parent_id}`:""}</div>
          <div class="row" style="gap:6px">
            <button class="tabbtn" data-act="editCat" data-id="${c.id}">‚úèÔ∏è</button>
            <button class="tabbtn" data-act="delCat" data-id="${c.id}">üóëÔ∏è</button>
          </div>
        </div>
      `).join("");
      body.querySelectorAll("[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = Number(btn.dataset.id);
          const act = btn.dataset.act;
          if (act==="editCat"){
            const c = list.find(x=>x.id===id); if(!c) return;
            editingCatId = id;
            document.getElementById("catName").value = c.name||"";
            document.getElementById("catSlug").value = c.slug||"";
            document.getElementById("catParent").value = c.parent_id ?? "";
            document.getElementById("catImage").value = c.attributes?.image || "";
            document.getElementById("btnUpdateCat").disabled = false;
            document.getElementById("btnCancelCat").disabled = false;
          }else if (act==="delCat"){
            if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é #${id}?`)) return;
            const r = await fetch(API_BASE+`/api/categories/${id}`,{method:"DELETE",headers:headers(false,true)});
            if (!r.ok){ const t=await r.text(); return toast(parseErrorText(t)); }
            toast("–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞");
            await loadCategories();
          }
        });
      });
    }
    document.getElementById("btnCreateCat").addEventListener("click", async ()=>{
      const payload = {
        name: document.getElementById("catName").value.trim(),
        slug: document.getElementById("catSlug").value.trim(),
        parent_id: document.getElementById("catParent").value.trim()?Number(document.getElementById("catParent").value.trim()):null,
        attributes: (()=>{
          const img = document.getElementById("catImage").value.trim();
          return img ? {image: img} : null;
        })()
      };
      if (!payload.name || !payload.slug) return toast("–£–∫–∞–∂–∏ name –∏ slug");
      try{
        await apiSend("POST","/api/categories",payload,true);
        toast("–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ–∑–¥–∞–Ω–∞");
        ["catName","catSlug","catParent","catImage"].forEach(id=>document.getElementById(id).value="");
        await loadCategories();
      }catch(e){ toast(e.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"); }
    });
    document.getElementById("btnUpdateCat").addEventListener("click", async ()=>{
      if (!editingCatId) return;
      const payload = {
        name: document.getElementById("catName").value.trim(),
        slug: document.getElementById("catSlug").value.trim(),
        parent_id: document.getElementById("catParent").value.trim()?Number(document.getElementById("catParent").value.trim()):null,
        attributes: (()=>{
          const img = document.getElementById("catImage").value.trim();
          return img ? {image: img} : null;
        })()
      };
      try{
        await apiSend("PATCH", `/api/categories/${editingCatId}`, payload, true);
        toast("–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞");
        editingCatId=null; document.getElementById("btnUpdateCat").disabled=true; document.getElementById("btnCancelCat").disabled=true;
        ["catName","catSlug","catParent","catImage"].forEach(id=>document.getElementById(id).value="");
        await loadCategories();
      }catch(e){ toast(e.message||"–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"); }
    });
    document.getElementById("btnCancelCat").addEventListener("click", ()=>{
      editingCatId=null; document.getElementById("btnUpdateCat").disabled=true; document.getElementById("btnCancelCat").disabled=true;
      ["catName","catSlug","catParent","catImage"].forEach(id=>document.getElementById(id).value="");
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Admin CRUD (—Ç–æ–≤–∞—Ä—ã)
    let editingProdId = null;
    function collectProdPayload(){
      const title = document.getElementById("pTitle").value.trim();
      let slug = document.getElementById("pSlug").value.trim();
      const desc = document.getElementById("pDesc").value.trim();
      if (!slug && title) slug = slugify(title);
      const category_id = parseInt(document.getElementById("pCat").value,10);
      if (!title || !slug || !category_id){ toast("–£–∫–∞–∂–∏ title, slug –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é"); return null; }
      let price = parseFloat((document.getElementById("pPrice").value || "0").replace(",", ".")); if (Number.isNaN(price) || price < 0) price = 0;
      const stock = parseInt(document.getElementById("pStock").value || "0",10);
      const images = (()=>{
        const v = document.getElementById("pImages").value.trim();
        return v ? v.split("\n").map(s=>s.trim()).filter(Boolean) : null;
      })();
      let attributes = null; const rawAttrs = document.getElementById("pAttrs").value.trim();
      if (rawAttrs){ try{ attributes = JSON.parse(rawAttrs); } catch{ toast("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON –∞—Ç—Ä–∏–±—É—Ç–æ–≤"); return null; } }
      return {
        title, slug, description: desc || null, price,
        currency:(document.getElementById("pCurr").value||"RUB").toUpperCase(),
        stock:Number.isFinite(stock)?stock:0,
        is_active: document.getElementById("pActive").value==="true",
        images, attributes, category_id
      };
    }
    function slugify(v){
      return (v||"").toLowerCase().trim()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/\s+/g,"-").replace(/[^a-z0-9\-]/g,"-")
        .replace(/\-+/g,"-").replace(/^\-+|\-+$/g,"") || "item";
    }
    function clearProdForm(){
      ["pTitle","pSlug","pDesc","pPrice","pCurr","pStock","pImages","pAttrs"].forEach(id=>document.getElementById(id).value="");
      document.getElementById("pCurr").value="RUB";
      document.getElementById("pStock").value="0";
      document.getElementById("pCat").value="";
      document.getElementById("pActive").value="true";
    }

    function renderAdminProds(){
      const list = allProducts.slice().sort((a,b)=>a.id-b.id);
      const wrap = document.getElementById("prodsTableAWrap");
      const empty = document.getElementById("prodsEmptyA");
      const body = document.getElementById("prodsTbodyA");
      if (!list.length){ wrap.style.display="none"; empty.style.display="block"; body.innerHTML=""; return; }
      wrap.style.display="block"; empty.style.display="none";
      body.innerHTML = list.map(p=>`
        <div class="sub-item">
          <div class="t"><b>#${p.id}</b> ¬∑ ${escapeHtml(p.title)} <span class="muted">(${escapeHtml(p.slug)})</span> ¬∑ ${money(p.price,(p.currency||"RUB").toUpperCase())} ¬∑ cat:${p.category_id}</div>
          <div class="row" style="gap:6px">
            <button class="tabbtn" data-act="editProd" data-id="${p.id}">‚úèÔ∏è</button>
            <button class="tabbtn" data-act="delProd" data-id="${p.id}">üóëÔ∏è</button>
          </div>
        </div>
      `).join("");
      body.querySelectorAll("[data-act]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = Number(btn.dataset.id);
          const act = btn.dataset.act;
          if (act==="editProd"){
            const p = list.find(x=>x.id===id); if(!p) return;
            editingProdId = id;
            document.getElementById("pTitle").value = p.title||"";
            document.getElementById("pSlug").value = p.slug||"";
            document.getElementById("pDesc").value = p.description||"";
            document.getElementById("pPrice").value = String(p.price ?? 0);
            document.getElementById("pCurr").value = p.currency||"RUB";
            document.getElementById("pStock").value = String(p.stock ?? 0);
            document.getElementById("pCat").value = String(p.category_id ?? "");
            document.getElementById("pActive").value = p.is_active ? "true" : "false";
            document.getElementById("pImages").value = Array.isArray(p.images) ? p.images.join("\n") : "";
            document.getElementById("pAttrs").value = p.attributes ? JSON.stringify(p.attributes,null,2) : "";
            document.getElementById("btnUpdateProd").disabled=false;
            document.getElementById("btnCancelProd").disabled=false;
          } else if (act==="delProd"){
            if(!confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä #${id}?`)) return;
            const r = await fetch(API_BASE+`/api/products/${id}`,{method:"DELETE",headers:headers(false,true)});
            if (!r.ok){ const t=await r.text(); return toast(parseErrorText(t)); }
            toast("–¢–æ–≤–∞—Ä —É–¥–∞–ª—ë–Ω");
            await loadProducts();
          }
        });
      });
    }
    document.getElementById("btnCreateProd").addEventListener("click", async ()=>{
      const payload = collectProdPayload(); if (!payload) return;
      try{
        const r = await apiSend("POST","/api/products",payload,true);
        toast(`–¢–æ–≤–∞—Ä #${r.id} —Å–æ–∑–¥–∞–Ω`);
        clearProdForm();
        await loadProducts();
      }catch(e){ toast(e.message||"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–≤–∞—Ä–∞"); }
    });
    document.getElementById("btnUpdateProd").addEventListener("click", async ()=>{
      if (!editingProdId) return;
      const payload = collectProdPayload(); if (!payload) return;
      try{
        const r = await apiSend("PATCH", `/api/products/${editingProdId}`, payload, true);
        toast(`–¢–æ–≤–∞—Ä #${r.id} —Å–æ—Ö—Ä–∞–Ω—ë–Ω`);
        editingProdId=null; document.getElementById("btnUpdateProd").disabled=true; document.getElementById("btnCancelProd").disabled=true;
        clearProdForm(); await loadProducts();
      }catch(e){ toast(e.message||"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞"); }
    });
    document.getElementById("btnCancelProd").addEventListener("click", ()=>{
      editingProdId=null; document.getElementById("btnUpdateProd").disabled=true; document.getElementById("btnCancelProd").disabled=true; clearProdForm();
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ events
    document.getElementById("search").addEventListener("input", (e)=>{
      const q = e.target.value.trim();
      const params = q ? { q } : undefined;
      loadProducts(params);
    });

    document.getElementById("btnResetLocal").addEventListener("click", ()=>{
      localStorage.removeItem(favKey); localStorage.removeItem(cartKey);
      fav = new Set(); cart = new Map(); syncAllGrids(); toast("–î–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã");
    });
    document.getElementById("btnChangeApi").addEventListener("click", ()=>{
      const v = prompt("–£–∫–∞–∂–∏ –Ω–æ–≤—ã–π API Base URL", API_BASE); if(!v) return;
      const u = new URL(location.href); u.searchParams.set("api", v); location.href=u.toString();
    });

    document.querySelectorAll(".tabbtn").forEach(btn=>{
      btn.addEventListener("click", ()=> show(btn.dataset.scr));
    });

    document.getElementById("btnCheckout").addEventListener("click", ()=>{
      if (!cart.size) return;
      toast("–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω (–∑–∞–≥–ª—É—à–∫–∞)");
    });

    // tap-to-dismiss keyboard everywhere
    ['pointerdown','touchstart'].forEach(evt=>{
      document.addEventListener(evt, (e)=>{
        const el = e.target;
        const tag = (el?.tagName||"").toLowerCase();
        const isInput = ['input','textarea','select'].includes(tag) || el?.isContentEditable;
        if (!isInput && document.activeElement && (['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName) || document.activeElement.isContentEditable)){
          document.activeElement.blur();
        }
      }, {passive:true});
    });

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ init
    async function init(){
      await ensureUser();
      await refreshHealth(); // –ø–æ—Å–ª–µ ensureUser
      await loadCategories();
      await loadProducts();
      show('home');
    }
    init();
  </script>
</body>
</html>
