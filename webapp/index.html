<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ú–∞–≥–∞–∑–∏–Ω –æ–¥–µ–∂–¥—ã</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#fff;--text:#111;--subtext:#5b5b5b;--card:#fff;--muted:#f1f1f4;
      --accent:#2a85ff;--accent-contrast:#fff;--border:rgba(0,0,0,.08);
      --shadow:0 6px 24px rgba(0,0,0,.08);
      --radius:12px;
      --safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px);
      --trans-fast:160ms cubic-bezier(.2,.8,.2,1)
    }
    @media (prefers-color-scheme: dark){
      :root{--bg:#0f1113;--text:#f3f4f6;--subtext:#a1a1aa;--card:#15181b;--muted:#1b1f24;--border:rgba(255,255,255,.06);--shadow:0 6px 24px rgba(0,0,0,.35)}
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;padding-bottom:calc(72px + var(--safe-bottom))}
    /* AppBar –±–µ–∑ –±—Ä–µ–Ω–¥–∞ ‚Äî —Ä–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
    .appbar{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(0,0,0,.04),transparent);padding:calc(12px + var(--safe-top)) 12px 8px;backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--border)}
    .row{display:flex;align-items:center;gap:10px}
    .grow{flex:1}
    .iconbtn{display:grid;place-items:center;width:40px;height:40px;border-radius:12px;background:var(--muted);border:1px solid var(--border);cursor:pointer}
    .pillbtn{height:40px;padding:0 14px;border-radius:12px;border:1px solid var(--border);background:var(--muted);cursor:pointer;font-weight:600}
    /* –ü–æ–∏—Å–∫ */
    .search{position:relative;display:flex;gap:8px;align-items:center}
    .search .field{position:relative;flex:1}
    .search input{width:100%;padding:10px 36px;background:var(--muted);color:var(--text);border:1px solid var(--border);border-radius:12px;outline:none}
    .search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.7}
    .search .clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);opacity:.6;border:none;background:transparent;font-size:18px;line-height:1;cursor:pointer}
    /* –ö–æ–Ω—Ç–µ–Ω—Ç/–∫–∞—Ä—Ç–æ—á–∫–∏ */
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr));grid-auto-rows:1fr}
    @media(min-width:760px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media(min-width:992px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);display:flex;flex-direction:column;height:100%;position:relative}
    .fav-toggle{position:absolute;right:10px;top:10px;z-index:2;width:36px;height:36px;border-radius:999px;border:1px solid var(--border);background:var(--card);display:grid;place-items:center;user-select:none}
    .fav-toggle.active{background:var(--accent);color:var(--accent-contrast);border-color:transparent}
    .mod-edit{position:absolute;left:10px;top:10px;z-index:2;width:36px;height:36px;border-radius:999px;border:1px solid var(--border);background:var(--card);display:grid;place-items:center;user-select:none}
    .img{aspect-ratio:1/1;width:100%;background:var(--muted);display:block;object-fit:cover}
    .body{padding:12px;display:flex;flex-direction:column;gap:10px;flex:1}
    .title{font-weight:800}
    .desc{font-size:13px;color:var(--subtext);display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .price{font-weight:900;margin-top:2px}
    .sizes{display:grid;grid-auto-flow:column;grid-auto-columns:calc((100% - 3*8px)/4);gap:8px;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;padding-bottom:2px;scrollbar-width:none}
    .sizes::-webkit-scrollbar{display:none}
    .chip{display:grid;place-items:center;white-space:nowrap;padding:8px 10px;border-radius:10px;background:var(--muted);border:1px solid var(--border);cursor:pointer;user-select:none}
    .chip.active{background:var(--accent);color:var(--accent-contrast);border-color:transparent}
    .controls{display:flex;gap:8px;align-items:center;margin-top:auto}
    .qty{width:56px;padding:8px 6px;text-align:center;background:var(--muted);color:var(--text);border:1px solid var(--border);border-radius:10px}
    .add{flex:1;height:44px;border:none;border-radius:12px;background:var(--accent);color:var(--accent-contrast);font-weight:800;cursor:pointer}
    /* –ë–æ–∫–æ–≤—ã–µ –ø–∞–Ω–µ–ª–∏ */
    .sheet{position:fixed;right:0;top:0;height:100%;width:min(92vw,420px);background:var(--card);border-left:1px solid var(--border);box-shadow:var(--shadow);transform:translateX(100%);transition:transform var(--trans-fast);z-index:50;display:flex;flex-direction:column}
    .sheet.open{transform:translateX(0)}
    .sheet .head{padding:calc(8px + var(--safe-top)) 16px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .sheet .head .title{font-weight:800}
    .sheet .list{padding:0;margin:0;overflow:auto;flex:1;display:block}
    /* –°–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –±–µ–∑ –∑–∞–∑–æ—Ä–æ–≤ */
    .item{display:grid;grid-template-columns:56px 1fr;grid-template-rows:auto auto;grid-template-areas:"ph meta" "actions actions";column-gap:10px;row-gap:6px;align-items:start;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px;margin:0;border-bottom:1px solid var(--border)}
    .sheet .list .item + .item{border-top:0}
    .item .ph{grid-area:ph;width:56px;height:56px;border-radius:10px;background:var(--muted);display:block;object-fit:cover}
    .item .meta{grid-area:meta;min-width:0;align-self:center}
    .item .meta .t{font-weight:700;display:-webkit-box;-webkit-line-clamp:1;-webkit-box-orient:vertical;overflow:hidden;text-overflow:ellipsis}
    .item .meta .s{font-size:12px;color:var(--subtext);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .item .actions{grid-area:actions;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .item .actions .left{display:flex;align-items:center;gap:8px;flex-wrap:nowrap}
    .qtyctrl{display:flex;align-items:center;gap:6px;flex-shrink:0}
    .btnsq{width:28px;height:28px;border-radius:8px;border:1px solid var(--border);background:var(--muted);display:grid;place-items:center;cursor:pointer;flex-shrink:0}
    .qtymini{width:44px;text-align:center;padding:6px;border:1px solid var(--border);border-radius:8px;background:var(--muted);color:var(--text);flex-shrink:0}
    .item .rmv{padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--muted);cursor:pointer;white-space:nowrap}
    .item .sum{white-space:nowrap}
    .foot{border-top:1px solid var(--border);padding:12px 16px calc(12px + var(--safe-bottom));display:grid;gap:10px}
    .total{display:flex;justify-content:space-between;font-weight:800}
    /* –ö–∞—Ç–∞–ª–æ–≥-–Ω–∞–≤–∏–≥–∞—Ç–æ—Ä + —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ */
    .catlist{list-style:none;margin:0;padding:0}
    .catlist li{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border);cursor:pointer}
    .catlist li:hover{background:var(--muted)}
    .badge{min-width:22px;height:22px;border-radius:999px;background:var(--accent);color:var(--accent-contrast);display:grid;place-items:center;font-size:12px;font-weight:800;padding:0 6px}
    .toolbar{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;gap:10px;align-items:center}
    .toolbar .pillbtn.primary{background:var(--accent);color:var(--accent-contrast);border-color:transparent}
    /* –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏ */
    .form{padding:12px 16px;display:grid;gap:12px;overflow:auto}
    .section{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;display:grid;gap:10px;box-shadow:var(--shadow)}
    .section .title{font-weight:800}
    .field label{display:block;font-size:12px;color:var(--subtext);margin-bottom:6px}
    .field input[type="text"],.field input[type="number"],.field textarea,.field select{
      width:100%;padding:10px;border:1px solid var(--border);background:var(--muted);color:var(--text);border-radius:10px;resize:vertical
    }
    .imgpick{display:flex;gap:12px;align-items:center}
    .imgpick img{width:72px;height:72px;border-radius:10px;object-fit:cover;background:var(--muted);border:1px solid var(--border)}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="row">
      <!-- –ö–Ω–æ–ø–∫–∏ –≤—ã—Ä–æ–≤–Ω–µ–Ω—ã: –ö–∞—Ç–∞–ª–æ–≥, –ø–æ–∏—Å–∫, –∏–∑–±—Ä–∞–Ω–Ω–æ–µ, –∫–æ—Ä–∑–∏–Ω–∞, –º–æ–¥–µ—Ä–∞—Ü–∏—è -->
      <button id="openCatalog" class="pillbtn" title="–ö–∞—Ç–∞–ª–æ–≥">–ö–∞—Ç–∞–ª–æ–≥</button>
      <div class="grow search">
        <div class="field">
          <input id="q" inputmode="search" autocomplete="off" autocapitalize="none" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É‚Ä¶"/>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.2-4.2M10.8 18a7.2 7.2 0 1 1 0-14.4 7.2 7.2 0 0 1 0 14.4Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          <button id="clearSearch" class="clear" aria-label="–û—á–∏—Å—Ç–∏—Ç—å">√ó</button>
        </div>
      </div>
      <button id="openFav" class="iconbtn" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">‚ô•</button>
      <button id="openCart" class="iconbtn" title="–ö–æ—Ä–∑–∏–Ω–∞">üõí</button>
      <button id="openMod" class="iconbtn" title="–ú–æ–¥–µ—Ä–∞—Ü–∏—è" style="display:none">‚öôÔ∏è</button>
    </div>
  </header>

  <main class="wrap">
    <div id="grid" class="grid"></div>
  </main>

  <div class="fab" id="fabCart" style="display:none;">
    <span>–ö–æ—Ä–∑–∏–Ω–∞</span><span class="badge" id="cartCount">0</span>
  </div>

  <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
  <aside class="sheet" id="sheet">
    <div class="head">
      <button id="closeCart" class="iconbtn" title="–ù–∞–∑–∞–¥">‚Üê</button>
      <div class="title">–ö–æ—Ä–∑–∏–Ω–∞</div>
    </div>
    <div class="list" id="cartList"></div>
    <div class="foot"><div class="total"><span>–ò—Ç–æ–≥–æ</span><span id="total">0 ‚ÇΩ</span></div><button id="checkout" class="add">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button></div>
  </aside>

  <!-- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
  <aside class="sheet" id="favSheet">
    <div class="head">
      <button id="closeFav" class="iconbtn" title="–ù–∞–∑–∞–¥">‚Üê</button>
      <div class="title">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
    </div>
    <div class="list" id="favList"></div>
  </aside>

  <!-- –ö–∞—Ç–∞–ª–æ–≥ (–Ω–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º) + –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ -->
  <aside class="sheet" id="catalogSheet">
    <div class="head">
      <button id="closeCatalog" class="iconbtn" title="–ù–∞–∑–∞–¥">‚Üê</button>
      <div class="title">–ö–∞—Ç–µ–≥–æ—Ä–∏–∏</div>
    </div>

    <div class="toolbar" id="catToolbar" style="display:none">
      <button id="btnCatAdd" class="pillbtn primary">+ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</button>
    </div>

    <ul id="catList" class="catlist"></ul>
  </aside>

  <!-- –ú–æ–¥–µ—Ä–∞—Ü–∏—è: —Ñ–æ—Ä–º–∞ -->
  <aside class="sheet" id="editSheet">
    <div class="head">
      <button id="closeEdit" class="iconbtn" title="–ù–∞–∑–∞–¥">‚Üê</button>
      <div class="title" id="editTitle">–¢–æ–≤–∞—Ä</div>
    </div>

    <div class="form">
      <div class="section">
        <div class="title">–û—Å–Ω–æ–≤–Ω–æ–µ</div>
        <div class="field">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input id="f_name" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –•—É–¥–∏ Classic"/>
        </div>
        <div class="field">
          <label>SKU (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)</label>
          <input id="f_sku" type="text" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: hd-classic"/>
        </div>
        <div class="field">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="f_desc" rows="3" placeholder="–ö–æ—Ä–æ—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"></textarea>
        </div>
      </div>

      <div class="section">
        <div class="title">–ö–∞—Ç–µ–≥–æ—Ä–∏—è –∏ —Ü–µ–Ω–∞</div>
        <div class="field">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <input id="f_category" list="d_categories" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –•—É–¥–∏"/>
          <datalist id="d_categories"></datalist>
        </div>
        <div class="field">
          <label>–¶–µ–Ω–∞, ‚ÇΩ</label>
          <input id="f_price" type="number" min="0" step="1" />
        </div>
        <div class="field">
          <label>–†–∞–∑–º–µ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
          <input id="f_sizes" type="text" placeholder="S, M, L, XL"/>
        </div>
      </div>

      <div class="section">
        <div class="title">–§–æ—Ç–æ</div>
        <div class="imgpick">
          <img id="f_preview" alt="">
          <input id="f_img" type="file" accept="image/*">
        </div>
      </div>

      <div class="section" style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
        <button id="f_save" class="pillbtn" style="background:var(--accent);color:var(--accent-contrast);border-color:transparent">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="f_delete" class="pillbtn" style="display:none">–£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  </aside>

  <div class="toast" id="toast">–ì–æ—Ç–æ–≤–æ</div>

  <script>
    /* ---------- TELEGRAM / THEME ---------- */
    const tg = window.Telegram.WebApp; tg.expand();
    function applyTheme(){
      const p=tg.themeParams||{};
      const map={'--bg':p.bg_color,'--text':p.text_color,'--subtext':p.hint_color,'--card':p.secondary_bg_color,'--muted':p.section_bg_color,'--accent':p.button_color,'--accent-contrast':p.button_text_color,'--border':p.section_separator_color?hexToRgba(p.section_separator_color,.6):null};
      for(const k in map) if(map[k]) document.documentElement.style.setProperty(k,map[k]);
    }
    function hexToRgba(hex,a=1){const h=hex?.replace('#','')||'000000';const bi=parseInt(h,16)||0;return`rgba(${bi>>16&255},${bi>>8&255},${bi&255},${a})`;}
    applyTheme(); tg.onEvent('themeChanged',applyTheme);

    /* ---------- API ---------- */
    const API_BASE=(new URLSearchParams(location.search).get('api')||'').replace(/\/+$/,'');
    const DEV_FALLBACK_API='';  // —É–∫–∞–∂–∏ ngrok –ø—Ä–∏ –ª–æ–∫–∞–ª—å–Ω–æ–π –æ—Ç–ª–∞–¥–∫–µ
    const API = API_BASE || DEV_FALLBACK_API;

    /* ---------- FLAGS ---------- */
    let IS_MODERATOR=false;
    let MOD_MODE=false;         // —Ä–µ–∂–∏–º –º–æ–¥–µ—Ä–∞—Ü–∏–∏
    let currentCategory='';     // –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ñ–∏–ª—å—Ç—Ä–∞

    /* ---------- STORAGE KEYS ---------- */
    const STORE_PRODUCTS='tgshop_products_v3';
    const STORE_CART='tgshop_cart_v1';
    const STORE_FAV ='tgshop_fav_v1';
    const STORE_CATS='tgshop_categories_v1';

    /* ---------- DEFAULT CATALOG ---------- */
    const DEFAULT_PRODUCTS=[
      { sku:'ts-basic',   name:'–§—É—Ç–±–æ–ª–∫–∞ Basic', category:'–§—É—Ç–±–æ–ª–∫–∏', price:1290, sizes:['S','M','L','XL'], img:'https://images.unsplash.com/photo-1512436991641-6745cdb1723f?q=80&w=800&auto=format&fit=crop', desc:'–ë–∞–∑–æ–≤–∞—è —Ñ—É—Ç–±–æ–ª–∫–∞ –∏–∑ —Ö–ª–æ–ø–∫–∞' },
      { sku:'hd-classic', name:'–•—É–¥–∏ Classic',   category:'–•—É–¥–∏',     price:3290, sizes:['S','M','L','XL'], img:'https://images.unsplash.com/photo-1520974735194-7b1c9a8d4a9a?q=80&w=800&auto=format&fit=crop', desc:'–¢—ë–ø–ª–æ–µ —Ö—É–¥–∏ –Ω–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å' },
      { sku:'js-urban',   name:'–î–∂–∏–Ω—Å—ã Urban',   category:'–ë—Ä—é–∫–∏',    price:3990, sizes:['28','30','32','34','36'], img:'https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&w=800&auto=format&fit=crop', desc:'–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –∫—Ä–æ–π, —Å—Ä–µ–¥–Ω—è—è –ø–æ—Å–∞–¥–∫–∞' },
      { sku:'jk-bomber',  name:'–ë–æ–º–±–µ—Ä Air',     category:'–ö—É—Ä—Ç–∫–∏',   price:5490, sizes:['S','M','L'], img:'https://images.unsplash.com/photo-1551024709-8f23befc6cf7?q=80&w=800&auto=format&fit=crop', desc:'–õ—ë–≥–∫–∏–π –±–æ–º–±–µ—Ä –Ω–∞ –º–æ–ª–Ω–∏–∏' },
      { sku:'sk-midi',    name:'–Æ–±–∫–∞ Midi',      category:'–Æ–±–∫–∏',     price:2790, sizes:['XS','S','M','L'], img:'https://images.unsplash.com/photo-1483985988355-763728e1935b?q=80&w=800&auto=format&fit=crop', desc:'–ú–∏–¥–∏-–¥–ª–∏–Ω–∞, –º—è–≥–∫–∞—è –ø–æ—Å–∞–¥–∫–∞' },
      { sku:'sh-chino',   name:'–ë—Ä—é–∫–∏ Chino',    category:'–ë—Ä—é–∫–∏',    price:3490, sizes:['30','32','34','36'], img:'https://images.unsplash.com/photo-1541099649105-f69ad21f3246?q=80&w=800&auto=format&fit=crop', desc:'–î—ã—à–∞—â–∏–π —Ç–≤–∏–ª, —É–¥–æ–±–Ω–∞—è –ø–æ—Å–∞–¥–∫–∞' },
      { sku:'cs-oversize',name:'–õ–æ–Ω–≥—Å–ª–∏–≤ Oversize',category:'–õ–æ–Ω–≥—Å–ª–∏–≤—ã',price:1890, sizes:['S','M','L','XL'], img:'https://images.unsplash.com/photo-1516826957135-700dedea698c?q=80&w=800&auto=format&fit=crop', desc:'–°–≤–æ–±–æ–¥–Ω—ã–π —Å–∏–ª—É—ç—Ç, –º—è–≥–∫–∏–π —Ç—Ä–∏–∫–æ—Ç–∞–∂' },
      { sku:'ct-rain',    name:'–ü–ª–∞—â Rain',      category:'–ö—É—Ä—Ç–∫–∏',   price:5990, sizes:['S','M','L'], img:'https://images.unsplash.com/photo-1520975657286-5d99a4721f85?q=80&w=800&auto=format&fit=crop', desc:'–í–ª–∞–≥–æ–∑–∞—â–∏—Ç–∞, —Å–∫—Ä—ã—Ç—ã–µ –∫–∞—Ä–º–∞–Ω—ã' },
    ];
    const DEFAULT_CATEGORIES = ['–§—É—Ç–±–æ–ª–∫–∏','–•—É–¥–∏','–ë—Ä—é–∫–∏','–ö—É—Ä—Ç–∫–∏','–Æ–±–∫–∏','–õ–æ–Ω–≥—Å–ª–∏–≤—ã','–†–∞–∑–Ω–æ–µ'];

    /* ---------- CLOUD STORAGE HELPERS ---------- */
    const cloud = tg?.CloudStorage;
    const cloudAvail = !!cloud;
    const cloudGet = (key) => new Promise((resolve) => {
      if(!cloudAvail) return resolve(null);
      try{ cloud.getItem(key, (err, val)=> resolve(err?null:val)); }catch{ resolve(null); }
    });
    const cloudSet = (key, val) => new Promise((resolve) => {
      if(!cloudAvail) return resolve(false);
      try{ cloud.setItem(key, val, (err)=> resolve(!err)); }catch{ resolve(false); }
    });

    /* ---------- STORAGE LAYER ---------- */
    function lsGet(key, def=null){ try{ const s=localStorage.getItem(key); return s?JSON.parse(s):def; }catch{ return def; } }
    function lsSet(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} }

    async function persistentSaveFav(arr){ lsSet(STORE_FAV, arr); await cloudSet(STORE_FAV, (arr||[]).join(',')); }
    async function persistentLoadFav(){
      let arr = lsGet(STORE_FAV, null);
      if(arr===null){
        const cloudCsv = await cloudGet(STORE_FAV);
        if(cloudCsv!=null) arr = cloudCsv ? cloudCsv.split(',').filter(Boolean) : [];
      }
      return Array.isArray(arr)?arr:[];
    }
    function persistentSaveCart(arr){ lsSet(STORE_CART, arr); }
    function persistentLoadCart(){ return lsGet(STORE_CART, []); }

    async function persistentSaveProducts(list){
      lsSet(STORE_PRODUCTS, list);
      try{
        const slim = (list||[]).map(p=>({sku:p.sku,name:p.name,category:p.category,price:p.price,sizes:p.sizes,desc:p.desc,img: (p.img||'').startsWith('data:') ? '' : (p.img||'')}));
        const slimStr = JSON.stringify(slim);
        if(slimStr.length < 60000) await cloudSet(STORE_PRODUCTS, slimStr);
      }catch{}
    }
    async function persistentLoadProducts(){
      let list = lsGet(STORE_PRODUCTS, null);
      if(list===null){
        const slimStr = await cloudGet(STORE_PRODUCTS);
        if(slimStr){
          try{ list = JSON.parse(slimStr); }catch{ list=null; }
        }
      }
      return Array.isArray(list) && list.length ? list : null;
    }

    async function persistentSaveCategories(arr){
      lsSet(STORE_CATS, arr);
      try{
        const s = JSON.stringify(arr);
        if(s.length < 20000) await cloudSet(STORE_CATS, s);
      }catch{}
    }
    async function persistentLoadCategories(){
      let list = lsGet(STORE_CATS, null);
      if(list===null){
        const s = await cloudGet(STORE_CATS);
        if(s){ try{ list = JSON.parse(s); }catch{ list = null; } }
      }
      return Array.isArray(list)&&list.length ? list : DEFAULT_CATEGORIES.slice();
    }

    /* ---------- STATE ---------- */
    let products = null;
    let categories = null;
    let cart     = [];
    let fav      = [];

    /* ---------- DOM ---------- */
    const grid=document.getElementById('grid');
    const q=document.getElementById('q');
    const clearBtn=document.getElementById('clearSearch');
    const sheet=document.getElementById('sheet');
    const cartList=document.getElementById('cartList');
    const cartCount=document.getElementById('cartCount');
    const totalEl=document.getElementById('total');
    const fab=document.getElementById('fabCart');
    const toast=document.getElementById('toast');
    const favSheet=document.getElementById('favSheet');
    const favList=document.getElementById('favList');
    const catalogSheet=document.getElementById('catalogSheet');
    const catList=document.getElementById('catList');
    const openFavBtn=document.getElementById('openFav');
    const openCartBtn=document.getElementById('openCart');
    const openModBtn=document.getElementById('openMod');
    const openCatalogBtn=document.getElementById('openCatalog');
    const catToolbar=document.getElementById('catToolbar');
    const btnCatAdd=document.getElementById('btnCatAdd');

    const editSheet=document.getElementById('editSheet');
    const f_name=document.getElementById('f_name');
    const f_sku=document.getElementById('f_sku');
    const f_price=document.getElementById('f_price');
    const f_category=document.getElementById('f_category');
    const f_sizes=document.getElementById('f_sizes');
    const f_desc=document.getElementById('f_desc');
    const f_img=document.getElementById('f_img');
    const f_preview=document.getElementById('f_preview');
    const f_save=document.getElementById('f_save');
    const f_delete=document.getElementById('f_delete');
    const editTitle=document.getElementById('editTitle');
    const d_categories=document.getElementById('d_categories');

    /* ---------- HELPERS ---------- */
    function hideKeyboard(){
      const el=document.activeElement;
      if(!el) return;
      const ed=el.tagName==='INPUT'||el.tagName==='TEXTAREA'||el.isContentEditable;
      if(ed) el.blur();
    }
    function money(v){return v.toLocaleString('ru-RU')+' ‚ÇΩ';}
    function toastMsg(msg){toast.textContent=msg; toast.classList.add('show'); clearTimeout(window._tt); window._tt=setTimeout(()=>toast.classList.remove('show'),1400); tg.HapticFeedback?.notificationOccurred('success');}

    /* ---------- FAVORITES ---------- */
    function isFav(sku){return fav.includes(sku);}
    async function toggleFav(sku){
      fav = isFav(sku) ? fav.filter(x=>x!==sku) : [...fav, sku];
      await persistentSaveFav(fav);
      updateFavUI(); updateFavIcons();
    }
    function updateFavIcons(){
      document.querySelectorAll('[data-favsku]').forEach(btn=>{
        const sku=btn.getAttribute('data-favsku');
        const active=isFav(sku);
        btn.classList.toggle('active', active);
        btn.innerHTML = active ? '‚ô•' : '‚ô°';
      });
    }
    function favItemRow(p){
      const row=document.createElement('div'); row.className='item'; row.dataset.sku=p.sku;
      row.innerHTML=`
        <img class="ph" src="${p.img||''}" alt="">
        <div class="meta">
          <div class="t">${p.name}</div>
          <div class="s">–ê—Ä—Ç–∏–∫—É–ª: ${p.sku}</div>
        </div>
        <div class="actions">
          <div class="left"><button class="rmv">–£–±—Ä–∞—Ç—å</button></div>
          <button class="add tocart">–í –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>`;
      return row;
    }
    function updateFavUI(){
      favList.innerHTML='';
      fav.forEach(sku=>{
        const p=products.find(x=>x.sku===sku);
        if(p) favList.appendChild(favItemRow(p));
      });
      openFavBtn.textContent = fav.length ? `‚ô• ${fav.length}` : '‚ô•';
    }
    favList.addEventListener('click',(e)=>{
      const row=e.target.closest('.item'); if(!row) return;
      const sku=row.dataset.sku;
      const p=products.find(x=>x.sku===sku); if(!p) return;
      if(e.target.classList.contains('rmv')){ toggleFav(sku); return; }
      if(e.target.classList.contains('tocart')){
        const size=p.sizes?.[0]||'';
        addToCart({sku:p.sku,name:p.name,price:p.price,size,qty:1,img:p.img});
        toastMsg('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
      }
    });

    /* ---------- CATEGORIES ---------- */
    function categoriesFromProducts(){
      const set=new Set(categories||[]);
      (products||[]).forEach(p=> set.add((p.category||'–†–∞–∑–Ω–æ–µ').trim()||'–†–∞–∑–Ω–æ–µ') );
      return Array.from(set);
    }
    function renderCategoryOptions(){
      d_categories.innerHTML='';
      for(const c of categoriesFromProducts()){
        const o=document.createElement('option'); o.value=c; d_categories.appendChild(o);
      }
    }
    function getCategoryCounts(){
      const counts = Object.create(null);
      for(const c of categoriesFromProducts()) counts[c]=0;
      (products||[]).forEach(p=>{
        const c=(p.category||'–†–∞–∑–Ω–æ–µ').trim()||'–†–∞–∑–Ω–æ–µ';
        counts[c]=(counts[c]||0)+1;
      });
      return counts;
    }
    function renderCategoryList(){
      catList.innerHTML='';
      const counts=getCategoryCounts();
      // "–í—Å–µ"
      const liAll=document.createElement('li');
      liAll.innerHTML=`<span>–í—Å–µ —Ç–æ–≤–∞—Ä—ã</span><span class="badge">${products.length}</span>`;
      liAll.onclick=()=>{ currentCategory=''; catalogSheet.classList.remove('open'); applyFilter(); };
      catList.appendChild(liAll);
      // –û—Å—Ç–∞–ª—å–Ω—ã–µ
      for(const c of categoriesFromProducts().sort((a,b)=>a.localeCompare(b))){
        const li=document.createElement('li');
        li.innerHTML=`<span>${c}</span><span class="badge">${counts[c]||0}</span>`;
        li.onclick=()=>{ currentCategory=c; catalogSheet.classList.remove('open'); applyFilter(); };
        // —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ ‚Äî —Ç–æ–ª—å–∫–æ –≤ –º–æ–¥–µ
        if(MOD_MODE){
          const actions=document.createElement('div'); actions.style.display='flex'; actions.style.gap='8px';
          const btnEdit=document.createElement('button'); btnEdit.className='pillbtn'; btnEdit.textContent='–ò–∑–º.';
          const btnDel=document.createElement('button'); btnDel.className='pillbtn'; btnDel.textContent='–£–¥–∞–ª.';
          btnEdit.onclick=(e)=>{ e.stopPropagation(); promptRenameCategory(c); };
          btnDel.onclick=(e)=>{ e.stopPropagation(); deleteCategory(c); };
          li.appendChild(actions); actions.prepend(btnEdit); actions.append(btnDel);
        }
        catList.appendChild(li);
      }
    }
    function promptRenameCategory(oldName){
      const name=prompt('–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏', oldName)||'';
      const newName=name.trim();
      if(!newName || newName===oldName) return;
      // –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
      categories = categories.map(c=> c===oldName?newName:c);
      // –ø–µ—Ä–µ–Ω–æ—Å–∏–º —Ç–æ–≤–∞—Ä—ã –≤ –Ω–æ–≤—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é
      products = products.map(p=> p.category===oldName ? {...p, category:newName} : p);
      persistentSaveCategories(categories);
      persistentSaveProducts(products);
      renderCategoryOptions(); renderCategoryList(); renderCatalog(); applyFilter();
      toastMsg('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞');
    }
    function deleteCategory(name){
      if(!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´${name}¬ª? –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ ¬´–†–∞–∑–Ω–æ–µ¬ª.`)) return;
      categories = categories.filter(c=>c!==name);
      products = products.map(p=> p.category===name ? {...p, category:'–†–∞–∑–Ω–æ–µ'} : p);
      persistentSaveCategories(categories);
      persistentSaveProducts(products);
      if(currentCategory===name) currentCategory='';
      renderCategoryOptions(); renderCategoryList(); renderCatalog(); applyFilter();
      toastMsg('–ö–∞—Ç–µ–≥–æ—Ä–∏—è —É–¥–∞–ª–µ–Ω–∞');
    }
    function addCategory(){
      const name=(prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏')||'').trim();
      if(!name) return;
      if(categories.includes(name)){ toastMsg('–¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ –µ—Å—Ç—å'); return; }
      categories = [...categories, name];
      persistentSaveCategories(categories);
      renderCategoryOptions(); renderCategoryList();
      toastMsg('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞');
    }

    /* ---------- GRID ---------- */
    const selectedSize=new Map();
    function sizeRow(p){
      const wrap=document.createElement('div'); wrap.className='sizes';
      (p.sizes||[]).forEach((s,i)=>{
        const b=document.createElement('button');
        b.type='button'; b.className='chip'+(i===0?' active':''); b.textContent=s;
        if(i===0) selectedSize.set(p.sku,s);
        b.onclick=()=>{wrap.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));b.classList.add('active');selectedSize.set(p.sku,s);hideKeyboard();};
        wrap.appendChild(b);
      });
      return wrap;
    }
    function createCard(p){
      const el=document.createElement('div'); el.className='card';

      if (IS_MODERATOR && MOD_MODE){
        const editBtn=document.createElement('button');
        editBtn.className='mod-edit'; editBtn.type='button'; editBtn.title='–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
        editBtn.textContent='‚úèÔ∏è';
        editBtn.onclick=(e)=>{ e.stopPropagation(); openEditForm(p); };
        el.appendChild(editBtn);
        el.style.cursor='pointer';
        el.onclick=(e)=>{ if(!e.target.closest('.add,.fav-toggle,.chip,.qty')) openEditForm(p); };
      }

      const heart=document.createElement('button');
      heart.className='fav-toggle'; heart.setAttribute('data-favsku', p.sku);
      heart.type='button'; heart.innerHTML='‚ô°';
      heart.onclick=()=>{toggleFav(p.sku);};
      el.appendChild(heart);

      const img=document.createElement('img');
      img.className='img'; img.decoding='async'; img.loading='eager'; img.referrerPolicy='no-referrer';
      img.alt=p.name; img.src=p.img||'';
      img.onerror=()=>{img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="800"><rect width="100%" height="100%" fill="#E5E7EB"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui" font-size="28" fill="#6B7280">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</text></svg>');};
      el.appendChild(img);

      const body=document.createElement('div'); body.className='body';
      body.innerHTML=`<div class="title">${p.name}</div><div class="desc">${p.desc||''}</div><div class="price">${money(p.price)}</div>`;
      body.appendChild(sizeRow(p));

      const controls=document.createElement('div'); controls.className='controls';
      controls.innerHTML=`<input class="qty" type="number" min="1" value="1" aria-label="–ö–æ–ª-–≤–æ"/><button class="add">–í –∫–æ—Ä–∑–∏–Ω—É</button>`;
      body.appendChild(controls);
      el.appendChild(body);

      const qtyEl=controls.querySelector('.qty');
      controls.querySelector('.add').onclick=()=>{
        const size=selectedSize.get(p.sku)||p.sizes?.[0]||'';
        addToCart({sku:p.sku,name:p.name,price:p.price,size,qty:Math.max(1,Number(qtyEl.value)||1),img:p.img});
        toastMsg('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É'); hideKeyboard();
      };
      return el;
    }
    function renderCatalog(){
      grid.innerHTML='';
      products.forEach(p=>grid.appendChild(createCard(p)));
      updateFavIcons();
      applyFilter();
    }

    /* ---------- CART ---------- */
    function keyOf(x){return `${x.sku}:${x.size}`;}
    function addToCart(item){const k=keyOf(item);const f=cart.find(x=>keyOf(x)===k);if(f)f.qty+=item.qty;else cart.push(item);updateCartUI();persistentSaveCart(cart);}
    function removeFromCart(k){cart=cart.filter(x=>keyOf(x)!==k);updateCartUI();persistentSaveCart(cart);}
    function setQty(k,val){const it=cart.find(x=>keyOf(x)===k); if(!it) return; it.qty=Math.max(1, val|0); updateCartUI();persistentSaveCart(cart);}
    function calcTotal(){return cart.reduce((s,x)=>s+x.price*x.qty,0);}
    function cartItemRow(x){
      const row=document.createElement('div'); row.className='item'; row.dataset.key=`${x.sku}:${x.size}`;
      row.innerHTML=`
        <img class="ph" src="${x.img||''}" alt="">
        <div class="meta"><div class="t">${x.name}</div><div class="s">–†–∞–∑–º–µ—Ä: ${x.size}</div></div>
        <div class="actions">
          <div class="left">
            <div class="qtyctrl">
              <button class="btnsq minus">‚àí</button>
              <input class="qtymini" type="number" min="1" value="${x.qty}">
              <button class="btnsq plus">+</button>
            </div>
            <button class="rmv">–£–±—Ä–∞—Ç—å</button>
          </div>
          <div class="t sum">${money(x.price*x.qty)}</div>
        </div>`;
      return row;
    }
    function updateCartUI(){
      cartList.innerHTML=''; cart.forEach(x=>cartList.appendChild(cartItemRow(x)));
      const count=cart.reduce((s,x)=>s+x.qty,0);
      cartCount.textContent=count; totalEl.textContent=money(calcTotal());
      fab.style.display=count?'flex':'none';
      if(tg?.MainButton){
        tg.MainButton.setParams({text:`–û–ø–ª–∞—Ç–∏—Ç—å ¬∑ ${money(calcTotal())}`});
        if(count) tg.MainButton.show(); else tg.MainButton.hide();
      }
    }
    cartList.addEventListener('click', (e)=>{
      const row=e.target.closest('.item'); if(!row) return;
      const k=row.dataset.key;
      if(e.target.classList.contains('rmv')) { removeFromCart(k); return; }
      if(e.target.classList.contains('minus')) { const it=cart.find(x=>keyOf(x)===k); if(!it) return; it.qty=Math.max(1,it.qty-1); updateCartUI(); persistentSaveCart(cart); return; }
      if(e.target.classList.contains('plus'))  { const it=cart.find(x=>keyOf(x)===k); if(!it) return; it.qty+=1; updateCartUI(); persistentSaveCart(cart); return; }
    });
    cartList.addEventListener('change', (e)=>{
      if(e.target.classList.contains('qtymini')){
        const row=e.target.closest('.item'); const k=row.dataset.key; setQty(k, Number(e.target.value)||1);
      }
    });

    /* ---------- MODERATION ---------- */
    function openEditForm(p){
      editSheet.classList.add('open');
      const isNew=!p;
      const data = p || {sku:`item-${Date.now()}`,name:'',category:'',price:0,sizes:['S','M','L'],img:'',desc:''};
      editTitle.textContent = isNew?'–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä':'–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';
      f_name.value=data.name||'';
      f_sku.value=data.sku||'';
      f_price.value=Number(data.price||0);
      f_category.value=data.category||'';
      f_sizes.value=(data.sizes||[]).join(', ');
      f_desc.value=data.desc||'';
      f_preview.src=data.img||'';
      f_delete.style.display=isNew?'none':'';
      f_save.onclick=()=>saveEdit(isNew,data.sku);
      f_delete.onclick=()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?')){ deleteProduct(data.sku); editSheet.classList.remove('open'); } };
      f_img.onchange=async (e)=>{
        const file=e.target.files?.[0]; if(!file) return;
        const url=await fileToCompressedDataURL(file, 1024, 0.85);
        f_preview.src=url;
      };
    }
    async function fileToCompressedDataURL(file, maxSize=1024, quality=0.85){
      const img = await blobToImage(file);
      const {canvas} = imageToCanvas(img, maxSize);
      return canvas.toDataURL('image/jpeg', quality);
    }
    function blobToImage(file){
      return new Promise((res,rej)=>{
        const url=URL.createObjectURL(file);
        const img=new Image();
        img.onload=()=>{ URL.revokeObjectURL(url); res(img); };
        img.onerror=(e)=>{ URL.revokeObjectURL(url); rej(e); };
        img.src=url;
      });
    }
    function imageToCanvas(img, maxSide=1024){
      const scale = Math.min(1, maxSide/Math.max(img.width, img.height));
      const w = Math.max(1, Math.round(img.width*scale));
      const h = Math.max(1, Math.round(img.height*scale));
      const canvas=document.createElement('canvas');
      canvas.width=w; canvas.height=h;
      const ctx=canvas.getContext('2d');
      ctx.drawImage(img,0,0,w,h);
      return {canvas, w, h};
    }

    async function saveEdit(isNew, oldSku){
      const name=f_name.value.trim();
      const sku=f_sku.value.trim();
      const category=(f_category.value.trim()||'–†–∞–∑–Ω–æ–µ');
      const price=Math.max(0, Number(f_price.value||0)|0);
      const sizes=f_sizes.value.split(',').map(s=>s.trim()).filter(Boolean);
      const desc=f_desc.value.trim();
      const img=f_preview.src||'';

      if(!name||!sku){ toastMsg('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ SKU'); return; }
      if(isNew && products.some(p=>p.sku===sku)){ toastMsg('–¢–∞–∫–æ–π SKU —É–∂–µ –µ—Å—Ç—å'); return; }

      if(isNew){
        products=[...products,{sku,name,category,price,sizes,desc,img}];
      }else{
        products=products.map(p=>p.sku===oldSku?{...p,sku,name,category,price,sizes,desc,img}:p);
        // —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —Å—É—â–Ω–æ—Å—Ç–µ–π
        cart = cart.map(it=> it.sku===oldSku ? {...it, sku, name, price, img} : it);
        fav  = fav.map(s => s===oldSku ? sku : s);
        await persistentSaveFav(fav);
        persistentSaveCart(cart);
      }
      // –µ—Å–ª–∏ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –±—ã–ª–æ ‚Äî –¥–æ–±–∞–≤–∏–º
      if(!categories.includes(category)){
        categories=[...categories, category];
        await persistentSaveCategories(categories);
      }
      await persistentSaveProducts(products);
      renderCategoryOptions(); renderCategoryList(); renderCatalog(); applyFilter();
      toastMsg('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
      editSheet.classList.remove('open');
    }
    async function deleteProduct(sku){
      products=products.filter(p=>p.sku!==sku);
      await persistentSaveProducts(products);
      cart = cart.filter(it=>it.sku!==sku); persistentSaveCart(cart); updateCartUI();
      fav  = fav.filter(s=>s!==sku); await persistentSaveFav(fav); updateFavUI();
      renderCatalog(); renderCategoryList();
      toastMsg('–£–¥–∞–ª–µ–Ω–æ');
    }

    /* ---------- OPEN/CLOSE ---------- */
    const openCart =()=>{sheet.classList.add('open'); favSheet.classList.remove('open'); catalogSheet.classList.remove('open'); editSheet.classList.remove('open'); hideKeyboard();}
    const closeCart=()=>sheet.classList.remove('open');
    const openFav  =()=>{favSheet.classList.add('open'); sheet.classList.remove('open'); catalogSheet.classList.remove('open'); editSheet.classList.remove('open'); hideKeyboard();}
    const closeFav =()=>favSheet.classList.remove('open');

    const openCatalog =()=>{catalogSheet.classList.add('open'); sheet.classList.remove('open'); favSheet.classList.remove('open'); editSheet.classList.remove('open'); renderCategoryList(); catToolbar.style.display = (IS_MODERATOR && MOD_MODE)?'':'none'; hideKeyboard();}
    const closeCatalog=()=>catalogSheet.classList.remove('open');

    document.getElementById('closeCart').onclick=closeCart;
    document.getElementById('closeFav').onclick=closeFav;
    document.getElementById('closeCatalog').onclick=closeCatalog;
    document.getElementById('closeEdit').onclick=()=>editSheet.classList.remove('open');

    openCartBtn.onclick=openCart;
    openFavBtn.onclick=openFav;
    openCatalogBtn.onclick=openCatalog;

    // –ú–æ–¥–µ—Ä–∞—Ü–∏—è: –±–µ–∑ –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –Ω–∞–¥–ø–∏—Å–µ–π –∏ –≤—ã—Ö–æ–¥–æ–≤
    openModBtn.onclick=()=>{
      if(!IS_MODERATOR) return;
      MOD_MODE = true;
      openCatalog(); // –Ω–∞—á–∏–Ω–∞–µ–º —Å –∫–∞—Ç–∞–ª–æ–≥–∞ (–Ω–∞–≤–∏–≥–∞—Ü–∏—è)
    };

    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏
    btnCatAdd.onclick=()=>addCategory();

    /* ---------- CHECKOUT ---------- */
    document.getElementById('checkout').onclick=tryCheckout;
    tg?.MainButton?.onClick(tryCheckout);
    async function tryCheckout(){
      if(!cart.length) return;
      if(!API){ toastMsg('API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–µ—Ä–µ–¥–∞–π—Ç–µ ?api='); return; }
      const order={items:cart.map(x=>({sku:x.sku,name:x.name,size:x.size,qty:x.qty,price:x.price})),total:calcTotal()};
      setLoading(true);
      try{
        const res=await fetch(`${API}/api/order`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({items:order.items,total:order.total,init_data:tg.initData||''})});
        if(!res.ok) throw new Error('–û—à–∏–±–∫–∞ API');
        const data=await res.json();
        tg.sendData(JSON.stringify({order_id:data.order_id,...order}));
        tg.close();
      }catch(e){
        setLoading(false); toastMsg(e.message||'–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑');
      }
    }
    function setLoading(v){if(tg?.MainButton){tg.MainButton.setParams({is_active:!v}); if(v) tg.HapticFeedback.impactOccurred('light');}}

    /* ---------- SEARCH & FILTER ---------- */
    function applyFilter(){
      const s=(q.value||'').trim().toLowerCase();
      const cards=[...grid.children];
      cards.forEach((card,i)=>{
        const p=products[i];
        const hitText = !s || p.name.toLowerCase().includes(s) || p.sku.toLowerCase().includes(s) || (p.category||'').toLowerCase().includes(s);
        const hitCat  = !currentCategory || (p.category||'').toLowerCase() === currentCategory.toLowerCase();
        card.style.display=(hitText && hitCat)?'':'none';
      });
    }
    q.addEventListener('input',applyFilter);
    q.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); hideKeyboard(); }});
    clearBtn.onclick=()=>{ q.value=''; applyFilter(); hideKeyboard(); };

    /* ---------- AUTH / INIT ---------- */
    async function fetchModeratorFlag(){
      try{
        if(!API) return false;
        const res=await fetch(`${API}/api/auth/me`,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({init_data: tg.initData || ''})
        });
        if(!res.ok) return false;
        const data=await res.json();
        return !!data.is_moderator;
      }catch{return false}
    }
    (async function init(){
      fav = await persistentLoadFav();
      cart = persistentLoadCart();
      const loadedP = await persistentLoadProducts();
      products = (loadedP || DEFAULT_PRODUCTS.slice()).map(p=>({category:'–†–∞–∑–Ω–æ–µ', ...p, category: p.category || p.cat || '–†–∞–∑–Ω–æ–µ'}));
      await persistentSaveProducts(products);

      categories = await persistentLoadCategories();
      // —É–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ–∫—Ä—ã–≤–∞—é—Ç —Ç–æ–≤–∞—Ä—ã
      for(const p of products){ if(!categories.includes(p.category)) categories.push(p.category); }
      await persistentSaveCategories(categories);

      renderCategoryOptions();
      renderCatalog();
      updateCartUI();
      updateFavUI();

      IS_MODERATOR = await fetchModeratorFlag();
      openModBtn.style.display = IS_MODERATOR ? '' : 'none';
    })();
  </script>
</body>
</html>
