<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ú–∞–≥–∞–∑–∏–Ω –æ–¥–µ–∂–¥—ã</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      /* –ë–∞–∑–æ–≤—ã–µ —Ü–≤–µ—Ç–∞ ‚Äî –ø–æ–¥—Ö–≤–∞—Ç—ã–≤–∞–µ–º –∏–∑ —Ç–µ–º—ã Telegram */
      --bg: #ffffff;
      --text: #111111;
      --subtext: #5b5b5b;
      --card: #ffffff;
      --muted: #f1f1f4;
      --accent: #2a85ff;
      --accent-contrast: #ffffff;
      --border: rgba(0,0,0,.08);
      --shadow: 0 6px 24px rgba(0,0,0,.08);
      --radius: 16px;
      --radius-sm: 12px;
      --radius-lg: 22px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --trans-fast: 160ms cubic-bezier(.2,.8,.2,1);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f1113;
        --text: #f3f4f6;
        --subtext: #a1a1aa;
        --card: #15181b;
        --muted: #1b1f24;
        --accent: #2a85ff;
        --accent-contrast: #ffffff;
        --border: rgba(255,255,255,.06);
        --shadow: 0 6px 24px rgba(0,0,0,.35);
      }
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
      padding-bottom: calc(72px + var(--safe-bottom));
    }

    /* –®–∞–ø–∫–∞ */
    .appbar {
      position: sticky; top: 0; z-index: 20;
      background: linear-gradient(180deg, rgba(0,0,0,.04), transparent);
      padding: calc(12px + var(--safe-top)) 16px 8px;
      backdrop-filter: saturate(120%) blur(8px);
      border-bottom: 1px solid var(--border);
    }
    .row { display: flex; align-items: center; gap: 12px; }
    .grow { flex: 1; }
    .brand {
      display: flex; align-items: center; gap: 10px;
      font-weight: 700; letter-spacing: .2px;
    }
    .brand .logo {
      width: 32px; height: 32px; border-radius: 10px;
      background: var(--muted); display: grid; place-items: center;
      box-shadow: var(--shadow); font-size: 18px;
    }
    .search {
      position: relative;
    }
    .search input {
      width: 100%; padding: 10px 12px 10px 36px;
      background: var(--muted); color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px; outline: none;
    }
    .search svg {
      position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
      opacity: .7;
    }
    .iconbtn {
      display: grid; place-items: center;
      width: 40px; height: 40px; border-radius: 12px;
      background: var(--muted); border: 1px solid var(--border);
      transition: transform var(--trans-fast);
    }
    .iconbtn:active { transform: scale(.96); }

    /* –ì—Ä–∏–¥ –∫–∞—Ä—Ç–æ—á–µ–∫ */
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    .grid {
      display: grid; gap: 16px;
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    @media (min-width: 760px) {
      .grid { grid-template-columns: repeat(3, minmax(0,1fr)); }
    }
    @media (min-width: 992px) {
      .grid { grid-template-columns: repeat(4, minmax(0,1fr)); }
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: var(--shadow);
      display: flex; flex-direction: column;
      transition: transform var(--trans-fast), box-shadow var(--trans-fast);
    }
    .card:hover { transform: translateY(-2px); }
    .img {
      aspect-ratio: 1/1; width: 100%;
      background: var(--muted);
      display: grid; place-items: center;
      font-weight: 700; letter-spacing: .5px;
      user-select: none;
    }
    .body { padding: 12px; display: grid; gap: 8px; }
    .title { font-weight: 700; }
    .muted { color: var(--subtext); font-size: 13px; }
    .price { font-weight: 800; margin-top: 2px; }
    .controls { display: flex; gap: 8px; align-items: center; margin-top: 4px; }
    select, .qty {
      flex: 1;
      padding: 8px 10px;
      background: var(--muted); color: var(--text);
      border: 1px solid var(--border); border-radius: 10px;
    }
    .add {
      padding: 10px 12px; border: none; border-radius: 12px;
      background: var(--accent); color: var(--accent-contrast);
      font-weight: 700; cursor: pointer;
      transition: transform var(--trans-fast), opacity var(--trans-fast);
    }
    .add:active { transform: translateY(1px); opacity: .9; }

    /* –ö–æ—Ä–∑–∏–Ω–∞ (—Å–∞–π–¥-—Å–ª–æ–π) */
    .sheet {
      position: fixed; right: 0; top: 0; height: 100%; width: min(92vw, 380px);
      background: var(--card); border-left: 1px solid var(--border);
      box-shadow: var(--shadow);
      transform: translateX(100%); transition: transform var(--trans-fast);
      z-index: 50; display: flex; flex-direction: column;
    }
    .sheet.open { transform: translateX(0); }
    .sheet .head {
      padding: calc(8px + var(--safe-top)) 16px 10px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 10px;
    }
    .sheet .list {
      padding: 10px 12px; overflow: auto; flex: 1; display: grid; gap: 10px;
    }
    .item {
      display: grid; grid-template-columns: 56px 1fr auto; gap: 10px; align-items: center;
      background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 8px;
    }
    .item .ph { width: 56px; height: 56px; border-radius: 10px; background: var(--muted); display: grid; place-items: center; font-size: 12px; }
    .item .meta .t { font-weight: 700; }
    .item .meta .s { font-size: 12px; color: var(--subtext); }
    .item .act { display: grid; gap: 6px; justify-items: end; }
    .item .rmv {
      padding: 6px 10px; border-radius: 10px; border: 1px solid var(--border); background: var(--muted); cursor: pointer;
    }
    .foot {
      border-top: 1px solid var(--border);
      padding: 12px 16px calc(12px + var(--safe-bottom));
      display: grid; gap: 10px;
    }
    .total { display: flex; justify-content: space-between; font-weight: 800; }

    /* –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã */
    .fab {
      position: fixed; right: 16px; bottom: calc(16px + var(--safe-bottom));
      display: flex; align-items: center; gap: 10px;
      background: var(--card); border: 1px solid var(--border); box-shadow: var(--shadow);
      padding: 10px 14px; border-radius: 999px; z-index: 40;
    }
    .badge {
      min-width: 22px; height: 22px; border-radius: 999px;
      background: var(--accent); color: var(--accent-contrast); display: grid; place-items: center;
      font-size: 12px; font-weight: 800; padding: 0 6px;
    }

    /* –¢–æ—Å—Ç */
    .toast {
      position: fixed; left: 50%; bottom: calc(90px + var(--safe-bottom));
      transform: translateX(-50%) translateY(20px);
      background: var(--text); color: var(--bg);
      padding: 10px 14px; border-radius: 12px;
      opacity: 0; transition: opacity var(--trans-fast), transform var(--trans-fast);
      z-index: 60; font-weight: 600;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <!-- –®–∞–ø–∫–∞ -->
  <header class="appbar">
    <div class="row">
      <div class="brand">
        <div class="logo">TS</div>
        <div>TG Shop</div>
      </div>
      <div class="grow search">
        <input id="q" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É‚Ä¶" />
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.2-4.2M10.8 18a7.2 7.2 0 1 1 0-14.4 7.2 7.2 0 0 1 0 14.4Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
      </div>
      <button id="openCart" class="iconbtn" title="–ö–æ—Ä–∑–∏–Ω–∞">
        üõí
      </button>
    </div>
  </header>

  <!-- –ö–æ–Ω—Ç–µ–Ω—Ç -->
  <main class="wrap">
    <div id="grid" class="grid"></div>
  </main>

  <!-- –ü–ª–∞–≤–∞—é—â–∞—è –∫–Ω–æ–ø–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã -->
  <div class="fab" id="fabCart" style="display:none;">
    <span>–ö–æ—Ä–∑–∏–Ω–∞</span>
    <span class="badge" id="cartCount">0</span>
  </div>

  <!-- –°–∞–π–¥-—Å–ª–æ–π –∫–æ—Ä–∑–∏–Ω—ã -->
  <aside class="sheet" id="sheet">
    <div class="head">
      <button id="closeCart" class="iconbtn" title="–ù–∞–∑–∞–¥">‚Üê</button>
      <div class="title">–í–∞—à –∑–∞–∫–∞–∑</div>
    </div>
    <div class="list" id="cartList"></div>
    <div class="foot">
      <div class="total"><span>–ò—Ç–æ–≥–æ</span><span id="total">0 ‚ÇΩ</span></div>
      <button id="checkout" class="add">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
    </div>
  </aside>

  <!-- –¢–æ—Å—Ç -->
  <div class="toast" id="toast">–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É</div>

  <script>
    // --- Telegram Theme ‚Üí CSS vars ---
    const tg = window.Telegram.WebApp;
    tg.expand();
    function applyTheme() {
      const p = tg.themeParams || {};
      const map = {
        '--bg': p.bg_color,
        '--text': p.text_color,
        '--subtext': p.hint_color,
        '--card': p.secondary_bg_color,
        '--muted': p.section_bg_color,
        '--accent': p.button_color,
        '--accent-contrast': p.button_text_color,
        '--border': p.section_separator_color ? hexToRgba(p.section_separator_color, .6) : null
      };
      for (const k in map) if (map[k]) document.documentElement.style.setProperty(k, map[k]);
    }
    function hexToRgba(hex, a=1){const h=hex.replace('#','');const bi=parseInt(h,16);return`rgba(${bi>>16&255},${bi>>8&255},${bi&255},${a})`;}
    applyTheme();
    tg.onEvent('themeChanged', applyTheme);

    // --- –ö–æ–Ω—Ñ–∏–≥ API ---
    const FALLBACK_API = ''; // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Å—é–¥–∞ –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–æ–¥-API
    const API_BASE = (new URLSearchParams(location.search).get('api') || FALLBACK_API).replace(/\/+$/,'');
    async function callCreateOrder(order){
      if(!API_BASE){ throw new Error('API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±—ç–∫–µ–Ω–¥ –∏ –ø–µ—Ä–µ–¥–∞–π—Ç–µ ?api=...'); }
      const body = JSON.stringify({ items: order.items, total: order.total, init_data: tg.initData || "" });
      const res = await fetch(`${API_BASE}/api/order`, { method:'POST', headers:{'Content-Type':'application/json'}, body });
      if(!res.ok){ const e = await res.json().catch(()=>({detail:`HTTP ${res.status}`})); throw new Error(e.detail || '–û—à–∏–±–∫–∞ API'); }
      return res.json();
    }

    // --- –î–µ–º–æ-–∫–∞—Ç–∞–ª–æ–≥ (–º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å –∫ /api/products) ---
    const products = [
      { sku:'ts-basic', name:'–§—É—Ç–±–æ–ª–∫–∞ Basic', price: 1290, sizes:['S','M','L','XL'] },
      { sku:'hd-classic', name:'–•—É–¥–∏ Classic', price: 3290, sizes:['S','M','L','XL'] },
      { sku:'js-urban', name:'–î–∂–∏–Ω—Å—ã Urban', price: 3990, sizes:['28','30','32','34','36'] },
      { sku:'jk-bomber', name:'–ë–æ–º–±–µ—Ä Air', price: 5490, sizes:['S','M','L'] },
      { sku:'sk-midi', name:'–Æ–±–∫–∞ Midi', price: 2790, sizes:['XS','S','M','L'] },
      { sku:'sh-chino', name:'–ë—Ä—é–∫–∏ Chino', price: 3490, sizes:['30','32','34','36'] },
      { sku:'cs-oversize', name:'–õ–æ–Ω–≥—Å–ª–∏–≤ Oversize', price: 1890, sizes:['S','M','L','XL'] },
      { sku:'ct-rain', name:'–ü–ª–∞—â Rain', price: 5990, sizes:['S','M','L'] },
    ];

    // --- –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ ---
    const grid = document.getElementById('grid');
    function money(v){ return v.toLocaleString('ru-RU') + ' ‚ÇΩ'; }
    function createCard(p){
      const el = document.createElement('div');
      el.className = 'card';
      el.innerHTML = `
        <div class="img">IMG</div>
        <div class="body">
          <div class="title">${p.name}</div>
          <div class="muted">–ê—Ä—Ç–∏–∫—É–ª: ${p.sku}</div>
          <div class="price">${money(p.price)}</div>
          <div class="controls">
            <select aria-label="–†–∞–∑–º–µ—Ä">
              ${p.sizes.map(s=>`<option>${s}</option>`).join('')}
            </select>
            <input class="qty" type="number" min="1" value="1" aria-label="–ö–æ–ª-–≤–æ" />
          </div>
          <button class="add">–í –∫–æ—Ä–∑–∏–Ω—É</button>
        </div>`;
      const sizeEl = el.querySelector('select');
      const qtyEl  = el.querySelector('.qty');
      el.querySelector('.add').onclick = () => {
        addToCart({ sku:p.sku, name:p.name, price:p.price, size:sizeEl.value, qty: Number(qtyEl.value) || 1 });
        showToast('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
      };
      return el;
    }
    products.forEach(p => grid.appendChild(createCard(p)));

    // --- –ö–æ—Ä–∑–∏–Ω–∞ ---
    let cart = [];
    const sheet = document.getElementById('sheet');
    const cartList = document.getElementById('cartList');
    const cartCount = document.getElementById('cartCount');
    const totalEl = document.getElementById('total');
    const fab = document.getElementById('fabCart');

    function addToCart(item){
      const key = `${item.sku}:${item.size}`;
      const found = cart.find(x => `${x.sku}:${x.size}` === key);
      if(found) found.qty += item.qty; else cart.push(item);
      updateCartUI();
    }
    function removeFromCart(key){
      cart = cart.filter(x => `${x.sku}:${x.size}` !== key);
      updateCartUI();
    }
    function calcTotal(){
      return cart.reduce((s,x)=> s + x.price * x.qty, 0);
    }
    function updateCartUI(){
      cartList.innerHTML = '';
      cart.forEach(x => {
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `
          <div class="ph">IMG</div>
          <div class="meta">
            <div class="t">${x.name}</div>
            <div class="s">–†–∞–∑–º–µ—Ä: ${x.size} ¬∑ ${x.qty} —à—Ç.</div>
          </div>
          <div class="act">
            <div class="t">${money(x.price * x.qty)}</div>
            <button class="rmv">–£–±—Ä–∞—Ç—å</button>
          </div>`;
        row.querySelector('.rmv').onclick = () => removeFromCart(`${x.sku}:${x.size}`);
        cartList.appendChild(row);
      });
      const count = cart.reduce((s,x)=>s+x.qty,0);
      cartCount.textContent = count;
      totalEl.textContent = money(calcTotal());
      fab.style.display = count ? 'flex' : 'none';
      tg.MainButton.setParams({ text: `–û–ø–ª–∞—Ç–∏—Ç—å ¬∑ ${money(calcTotal())}` });
      if(count) tg.MainButton.show(); else tg.MainButton.hide();
    }

    // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    const openCart = () => sheet.classList.add('open');
    const closeCart = () => sheet.classList.remove('open');
    document.getElementById('openCart').onclick = openCart;
    document.getElementById('closeCart').onclick = closeCart;
    document.getElementById('fabCart').onclick = openCart;

    // --- –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ---
    document.getElementById('checkout').onclick = tryCheckout;
    tg.MainButton.onClick(tryCheckout);

    async function tryCheckout(){
      if(!cart.length) return;
      const order = {
        items: cart.map(x => ({ sku:x.sku, name:x.name, size:x.size, qty:x.qty, price:x.price })),
        total: calcTotal()
      };
      setLoading(true);
      try {
        const res = await callCreateOrder(order); // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –±—ç–∫–µ (initData –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è —Ç–∞–º)
        // –ø–æ –∂–µ–ª–∞–Ω–∏—é ‚Äî —à–ª—ë–º –¥–∞–Ω–Ω—ã–µ –±–æ—Ç—É –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        tg.sendData(JSON.stringify({ order_id: res.order_id, ...order }));
        tg.close();
      } catch (e) {
        setLoading(false);
        alert(e.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑');
      }
    }

    function setLoading(v){
      tg.MainButton.setParams({ is_active: !v });
      if(v) tg.HapticFeedback.impactOccurred('light');
    }

    // --- –ü–æ–∏—Å–∫ (–∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π —Ñ–∏–ª—å—Ç—Ä) ---
    document.getElementById('q').addEventListener('input', (e)=>{
      const q = e.target.value.trim().toLowerCase();
      grid.querySelectorAll('.card').forEach((card,i)=>{
        const p = products[i];
        const hit = !q || p.name.toLowerCase().includes(q) || p.sku.toLowerCase().includes(q);
        card.style.display = hit ? '' : 'none';
      });
    });

    // --- –¢–æ—Å—Ç ---
    const toast = document.getElementById('toast');
    let toastTid;
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(toastTid);
      toastTid = setTimeout(()=> toast.classList.remove('show'), 1400);
      tg.HapticFeedback.notificationOccurred('success');
    }
  </script>
</body>
</html>
