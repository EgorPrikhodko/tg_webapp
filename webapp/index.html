<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Магазин одежды</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --pad: 14px;
      --radius: 16px;
      --shadow: 0 6px 24px rgba(0,0,0,.08);
      --muted: #666;
      --bg: #fff;
      --card: #fff;
      --line: #eaeaea;
    }
    html,body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); }
    header { position: sticky; top: 0; backdrop-filter: blur(6px); padding: var(--pad); font-weight: 700; box-shadow: var(--shadow); background: var(--bg); z-index: 10; }
    .wrap { padding: var(--pad); max-width: 1000px; margin: 0 auto; }

    /* навигация */
    .tabs { display: flex; gap: 8px; margin: 0 0 12px; }
    .tab { padding: 10px 14px; border: 1px solid var(--line); border-radius: 999px; background: var(--card); cursor: pointer; }
    .tab.active { border-color: #111; }

    /* каталог */
    .filters { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0 16px; }
    .filters select, .filters input { padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px,1fr)); gap: 14px; }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; display: flex; flex-direction: column; }
    .card img { width: 100%; aspect-ratio: 4/3; object-fit: cover; background: #f3f3f3; }
    .card .info { padding: 10px 12px; display: grid; gap: 6px; }
    .price { font-weight: 700; }
    .muted { color: var(--muted); font-size: 14px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .row select, .row button { padding: 10px; border-radius: 10px; border: 1px solid #ddd; }
    .row button { cursor: pointer; border: none; background: #111; color: #fff; }

    .empty { text-align: center; color: var(--muted); padding: 40px 10px; }

    /* корзина */
    .cart-list { display: grid; gap: 10px; }
    .cart-item { display: grid; grid-template-columns: 90px 1fr auto; gap: 10px; padding: 10px; border: 1px solid var(--line); border-radius: 12px; background: var(--card); align-items: center; }
    .cart-item img { width: 90px; height: 70px; object-fit: cover; border-radius: 8px; background: #f3f3f3; }
    .cart-title { font-weight: 600; }
    .cart-meta { color: var(--muted); font-size: 13px; }
    .qty { display: inline-flex; align-items: center; gap: 8px; border: 1px solid var(--line); border-radius: 10px; padding: 6px 8px; }
    .qty button { border: none; background: #111; color: #fff; border-radius: 8px; padding: 4px 8px; cursor: pointer; }
    .remove { background: transparent; border: 1px solid #f00; color: #f00; border-radius: 8px; padding: 6px 10px; cursor: pointer; }
    .cart-summary { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px dashed var(--line); border-radius: 12px; margin-top: 12px; background: var(--card); }
    .cart-total { font-size: 16px; font-weight: 700; }
  </style>
</head>
<body>
  <header class="wrap">Магазин одежды</header>
  <div class="wrap">
    <!-- вкладки -->
    <div class="tabs">
      <div id="tab-catalog" class="tab active">Каталог</div>
      <div id="tab-cart" class="tab">Корзина</div>
    </div>

    <!-- КАТАЛОГ -->
    <section id="view-catalog">
      <div class="filters">
        <input id="q" placeholder="Поиск по названию…">
        <select id="category">
          <option value="">Все категории</option>
          <option>Футболки</option>
          <option>Худи</option>
          <option>Штаны</option>
          <option>Платья</option>
        </select>
      </div>

      <div id="grid" class="grid"></div>
      <div id="empty" class="empty" style="display:none;">Ничего не найдено</div>
    </section>

    <!-- КОРЗИНА -->
    <section id="view-cart" style="display:none;">
      <div id="cart-empty" class="empty" style="display:none;">Ваша корзина пуста</div>
      <div id="cart-list" class="cart-list"></div>
      <div id="cart-summary" class="cart-summary" style="display:none;">
        <div class="cart-total"></div>
        <div class="muted">Нажмите «Оформить» внизу</div>
      </div>
    </section>
  </div>

  <script>
    const tg = window.Telegram?.WebApp;
    tg?.expand();
    if (tg?.themeParams?.bg_color) document.documentElement.style.setProperty('--bg', tg.themeParams.bg_color);

    const PRODUCTS = [
      {id:1, name:"Футболка Basic", price:1990, category:"Футболки", colors:["Белый","Чёрный"], sizes:["S","M","L"], img:"https://placehold.co/600x450?text=Футболка"},
      {id:2, name:"Худи Soft",    price:4490, category:"Худи",     colors:["Серый","Чёрный"], sizes:["M","L","XL"], img:"https://placehold.co/600x450?text=Худи"},
      {id:3, name:"Штаны Relax",  price:3990, category:"Штаны",    colors:["Синий","Чёрный"], sizes:["M","L"],     img:"https://placehold.co/600x450?text=Штаны"},
      {id:4, name:"Платье Summer",price:5490, category:"Платья",   colors:["Красный","Белый"],sizes:["S","M"],      img:"https://placehold.co/600x450?text=Платье"},
    ];

    const CART_KEY = "tg_shop_cart";
    const loadCart = () => JSON.parse(localStorage.getItem(CART_KEY) || "[]");
    const saveCart = (cart) => localStorage.setItem(CART_KEY, JSON.stringify(cart));
    const cart = loadCart();

    const state = { q: "", category: "", view: "catalog" }; // catalog | cart

    // DOM refs
    const byId = (id) => document.getElementById(id);
    const grid = byId("grid");
    const empty = byId("empty");
    const qInput = byId("q");
    const catSel = byId("category");

    const tabCatalog = byId("tab-catalog");
    const tabCart = byId("tab-cart");
    const viewCatalog = byId("view-catalog");
    const viewCart = byId("view-cart");
    const cartList = byId("cart-list");
    const cartEmpty = byId("cart-empty");
    const cartSummary = byId("cart-summary");
    const cartTotalEl = cartSummary.querySelector(".cart-total");

    // --- навигация между вкладками ---
    function setView(name) {
      state.view = name; // "catalog" | "cart"
      // вкладки
      tabCatalog.classList.toggle("active", name === "catalog");
      tabCart.classList.toggle("active", name === "cart");
      // секции
      viewCatalog.style.display = (name === "catalog") ? "" : "none";
      viewCart.style.display = (name === "cart") ? "" : "none";

      if (name === "catalog") {
        renderCatalog();
      } else {
        renderCart();
      }
      updateMainButton(); // чтобы обновить надпись/видимость
    }

    tabCatalog.addEventListener("click", () => setView("catalog"));
    tabCart.addEventListener("click", () => setView("cart"));

    // --- фильтры каталога ---
    qInput.addEventListener("input", () => { state.q = qInput.value.trim().toLowerCase(); renderCatalog(); });
    catSel.addEventListener("change", () => { state.category = catSel.value; renderCatalog(); });

    function priceFmt(n) { return n.toLocaleString('ru-RU') + " ₽"; }

    function filtered() {
      return PRODUCTS.filter(p => {
        const okCat = !state.category || p.category === state.category;
        const okQ = !state.q || p.name.toLowerCase().includes(state.q);
        return okCat && okQ;
      });
    }

    // --- Каталог ---
    function addToCart(product, size, color) {
      if (!size || !color) {
        alert("Выберите размер и цвет");
        return;
      }
      // если такая позиция уже есть (id+size+color) — увеличим qty вместо push
      const exist = cart.find(i => i.id === product.id && i.size === size && i.color === color);
      if (exist) {
        exist.qty += 1;
      } else {
        cart.push({ id: product.id, name: product.name, price: product.price, size, color, qty: 1, img: product.img });
      }
      saveCart(cart);
      updateMainButton();
    }

    function renderCatalog() {
      const items = filtered();
      grid.innerHTML = "";
      if (items.length === 0) {
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      for (const p of items) {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <img alt="${p.name}" src="${p.img}">
          <div class="info">
            <div>${p.name}</div>
            <div class="price">${priceFmt(p.price)}</div>
            <div class="muted">${p.category}</div>
            <div class="row">
              <select class="size">
                <option value="">Размер</option>
                ${p.sizes.map(s=>`<option>${s}</option>`).join("")}
              </select>
              <select class="color">
                <option value="">Цвет</option>
                ${p.colors.map(c=>`<option>${c}</option>`).join("")}
              </select>
              <button class="add">В корзину</button>
            </div>
          </div>
        `;
        const sizeSel = card.querySelector(".size");
        const colorSel = card.querySelector(".color");
        card.querySelector(".add").addEventListener("click", () => {
          addToCart(p, sizeSel.value, colorSel.value);
        });
        grid.appendChild(card);
      }
    }

    // --- Корзина ---
    function cartTotals() {
      const totalQty = cart.reduce((s, i) => s + i.qty, 0);
      const totalSum = cart.reduce((s, i) => s + i.qty * i.price, 0);
      return { totalQty, totalSum };
    }

    function changeQty(item, delta) {
      item.qty += delta;
      if (item.qty <= 0) {
        const idx = cart.indexOf(item);
        if (idx >= 0) cart.splice(idx, 1);
      }
      saveCart(cart);
      renderCart();
      updateMainButton();
    }

    function removeItem(item) {
      const idx = cart.indexOf(item);
      if (idx >= 0) cart.splice(idx, 1);
      saveCart(cart);
      renderCart();
      updateMainButton();
    }

    function renderCart() {
      cartList.innerHTML = "";
      if (cart.length === 0) {
        cartEmpty.style.display = "block";
        cartSummary.style.display = "none";
        return;
      }
      cartEmpty.style.display = "none";

      for (const item of cart) {
        const row = document.createElement("div");
        row.className = "cart-item";
        row.innerHTML = `
          <img src="${item.img || 'https://placehold.co/160x120'}" alt="">
          <div>
            <div class="cart-title">${item.name}</div>
            <div class="cart-meta">Размер: ${item.size} · Цвет: ${item.color}</div>
            <div class="cart-meta">${priceFmt(item.price)} за шт.</div>
          </div>
          <div style="display:grid; gap:8px; justify-items:end;">
            <div class="qty">
              <button class="dec">−</button>
              <span>${item.qty}</span>
              <button class="inc">+</button>
            </div>
            <button class="remove">Удалить</button>
          </div>
        `;
        row.querySelector(".dec").addEventListener("click", () => changeQty(item, -1));
        row.querySelector(".inc").addEventListener("click", () => changeQty(item, +1));
        row.querySelector(".remove").addEventListener("click", () => removeItem(item));
        cartList.appendChild(row);
      }

      const { totalQty, totalSum } = cartTotals();
      cartTotalEl.textContent = `Итого: ${totalQty} шт • ${priceFmt(totalSum)}`;
      cartSummary.style.display = "";
    }

    // --- MainButton (оформление) ---
    function updateMainButton() {
      if (!tg) return;
      const { totalQty, totalSum } = cartTotals();
      if (totalQty > 0) {
        const text = state.view === "cart"
          ? `Оформить (${totalQty} • ${priceFmt(totalSum)})`
          : `В корзине: ${totalQty} • ${priceFmt(totalSum)}`;
        tg.MainButton.setText(text).show();
      } else {
        tg.MainButton.hide();
      }
    }

    // отправка корзины боту
    tg?.MainButton.onClick(() => {
      const payload = {
        cart,
        ...cartTotals(),
        ts: Date.now()
      };
      tg.sendData(JSON.stringify(payload));
    });

    // init
    renderCatalog();
    setView("catalog");
    updateMainButton();
  </script>
</body>
</html>
