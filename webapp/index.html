<script>
  // Telegram theme
  const tg = window.Telegram.WebApp; tg.expand();
  function applyTheme(){
    const p = tg.themeParams || {};
    const map = {'--bg':p.bg_color,'--text':p.text_color,'--subtext':p.hint_color,'--card':p.secondary_bg_color,'--muted':p.section_bg_color,'--accent':p.button_color,'--accent-contrast':p.button_text_color,'--border':p.section_separator_color?hexToRgba(p.section_separator_color,.6):null};
    for(const k in map) if(map[k]) document.documentElement.style.setProperty(k,map[k]);
  }
  function hexToRgba(hex,a=1){const h=(hex||'').replace('#','');const bi=parseInt(h||'0',16)||0;return`rgba(${bi>>16&255},${bi>>8&255},${bi&255},${a})`;}
  applyTheme(); tg.onEvent('themeChanged',applyTheme);

  // Backend URL (бот прокидывает ?api=...)
  const FALLBACK_API=''; 
  const API_BASE=(new URLSearchParams(location.search).get('api')||FALLBACK_API).replace(/\/+$/,'');
  async function callCreateOrder(order){
    if(!API_BASE) throw new Error('API не настроен. Передайте ?api=');
    const body=JSON.stringify({items:order.items,total:order.total,init_data:tg.initData||""});
    const res=await fetch(`${API_BASE}/api/order`,{method:'POST',headers:{'Content-Type':'application/json'},body});
    if(!res.ok){const e=await res.json().catch(()=>({detail:`HTTP ${res.status}`}));throw new Error(e.detail||'Ошибка API');}
    return res.json();
  }

  // Каталог (положи файлы в /img на Vercel)
  const products=[
    { sku:'ts-basic',  name:'Футболка Basic',  price:1290, sizes:['S','M','L','XL'], img:'./img/ts-basic.jpg' },
    { sku:'hd-classic',name:'Худи Classic',    price:3290, sizes:['S','M','L','XL'], img:'./img/hd-classic.jpg' },
    { sku:'js-urban',  name:'Джинсы Urban',    price:3990, sizes:['28','30','32','34','36'], img:'./img/js-urban.jpg' },
    { sku:'jk-bomber', name:'Бомбер Air',      price:5490, sizes:['S','M','L'], img:'./img/jk-bomber.jpg' },
    { sku:'sk-midi',   name:'Юбка Midi',       price:2790, sizes:['XS','S','M','L'], img:'./img/sk-midi.jpg' },
    { sku:'sh-chino',  name:'Брюки Chino',     price:3490, sizes:['30','32','34','36'], img:'./img/sh-chino.jpg' },
    { sku:'cs-oversize',name:'Лонгслив Oversize', price:1890, sizes:['S','M','L','XL'], img:'./img/cs-oversize.jpg' },
    { sku:'ct-rain',   name:'Плащ Rain',       price:5990, sizes:['S','M','L'], img:'./img/ct-rain.jpg' },
  ];

  // DOM
  const grid=document.getElementById('grid');
  const q=document.getElementById('q');
  const clearBtn=document.getElementById('clearSearch');
  const sheet=document.getElementById('sheet');
  const cartList=document.getElementById('cartList');
  const cartCount=document.getElementById('cartCount');
  const totalEl=document.getElementById('total');
  const fab=document.getElementById('fabCart');
  const toast=document.getElementById('toast');

  function money(v){return v.toLocaleString('ru-RU')+' ₽';}

  // Глобальное сворачивание клавиатуры (для любых инпутов)
  function hideKeyboard(){
    const el=document.activeElement;
    if(!el) return;
    const ed=el.tagName==='INPUT'||el.tagName==='TEXTAREA'||el.isContentEditable;
    if(ed) el.blur();
  }
  document.addEventListener('pointerdown',e=>{ if(!e.target.closest('input,textarea,.chip')) hideKeyboard(); },{passive:true});
  document.addEventListener('touchend',e=>{ if(!e.target.closest('input,textarea,.chip')) hideKeyboard(); },{passive:true});
  document.addEventListener('scroll',hideKeyboard,{passive:true});

  // Размеры (в одну строку, скролл вбок)
  const selectedSize=new Map();
  function sizeRow(p){
    const wrap=document.createElement('div'); wrap.className='sizes';
    (p.sizes||[]).forEach((s,i)=>{
      const b=document.createElement('button');
      b.type='button'; b.className='chip'+(i===0?' active':''); b.textContent=s;
      if(i===0) selectedSize.set(p.sku,s);
      b.onclick=()=>{wrap.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));b.classList.add('active');selectedSize.set(p.sku,s);hideKeyboard();}
      wrap.appendChild(b);
    });
    return wrap;
  }

  // Карточка
  function createCard(p){
    const el=document.createElement('div'); el.className='card';

    const img=document.createElement('img');
    img.className='img'; img.decoding='async'; img.loading='eager'; img.referrerPolicy='no-referrer';
    img.alt=p.name; img.src=p.img;
    img.onerror=()=>{img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="800"><rect width="100%" height="100%" fill="#E5E7EB"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui" font-size="28" fill="#6B7280">Нет изображения</text></svg>');};
    el.appendChild(img);

    const body=document.createElement('div'); body.className='body';
    body.innerHTML=`<div class="title">${p.name}</div><div class="price">${money(p.price)}</div>`;
    body.appendChild(sizeRow(p));

    const controls=document.createElement('div'); controls.className='controls';
    controls.innerHTML=`<input class="qty" type="number" min="1" value="1" aria-label="Кол-во"/><button class="add">В корзину</button>`;
    body.appendChild(controls);
    el.appendChild(body);

    const qtyEl=controls.querySelector('.qty');
    el.addEventListener('pointerdown',hideKeyboard);
    controls.querySelector('.add').onclick=()=>{
      const size=selectedSize.get(p.sku)||p.sizes?.[0]||'';
      addToCart({sku:p.sku,name:p.name,price:p.price,size,qty:Math.max(1,Number(qtyEl.value)||1),img:p.img});
      showToast('Товар добавлен в корзину'); hideKeyboard();
    };
    return el;
  }

  // Рендер каталога
  products.forEach(p=>grid.appendChild(createCard(p)));

  // Корзина
  let cart=[];
  function keyOf(x){return `${x.sku}:${x.size}`;}
  function addToCart(item){const k=keyOf(item);const f=cart.find(x=>keyOf(x)===k);if(f)f.qty+=item.qty;else cart.push(item);updateCartUI();}
  function removeFromCart(k){cart=cart.filter(x=>keyOf(x)!==k);updateCartUI();}
  function setQty(k,val){const it=cart.find(x=>keyOf(x)===k); if(!it) return; it.qty=Math.max(1, val|0); updateCartUI();}
  function calcTotal(){return cart.reduce((s,x)=>s+x.price*x.qty,0);}

  function renderCartItem(x){
    const row=document.createElement('div'); row.className='item'; row.dataset.key=keyOf(x);
    row.innerHTML=`
      <img class="ph" src="${x.img}" alt="">
      <div class="meta"><div class="t">${x.name}</div><div class="s">Размер: ${x.size}</div></div>
      <div class="act">
        <div class="qtyctrl">
          <button class="btnsq minus">−</button>
          <input class="qtymini" type="number" min="1" value="${x.qty}">
          <button class="btnsq plus">+</button>
        </div>
        <div class="t sum">${money(x.price*x.qty)}</div>
        <button class="rmv">Убрать</button>
      </div>`;
    return row;
  }

  function updateCartUI(){
    cartList.innerHTML='';
    cart.forEach(x=>cartList.appendChild(renderCartItem(x)));
    const count=cart.reduce((s,x)=>s+x.qty,0);
    cartCount.textContent=count; totalEl.textContent=money(calcTotal());
    fab.style.display=count?'flex':'none';
    tg.MainButton.setParams({text:`Оплатить · ${money(calcTotal())}`});
    if(count) tg.MainButton.show(); else tg.MainButton.hide();
  }

  // Делегирование событий
  cartList.addEventListener('click', (e)=>{
    const row=e.target.closest('.item'); if(!row) return;
    const k=row.dataset.key;
    if(e.target.classList.contains('rmv')) { removeFromCart(k); return; }
    if(e.target.classList.contains('minus')) { const it=cart.find(x=>keyOf(x)===k); if(!it) return; it.qty=Math.max(1,it.qty-1); updateCartUI(); return; }
    if(e.target.classList.contains('plus'))  { const it=cart.find(x=>keyOf(x)===k); if(!it) return; it.qty+=1; updateCartUI(); return; }
  });
  cartList.addEventListener('change', (e)=>{
    if(e.target.classList.contains('qtymini')){
      const row=e.target.closest('.item'); const k=row.dataset.key; setQty(k, Number(e.target.value)||1);
    }
  });
  cartList.addEventListener('pointerdown', hideKeyboard);

  // Открытие/закрытие корзины
  const openCart=()=>{sheet.classList.add('open'); hideKeyboard();};
  const closeCart=()=>sheet.classList.remove('open');
  document.getElementById('openCart').onclick=openCart;
  document.getElementById('closeCart').onclick=closeCart;
  document.getElementById('fabCart').onclick=openCart;

  // Оформление
  document.getElementById('checkout').onclick=tryCheckout; tg.MainButton.onClick(tryCheckout);
  async function tryCheckout(){
    if(!cart.length) return;
    const order={items:cart.map(x=>({sku:x.sku,name:x.name,size:x.size,qty:x.qty,price:x.price})),total:calcTotal()};
    setLoading(true);
    try{const res=await callCreateOrder(order); tg.sendData(JSON.stringify({order_id:res.order_id,...order})); tg.close();}
    catch(e){setLoading(false); alert(e.message||'Не удалось оформить заказ');}
  }
  function setLoading(v){tg.MainButton.setParams({is_active:!v}); if(v) tg.HapticFeedback.impactOccurred('light');}

  // Поиск
  function applyFilter(){
    const s=(q.value||'').trim().toLowerCase();
    const cards=[...grid.children];
    cards.forEach((card,i)=>{
      const p=products[i]; const hit=!s || p.name.toLowerCase().includes(s) || p.sku.toLowerCase().includes(s);
      card.style.display=hit?'':'none';
    });
  }
  q.addEventListener('input',applyFilter);
  q.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); hideKeyboard(); }});
  clearBtn.onclick=()=>{ q.value=''; applyFilter(); hideKeyboard(); };

  // Toast
  let toastTid;
  function showToast(msg){toast.textContent=msg; toast.classList.add('show'); clearTimeout(toastTid); toastTid=setTimeout(()=>toast.classList.remove('show'),1400); tg.HapticFeedback.notificationOccurred('success');}
</script>
