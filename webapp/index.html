<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ú–∞–≥–∞–∑–∏–Ω –æ–¥–µ–∂–¥—ã</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg:#fff;--text:#111;--subtext:#5b5b5b;--card:#fff;--muted:#f1f1f4;
      --accent:#2a85ff;--accent-contrast:#fff;--border:rgba(0,0,0,.08);
      --shadow:0 6px 24px rgba(0,0,0,.08);
      --radius:16px;--safe-top:env(safe-area-inset-top,0px);--safe-bottom:env(safe-area-inset-bottom,0px);
      --trans-fast:160ms cubic-bezier(.2,.8,.2,1)
    }
    @media (prefers-color-scheme: dark){
      :root{--bg:#0f1113;--text:#f3f4f6;--subtext:#a1a1aa;--card:#15181b;--muted:#1b1f24;--border:rgba(255,255,255,.06);--shadow:0 6px 24px rgba(0,0,0,.35)}
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;padding-bottom:calc(72px + var(--safe-bottom))}

    /* AppBar */
    .appbar{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(0,0,0,.04),transparent);padding:calc(12px + var(--safe-top)) 12px 8px;backdrop-filter:saturate(120%) blur(8px);border-bottom:1px solid var(--border)}
    .row{display:flex;align-items:center;gap:10px}
    .grow{flex:1}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .logo{width:32px;height:32px;border-radius:10px;background:var(--muted);display:grid;place-items:center;box-shadow:var(--shadow);font-size:18px}

    /* Search */
    .search{position:relative;display:flex;gap:8px;align-items:center}
    .search .field{position:relative;flex:1}
    .search input{width:100%;padding:10px 36px;background:var(--muted);color:var(--text);border:1px solid var(--border);border-radius:12px;outline:none}
    .search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);opacity:.7}
    .search .clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);opacity:.6;border:none;background:transparent;font-size:18px;line-height:1;cursor:pointer}

    .iconbtn{display:grid;place-items:center;width:40px;height:40px;border-radius:12px;background:var(--muted);border:1px solid var(--border);cursor:pointer}

    /* GRID ‚Äî –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ —Å—Ç—Ä–æ–∫–µ */
    .wrap{max-width:1100px;margin:0 auto;padding:12px}
    .grid{
      display:grid;gap:12px;
      grid-template-columns:repeat(2,minmax(0,1fr));
      grid-auto-rows:1fr;
    }
    @media(min-width:760px){.grid{grid-template-columns:repeat(3,minmax(0,1fr))}}
    @media(min-width:992px){.grid{grid-template-columns:repeat(4,minmax(0,1fr))}}

    /* CARD */
    .card{
      background:var(--card);border:1px solid var(--border);
      border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);
      display:flex;flex-direction:column;height:100%;position:relative;
    }
    .fav-toggle{
      position:absolute;right:10px;top:10px;z-index:1;
      width:36px;height:36px;border-radius:999px;border:1px solid var(--border);
      background:var(--card);display:grid;place-items:center;user-select:none
    }
    .fav-toggle.active{background:var(--accent);color:var(--accent-contrast);border-color:transparent}
    .img{aspect-ratio:1/1;width:100%;background:var(--muted);display:block;object-fit:cover}
    .body{padding:12px;display:flex;flex-direction:column;gap:10px;flex:1}
    .title{font-weight:800}
    .price{font-weight:900;margin-top:2px}

    /* SIZES */
    .sizes{
      display:grid;grid-auto-flow:column;
      grid-auto-columns:calc((100% - 3*8px)/4);
      gap:8px;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;
      padding-bottom:2px;scrollbar-width:none;
    }
    .sizes::-webkit-scrollbar{display:none}
    .chip{
      display:grid;place-items:center;white-space:nowrap;
      padding:8px 10px;border-radius:10px;background:var(--muted);border:1px solid var(--border);cursor:pointer;user-select:none
    }
    .chip.active{background:var(--accent);color:var(--accent-contrast);border-color:transparent}

    /* bottom controls */
    .controls{display:flex;gap:8px;align-items:center;margin-top:auto}
    .qty{width:56px;padding:8px 6px;text-align:center;background:var(--muted);color:var(--text);border:1px solid var(--border);border-radius:10px}
    .add{flex:1;height:44px;border:none;border-radius:12px;background:var(--accent);color:var(--accent-contrast);font-weight:800;cursor:pointer}

    /* SHEET / PANELS */
    .sheet{position:fixed;right:0;top:0;height:100%;width:min(92vw,380px);background:var(--card);border-left:1px solid var(--border);box-shadow:var(--shadow);transform:translateX(100%);transition:transform var(--trans-fast);z-index:50;display:flex;flex-direction:column}
    .sheet.open{transform:translateX(0)}
    .sheet .head{padding:calc(8px + var(--safe-top)) 16px 10px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
    .sheet .head .title{font-weight:800}
    .sheet .list{padding:0; /* —É–±—Ä–∞–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ–ª—è */ overflow:auto;flex:1;display:grid;gap:0} /* –ù–û–õ–¨ –û–¢–°–¢–£–ü–û–í –ú–ï–ñ–î–£ –ö–ê–†–¢–û–ß–ö–ê–ú–ò */

    /* ===== –ö–û–†–ó–ò–ù–ê/–ò–ó–ë–†–ê–ù–ù–û–ï: –µ–¥–∏–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ ===== */
    :root { --cart-item-h: 112px; }

    .item{
      display:grid;
      grid-template-columns:56px 1fr;
      grid-template-rows:auto 1fr;
      grid-template-areas:
        "ph meta"
        "actions actions";
      gap:10px;
      align-items:start;
      background:var(--bg);
      border:1px solid var(--border);
      padding:8px;

      height:var(--cart-item-h);
      overflow:hidden;
      /* —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ ¬´–∑–∞–∑–æ—Ä–æ–≤¬ª –º–µ–∂–¥—É —Å–æ—Å–µ–¥—è–º–∏ */
      border-radius:0;
      border-bottom:none;
    }
    .list .item:last-child{border-bottom:1px solid var(--border)}
    .item .ph{ grid-area:ph; width:56px;height:56px;border-radius:10px;background:var(--muted);display:block;object-fit:cover }
    .item .meta{ grid-area:meta; min-width:0; }
    .item .meta .t{
      font-weight:700;
      display:-webkit-box; -webkit-line-clamp:1; -webkit-box-orient:vertical;
      overflow:hidden; text-overflow:ellipsis; white-space:normal;
    }
    .item .meta .s{
      font-size:12px;color:var(--subtext);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .item .actions{
      grid-area:actions;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-top:auto;
    }
    .item .actions .left{ display:flex; align-items:center; gap:8px; }
    .qtyctrl{ display:flex; align-items:center; gap:6px; flex-shrink:0; }
    .btnsq{ width:28px;height:28px;border-radius:8px;border:1px solid var(--border);background:var(--muted);display:grid;place-items:center;cursor:pointer; flex-shrink:0; }
    .qtymini{ width:44px;text-align:center;padding:6px;border:1px solid var(--border);border-radius:8px;background:var(--muted);color:var(--text); flex-shrink:0; }
    .item .rmv{ padding:6px 10px;border-radius:10px;border:1px solid var(--border);background:var(--muted);cursor:pointer; white-space:nowrap; }
    .item .sum{ white-space:nowrap; }

    .foot{border-top:1px solid var(--border);padding:12px 16px calc(12px + var(--safe-bottom));display:grid;gap:10px}
    .total{display:flex;justify-content:space-between;font-weight:800}

    /* FAB & TOAST */
    .fab{position:fixed;right:16px;bottom:calc(16px + var(--safe-bottom));display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--border);box-shadow:var(--shadow);padding:10px 14px;border-radius:999px;z-index:40}
    .badge{min-width:22px;height:22px;border-radius:999px;background:var(--accent);color:var(--accent-contrast);display:grid;place-items:center;font-size:12px;font-weight:800;padding:0 6px}
    .toast{position:fixed;left:50%;bottom:calc(90px + var(--safe-bottom));transform:translateX(-50%) translateY(20px);background:var(--text);color:var(--bg);padding:10px 14px;border-radius:12px;opacity:0;transition:opacity var(--trans-fast),transform var(--trans-fast);z-index:60;font-weight:600}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  </style>
</head>
<body>
  <header class="appbar">
    <div class="row">
      <div class="brand"><div class="logo">TS</div><div>TG Shop</div></div>
      <div class="grow search">
        <div class="field">
          <input id="q" inputmode="search" autocomplete="off" autocapitalize="none" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É‚Ä¶"/>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.2-4.2M10.8 18a7.2 7.2 0 1 1 0-14.4 7.2 7.2 0 0 1 0 14.4Z" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
          <button id="clearSearch" class="clear" aria-label="–û—á–∏—Å—Ç–∏—Ç—å">√ó</button>
        </div>
      </div>
      <button id="openFav" class="iconbtn" title="–ò–∑–±—Ä–∞–Ω–Ω–æ–µ">‚ô•</button>
      <button id="openCart" class="iconbtn" title="–ö–æ—Ä–∑–∏–Ω–∞">üõí</button>
    </div>
  </header>

  <main class="wrap">
    <div id="grid" class="grid"></div>
  </main>

  <div class="fab" id="fabCart" style="display:none;">
    <span>–ö–æ—Ä–∑–∏–Ω–∞</span><span class="badge" id="cartCount">0</span>
  </div>

  <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
  <aside class="sheet" id="sheet">
    <div class="head">
      <button id="closeCart" class="iconbtn" title="–ù–∞–∑–∞–¥">‚Üê</button>
      <div class="title">–ö–æ—Ä–∑–∏–Ω–∞</div>
    </div>
    <div class="list" id="cartList"></div>
    <div class="foot"><div class="total"><span>–ò—Ç–æ–≥–æ</span><span id="total">0 ‚ÇΩ</span></div><button id="checkout" class="add">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button></div>
  </aside>

  <!-- –ò–∑–±—Ä–∞–Ω–Ω–æ–µ -->
  <aside class="sheet" id="favSheet">
    <div class="head">
      <button id="closeFav" class="iconbtn" title="–ù–∞–∑–∞–¥">‚Üê</button>
      <div class="title">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
    </div>
    <div class="list" id="favList"></div>
  </aside>

  <div class="toast" id="toast">–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É</div>

  <script>
    // –û—á–∏—Å—Ç–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ–π —Å—Ç–∞—Ä–æ–π –∫–æ—Ä–∑–∏–Ω—ã –≤ localStorage (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
    try { localStorage.removeItem('cart'); } catch(e) {}

    // Telegram theme
    const tg=window.Telegram.WebApp; tg.expand();
    function applyTheme(){const p=tg.themeParams||{};const map={'--bg':p.bg_color,'--text':p.text_color,'--subtext':p.hint_color,'--card':p.secondary_bg_color,'--muted':p.section_bg_color,'--accent':p.button_color,'--accent-contrast':p.button_text_color,'--border':p.section_separator_color?hexToRgba(p.section_separator_color,.6):null};for(const k in map) if(map[k]) document.documentElement.style.setProperty(k,map[k]);}
    function hexToRgba(hex,a=1){const h=hex?.replace('#','')||'000000';const bi=parseInt(h,16)||0;return`rgba(${bi>>16&255},${bi>>8&255},${bi&255},${a})`;}
    applyTheme(); tg.onEvent('themeChanged',applyTheme);

    // Backend URL
    const FALLBACK_API='';
    const API_BASE=(new URLSearchParams(location.search).get('api')||FALLBACK_API).replace(/\/+$/,'');
    async function callCreateOrder(order){
      if(!API_BASE) throw new Error('API –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ü–µ—Ä–µ–¥–∞–π—Ç–µ ?api=');
      const body=JSON.stringify({items:order.items,total:order.total,init_data:tg.initData||""});
      const res=await fetch(`${API_BASE}/api/order`,{method:'POST',headers:{'Content-Type':'application/json'},body});
      if(!res.ok){const e=await res.json().catch(()=>({detail:`HTTP ${res.status}`}));throw new Error(e.detail||'–û—à–∏–±–∫–∞ API');}
      return res.json();
    }

    // –ö–∞—Ç–∞–ª–æ–≥
    const products=[
      { sku:'ts-basic', name:'–§—É—Ç–±–æ–ª–∫–∞ Basic', price:1290, sizes:['S','M','L','XL'], img:'https://images.unsplash.com/photo-1512436991641-6745cdb1723f?q=80&w=800&auto=format&fit=crop' },
      { sku:'hd-classic', name:'–•—É–¥–∏ Classic', price:3290, sizes:['S','M','L','XL'], img:'https://images.unsplash.com/photo-1520974735194-7b1c9a8d4a9a?q=80&w=800&auto=format&fit=crop' },
      { sku:'js-urban', name:'–î–∂–∏–Ω—Å—ã Urban', price:3990, sizes:['28','30','32','34','36'], img:'https://images.unsplash.com/photo-1520975916090-3105956dac38?q=80&w=800&auto=format&fit=crop' },
      { sku:'jk-bomber', name:'–ë–æ–º–±–µ—Ä Air', price:5490, sizes:['S','M','L'], img:'https://images.unsplash.com/photo-1551024709-8f23befc6cf7?q=80&w=800&auto=format&fit=crop' },
      { sku:'sk-midi', name:'–Æ–±–∫–∞ Midi', price:2790, sizes:['XS','S','M','L'], img:'https://images.unsplash.com/photo-1483985988355-763728e1935b?q=80&w=800&auto=format&fit=crop' },
      { sku:'sh-chino', name:'–ë—Ä—é–∫–∏ Chino', price:3490, sizes:['30','32','34','36'], img:'https://images.unsplash.com/photo-1541099649105-f69ad21f3246?q=80&w=800&auto=format&fit=crop' },
      { sku:'cs-oversize', name:'–õ–æ–Ω–≥—Å–ª–∏–≤ Oversize', price:1890, sizes:['S','M','L','XL'], img:'https://images.unsplash.com/photo-1516826957135-700dedea698c?q=80&w=800&auto=format&fit=crop' },
      { sku:'ct-rain', name:'–ü–ª–∞—â Rain', price:5990, sizes:['S','M','L'], img:'https://images.unsplash.com/photo-1520975657286-5d99a4721f85?q=80&w=800&auto=format&fit=crop' },
    ];

    // DOM
    const grid=document.getElementById('grid');
    const q=document.getElementById('q');
    const clearBtn=document.getElementById('clearSearch');
    const sheet=document.getElementById('sheet');
    const cartList=document.getElementById('cartList');
    const cartCount=document.getElementById('cartCount');
    const totalEl=document.getElementById('total');
    const fab=document.getElementById('fabCart');
    const toast=document.getElementById('toast');

    const favSheet=document.getElementById('favSheet');
    const favList=document.getElementById('favList');

    const openFavBtn=document.getElementById('openFav');
    const openCartBtn=document.getElementById('openCart');

    function money(v){return v.toLocaleString('ru-RU')+' ‚ÇΩ';}

    // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    function hideKeyboard(){
      const el=document.activeElement;
      if(!el) return;
      const ed=el.tagName==='INPUT'||el.tagName==='TEXTAREA'||el.isContentEditable;
      if(ed) el.blur();
    }
    document.addEventListener('pointerdown',e=>{ if(!e.target.closest('input,textarea,.chip')) hideKeyboard(); },{passive:true});
    document.addEventListener('touchend',e=>{ if(!e.target.closest('input,textarea,.chip')) hideKeyboard(); },{passive:true});
    document.addEventListener('scroll',hideKeyboard,{passive:true});

    // –†–∞–∑–º–µ—Ä—ã
    const selectedSize=new Map();
    function sizeRow(p){
      const wrap=document.createElement('div'); wrap.className='sizes';
      (p.sizes||[]).forEach((s,i)=>{
        const b=document.createElement('button');
        b.type='button'; b.className='chip'+(i===0?' active':''); b.textContent=s;
        if(i===0) selectedSize.set(p.sku,s);
        b.onclick=()=>{wrap.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));b.classList.add('active');selectedSize.set(p.sku,s);hideKeyboard();};
        wrap.appendChild(b);
      });
      return wrap;
    }

    // –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
    let fav=[]; // –º–∞—Å—Å–∏–≤ sku
    function isFav(sku){return fav.includes(sku);}
    function toggleFav(sku){
      if(isFav(sku)) fav=fav.filter(x=>x!==sku); else fav=[...fav, sku];
      updateFavUI(); updateFavIcons();
    }
    function addFavItemRow(p){
      const row=document.createElement('div'); row.className='item'; row.dataset.sku=p.sku;
      row.innerHTML=`
        <img class="ph" src="${p.img}" alt="">
        <div class="meta">
          <div class="t">${p.name}</div>
          <div class="s">–ê—Ä—Ç–∏–∫—É–ª: ${p.sku}</div>
        </div>
        <div class="actions">
          <div class="left">
            <button class="rmv">–£–±—Ä–∞—Ç—å</button>
          </div>
          <div>
            <button class="add">–í –∫–æ—Ä–∑–∏–Ω—É</button>
          </div>
        </div>`;
      return row;
    }
    function updateFavUI(){
      favList.innerHTML='';
      fav.forEach(sku=>{
        const p=products.find(x=>x.sku===sku);
        if(p) favList.appendChild(addFavItemRow(p));
      });
      // –±–µ–π–¥–∂ –Ω–∞ –∫–Ω–æ–ø–∫–µ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ (–ø—Ä–æ—Å—Ç–∞—è –≤–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å)
      openFavBtn.textContent = fav.length ? `‚ô• ${fav.length}` : '‚ô•';
    }
    favList.addEventListener('click',(e)=>{
      const row=e.target.closest('.item'); if(!row) return;
      const sku=row.dataset.sku;
      const p=products.find(x=>x.sku===sku); if(!p) return;
      if(e.target.classList.contains('rmv')){ toggleFav(sku); return; }
      if(e.target.classList.contains('add')){
        // –¥–æ–±–∞–≤–∏–º –≤ –∫–æ—Ä–∑–∏–Ω—É —Ç–æ–≤–∞—Ä –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º —Ä–∞–∑–º–µ—Ä–æ–º
        const size=p.sizes?.[0]||'';
        addToCart({sku:p.sku,name:p.name,price:p.price,size,qty:1,img:p.img});
        showToast('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É');
      }
    });
    function updateFavIcons(){
      document.querySelectorAll('[data-favsku]').forEach(btn=>{
        const sku=btn.getAttribute('data-favsku');
        btn.classList.toggle('active', isFav(sku));
        btn.innerHTML = isFav(sku) ? '‚ô•' : '‚ô°';
      });
    }

    // –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞
    function createCard(p){
      const el=document.createElement('div'); el.className='card';

      // –∫–Ω–æ–ø–∫–∞ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
      const heart=document.createElement('button');
      heart.className='fav-toggle'; heart.setAttribute('data-favsku', p.sku);
      heart.type='button'; heart.innerHTML='‚ô°';
      heart.onclick=()=>{toggleFav(p.sku);};
      el.appendChild(heart);

      const img=document.createElement('img');
      img.className='img'; img.decoding='async'; img.loading='eager'; img.referrerPolicy='no-referrer';
      img.alt=p.name; img.src=p.img;
      img.onerror=()=>{img.src='data:image/svg+xml;charset=utf-8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="800"><rect width="100%" height="100%" fill="#E5E7EB"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui" font-size="28" fill="#6B7280">–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</text></svg>');};
      el.appendChild(img);

      const body=document.createElement('div'); body.className='body';
      body.innerHTML=`<div class="title">${p.name}</div><div class="price">${money(p.price)}</div>`;
      body.appendChild(sizeRow(p));

      const controls=document.createElement('div'); controls.className='controls';
      controls.innerHTML=`<input class="qty" type="number" min="1" value="1" aria-label="–ö–æ–ª-–≤–æ"/><button class="add">–í –∫–æ—Ä–∑–∏–Ω—É</button>`;
      body.appendChild(controls);
      el.appendChild(body);

      const qtyEl=controls.querySelector('.qty');
      el.addEventListener('pointerdown',hideKeyboard);
      controls.querySelector('.add').onclick=()=>{
        const size=selectedSize.get(p.sku)||p.sizes?.[0]||'';
        addToCart({sku:p.sku,name:p.name,price:p.price,size,qty:Math.max(1,Number(qtyEl.value)||1),img:p.img});
        showToast('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É'); hideKeyboard();
      };
      return el;
    }

    // –†–µ–Ω–¥–µ—Ä –∫–∞—Ç–∞–ª–æ–≥–∞
    products.forEach(p=>grid.appendChild(createCard(p)));
    updateFavIcons();

    // –ö–æ—Ä–∑–∏–Ω–∞
    let cart=[]; // –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º, –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –æ—á–∏—â–∞–µ—Ç—Å—è
    function keyOf(x){return `${x.sku}:${x.size}`;}
    function addToCart(item){const k=keyOf(item);const f=cart.find(x=>keyOf(x)===k);if(f)f.qty+=item.qty;else cart.push(item);updateCartUI();}
    function removeFromCart(k){cart=cart.filter(x=>keyOf(x)!==k);updateCartUI();}
    function setQty(k,val){const it=cart.find(x=>keyOf(x)===k); if(!it) return; it.qty=Math.max(1, val|0); updateCartUI();}
    function calcTotal(){return cart.reduce((s,x)=>s+x.price*x.qty,0);}

    function renderCartItem(x){
      const row=document.createElement('div'); row.className='item'; row.dataset.key=`${x.sku}:${x.size}`;
      row.innerHTML=`
        <img class="ph" src="${x.img}" alt="">
        <div class="meta">
          <div class="t">${x.name}</div>
          <div class="s">–†–∞–∑–º–µ—Ä: ${x.size}</div>
        </div>
        <div class="actions">
          <div class="left">
            <div class="qtyctrl">
              <button class="btnsq minus">‚àí</button>
              <input class="qtymini" type="number" min="1" value="${x.qty}">
              <button class="btnsq plus">+</button>
            </div>
            <button class="rmv">–£–±—Ä–∞—Ç—å</button>
          </div>
          <div class="t sum">${money(x.price*x.qty)}</div>
        </div>`;
      return row;
    }

    function updateCartUI(){
      cartList.innerHTML='';
      cart.forEach(x=>cartList.appendChild(renderCartItem(x)));
      const count=cart.reduce((s,x)=>s+x.qty,0);
      cartCount.textContent=count; totalEl.textContent=money(calcTotal());
      fab.style.display=count?'flex':'none';
      tg.MainButton.setParams({text:`–û–ø–ª–∞—Ç–∏—Ç—å ¬∑ ${money(calcTotal())}`});
      if(count) tg.MainButton.show(); else tg.MainButton.hide();
    }

    // –î–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ä–∑–∏–Ω—ã
    cartList.addEventListener('click', (e)=>{
      const row=e.target.closest('.item'); if(!row) return;
      const k=row.dataset.key;
      if(e.target.classList.contains('rmv')) { removeFromCart(k); return; }
      if(e.target.classList.contains('minus')) { const it=cart.find(x=>keyOf(x)===k); if(!it) return; it.qty=Math.max(1,it.qty-1); updateCartUI(); return; }
      if(e.target.classList.contains('plus'))  { const it=cart.find(x=>keyOf(x)===k); if(!it) return; it.qty+=1; updateCartUI(); return; }
    });
    cartList.addEventListener('change', (e)=>{
      if(e.target.classList.contains('qtymini')){
        const row=e.target.closest('.item'); const k=row.dataset.key; setQty(k, Number(e.target.value)||1);
      }
    });
    cartList.addEventListener('pointerdown', hideKeyboard);

    // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –∏ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ
    const openCart=()=>{sheet.classList.add('open'); favSheet.classList.remove('open'); hideKeyboard();};
    const closeCart=()=>sheet.classList.remove('open');
    const openFav =()=>{favSheet.classList.add('open'); sheet.classList.remove('open'); hideKeyboard();};
    const closeFav =()=>favSheet.classList.remove('open');

    openCartBtn.onclick=openCart;
    document.getElementById('closeCart').onclick=closeCart;
    document.getElementById('fabCart').onclick=openCart;

    openFavBtn.onclick=openFav;
    document.getElementById('closeFav').onclick=closeFav;

    // –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ
    document.getElementById('checkout').onclick=tryCheckout; tg.MainButton.onClick(tryCheckout);
    async function tryCheckout(){
      if(!cart.length) return;
      const order={items:cart.map(x=>({sku:x.sku,name:x.name,size:x.size,qty:x.qty,price:x.price})),total:calcTotal()};
      setLoading(true);
      try{const res=await callCreateOrder(order); tg.sendData(JSON.stringify({order_id:res.order_id,...order})); tg.close();}
      catch(e){setLoading(false); alert(e.message||'–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑');}
    }
    function setLoading(v){tg.MainButton.setParams({is_active:!v}); if(v) tg.HapticFeedback.impactOccurred('light');}

    // –ü–æ–∏—Å–∫
    function applyFilter(){
      const s=(q.value||'').trim().toLowerCase();
      const cards=[...grid.children];
      cards.forEach((card,i)=>{
        const p=products[i]; const hit=!s || p.name.toLowerCase().includes(s) || p.sku.toLowerCase().includes(s);
        card.style.display=hit?'':'none';
      });
    }
    q.addEventListener('input',applyFilter);
    q.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); hideKeyboard(); }});
    clearBtn.onclick=()=>{ q.value=''; applyFilter(); hideKeyboard(); };

    // Toast
    let toastTid;
    function showToast(msg){toast.textContent=msg; toast.classList.add('show'); clearTimeout(toastTid); toastTid=setTimeout(()=>toast.classList.remove('show'),1400); tg.HapticFeedback.notificationOccurred('success');}
  </script>
</body>
</html>
